"use strict";var e=require("node:path"),t=require("node:http"),o=require("node:fs"),n=require("node:url");function r(e){return new Promise((t=>setTimeout(t,e)))}function a(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=a(e,t)),o}function i(e){return new Promise(((o,r)=>{const a=e.data=JSON.stringify(e.data??""),i=function(e){const{hostname:t,port:o,pathname:r,search:a}=new n.URL(e.url),i=a||function(e){let t="";if("object"==typeof e)for(const o in e)t+=`${o}=${e[o]}`;else t=e;return t}(e.params),s="post"===e.method.toLowerCase()&&e.data?{...e.headers,"Content-Type":"application/json","Content-Length":Buffer.byteLength(e.data)}:e.headers;return{hostname:t,port:o,path:r,search:i,method:e.method,timeout:e.timeout,headers:s}}(e),s=t.request(i,(e=>{const t=[];e.on("data",(e=>t.push(e))),e.on("end",(()=>{o(Buffer.concat(t))}))}));s.on("error",(e=>{console.log("err: ",e.message),r(e)})),"post"===i.method.toLowerCase()&&s.write(a),s.end()}))}(async function(e){const{requestConifg:t,intervalTime:o}=e;let n;async function s(e){const t=await i(e);return JSON.parse(t.toString())}if(Array.isArray(t)){n=[];for(const e of t){const t=await s(e);if(n.push(t),o){const e=a(o.max,o.min);await r(e)}}}else n=s(t);return n})({requestConifg:{url:"http://localhost:9001/api/area/阳江市",method:"POST",data:{type:"plus",offset:0,size:20}}}).then((t=>{const{id:n,name:s,pictureUrls:c}=t.data.list[0],u=c.map((e=>({url:e,method:"GET"})));console.log(1111),async function(e){const{requestConifg:t,intervalTime:n,fileConfig:s}=e,c=Array.isArray(t),u=c?t:[t],f=u.length;let l=0;await console.log(`开始下载, 总数: ${f} `);for(const e of u){l++;const t=await i(e),u=(new Date).getTime()+s.suffix,m=s.storeDir+"/"+u;if(o.createWriteStream(m,"binary").write(t),console.log(`当前: ${l}`),n&&c&&l!==f){const e=a(n.max,n.min);await r(e)}}console.log("下载完成")}({requestConifg:u,intervalTime:{max:3e3,min:2e3},fileConfig:{storeDir:e.resolve(__dirname,"./upload"),suffix:".jpg"}}),console.log(2222)}));
