"use strict";var e=require("node:fs"),t=require("node:path"),o=require("jsdom"),n=require("node:http"),r=require("http"),s=require("https"),i=require("node:url");function a(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function u(e){const{protocol:t,hostname:o,port:n,pathname:u,search:c}=new i.URL(e.url),l={protocol:t,hostname:o,port:n,path:u,search:a(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return l.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,l),l.agent="http:"===t?new r.Agent:new s.Agent,l}function c(e,t){const{baseUrl:o,timeout:n,intervalTime:r}=e,{requestConifg:s,intervalTime:i}=t,a=m(s)?s:[s];for(const e of a){const{url:t,timeout:r}=e;h(o)||(e.url=o+t),h(r)&&!h(n)&&(e.timeout=n)}return h(i)&&!h(r)&&(t.intervalTime=r),t}function l(e){return new Promise((t=>setTimeout(t,e)))}function f(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=f(e,t)),o}function h(e){return void 0===e}function m(e){return Array.isArray(e)}function d(e){return new Promise(((t,o)=>{const r=h(e.data);e.data=r?e.data:JSON.stringify(e.data);const s=u(e),i=n.request(s,(e=>{const{statusCode:o,headers:n}=e,r=[];e.on("data",(e=>r.push(e))),e.on("end",(()=>{const e=Buffer.concat(r);t({statusCode:o,headers:n,data:e})}))}));i.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),i.on("error",(e=>{o(e)})),"POST"!==s.method||r||i.write(e.data),i.end()}))}async function g(e,t,o){const n=e.length;let r=0;console.log(`Begin execution, total: ${n} `);for(const s of e){r++;if(o(await d(s),r),h(t)||r===n)console.log(`The ${r} request is success, all requests completed!`);else{const e="number"==typeof t?t:f(t.max,t.min);console.log(`The ${r} request is success, sleep for ${e}ms`),await l(e)}}}new class{baseConfig;constructor(e={}){this.baseConfig=e}async fetch(e){const{requestConifg:t,intervalTime:o}=c(this.baseConfig,e),n=m(t)?t:[t],r=[];return await g(n,o,(e=>{const t=JSON.parse(e.data.toString());r.push({...e,data:t})})),r}fetchFile(o){return new Promise((n=>{const{requestConifg:r,intervalTime:s,fileConfig:i}=c(this.baseConfig,o);let a=0;const u=[];const l=m(r)?r:[r];try{g(l,s,(function(o,r){const{headers:s,data:c}=o,f=s["content-type"]??"",h=f.split("/").pop(),m=(new Date).getTime().toString(),d=t.resolve(i.storeDir,`${m}.${h}`);e.createWriteStream(d,"binary").write(c,(e=>{if(e)return console.log(`File save error requested for the ${r}: ${e.message}`);u.push({fileName:m,mimeType:f,size:c.length,filePath:d}),++a===l.length&&(console.log("All files downloaded successfully!"),n(u))}))}))}catch(e){u.push(e)}}))}async fetchHTML(e){const{requestConifg:t}=c(this.baseConfig,{requestConifg:{url:e}}),n=(await d(t)).data.toString();return new o.JSDOM(n)}}({timeout:1e4,intervalTime:{max:3e3,min:1e3}}).fetchHTML("https://docs.github.com/zh").then((e=>{console.log(e.window.document.querySelector("title")?.textContent)}));
