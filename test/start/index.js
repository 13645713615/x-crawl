"use strict";var e=require("node:path"),t=require("node:fs"),o=require("node:fs/promises"),n=require("jsdom"),r=require("puppeteer"),s=require("node:http"),a=require("node:https"),i=require("node:url"),c=require("https-proxy-agent"),u=require("chalk");function l(e,t,o){const n=e[t];e[t]=e[o],e[o]=n}function d(e){return function t(o,n){if(o>=n)return;const r=e[n];let s=o,a=n-1;for(;s<=a;){for(;e[s]<r;)s++;for(;e[a]>r;)a--;s<=a&&(l(e,s,a),s++,a--)}l(e,s,n),t(o,s-1),t(s+1,n)}(0,e.length-1),e}const h=console.log,m=u.hex("#a57fff"),f=u.green,p=u.red,g=u.yellow;function w(e){return void 0===e}function y(e){return"number"==typeof e}function q(e){return Array.isArray(e)}function C(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function x(e){const{protocol:t,hostname:o,port:n,pathname:r,search:u}=new i.URL(e.url),l="http:"===t,d={agent:e.proxy?c(e.proxy):l?new s.Agent:new a.Agent,protocol:t,hostname:o,port:n,path:r,search:C(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return d.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,d),d}function $(e){return new Promise(((t,o)=>{const n=w(e.data);e.data=n?e.data:JSON.stringify(e.data);const r=x(e);function i(e){const{statusCode:o,headers:n}=e,r=[];e.on("data",(e=>r.push(e))),e.on("end",(()=>{const e=Buffer.concat(r);t({statusCode:o,headers:n,data:e})}))}let c;c="http:"===r.protocol?s.request(r,i):a.request(r,i),c.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),c.on("error",(e=>{o(e)})),"POST"!==r.method||n||c.write(e.data),c.end()}))}async function v(e,t,o,n){if(e&&n>1){const e=t?o:function(e,t=0){let o=Math.floor(Math.random()*e);for(;o<t;)o=Math.floor(Math.random()*e);return o}(o.max,o.min);h(`Request ${m(n)} needs to sleep for ${m(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else h(`Request ${m(n)} does not need to sleep, send immediately`)}function T(e,t){const o=structuredClone(t),n=q(o.requestConfig)?o.requestConfig:[o.requestConfig],r=o.requestConfig=n.map((e=>"string"==typeof e?{url:e}:e));for(const t of r){const{url:o,timeout:n,proxy:r}=t;w(e.baseUrl)||(t.url=e.baseUrl+o),w(n)&&(t.timeout=e.timeout),w(r)&&(t.proxy=e.proxy)}return w(o.intervalTime)&&(o.intervalTime=e.intervalTime),o}async function A(e,t,o,n){"async"===e?await async function(e,t,o){const n=!w(t),r=y(t);h(`${f("Begin execution:")} mode: ${g("async")}, total: ${m(e.length)} `);let s=0,a=0,i=0;const c=[],u=[];for(const l of e){const e=++s;await v(n,r,t,e);const d=$(l).catch((t=>{i++;const o=`Request ${e} is an error: ${t.message}`;u.push({message:o,valueOf:()=>e})})).then((t=>{t&&(a++,o({id:e,...t}))}));c.push(d)}h(f("All requests have been sent!")),await Promise.all(c),d(u).forEach((e=>h(p(e.message)))),h(`requestsTotal: ${m(e.length)}, success: ${f(a)}, error: ${p(i)}`)}(t,o,n):await async function(e,t,o){const n=!w(t),r=y(t);h(`${f("Begin execution:")} mode: ${g("sync")}, total: ${m(e.length)}`);let s=0,a=0,i=0;for(const c of e){s++,await v(n,r,t,s);let e=!0,u=null;try{u={id:s,...await $(c)},h(f(`Request ${m(s)} is an success`)),a++}catch(t){e=!1,h(p(`Request ${s} is an error: ${t.message}`)),i++}e&&o&&o(u)}h(f("All requests are over!")),h(`requestsTotal: ${m(e.length)}, success: ${f(a)}, error: ${p(i)}`)}(t,o,n)}function B(e){let t=null,o=null,s=!1;return async function(a,i){s||(s=!0,o=r.launch().then((e=>{t=e}))),o&&(await Promise.all([o]),o=null);const c=await t.newPage();await c.setViewport({width:1280,height:1024});const{requestConfig:u}=T(e,{requestConfig:a}),l=u[0];l.proxy?await t.createIncognitoBrowserContext({proxyServer:l.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),l.headers&&await c.setExtraHTTPHeaders(Headers),l.cookies&&await c.setCookie(...function(e,t){const o=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");o.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),o.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),o.push(t)),o}(l.url,l.cookies));let d=null;try{d=await c.goto(l.url,{timeout:l.timeout})}catch(e){console.log(p(`Error: ${e.message}`))}let h="";try{h=await c.content()}catch{}const m={httpResponse:d,browser:t,page:c,jsdom:new n.JSDOM(h)};return i&&i(m),m}}function _(e){return async function(t,o){const{requestConfig:n,intervalTime:r}=T(e,t),s=[];return await A(e.mode,n,r,(function(e){const t=e.headers["content-type"]??"",n=e.data,r=t.includes("text")?n.toString():JSON.parse(n.toString()),a={...e,data:r};o&&o(a),s.push(a)})),d(s.map((e=>({...e,valueOf:()=>e.id}))))}}function F(n){return async function(r,s){const{requestConfig:a,intervalTime:i,fileConfig:c}=T(n,r),u=[],l=[],g=[];t.existsSync(c.storeDir)||t.mkdirSync(c.storeDir),await A(n.mode,a,i,(function(t){const{id:n,headers:r,data:a}=t,i=r["content-type"]??"",d=c.extension??i.split("/").pop(),h=(new Date).getTime().toString(),m=e.resolve(c.storeDir,`${h}.${d}`),f=o.writeFile(m,a).catch((e=>{const t=`File save error at id ${n}: ${e.message}`;return g.push({message:t,valueOf:()=>n}),!0})).then((e=>{if(e)return;const o={...t,data:{fileName:h,mimeType:i,size:a.length,filePath:m}};s&&s(o),u.push(o)}));l.push(f)})),await Promise.all(l),d(g).forEach((e=>h(p(e.message))));const w=q(a)?a.length:1,y=u.length,C=w-y;return h(`saveFileTotal: ${m(w)}, success: ${f(y)}, error: ${p(C)}`),d(u.map((e=>({...e,valueOf:()=>e.id}))))}}function S(e,t){const{d:o,h:n,m:r}=e,s=(w(o)?0:1e3*o*60*60*24)+(w(n)?0:1e3*n*60*60)+(w(r)?0:1e3*r*60);let a=0;c();const i=setInterval(c,s);function c(){console.log(f(`Start the ${g.bold(++a)} polling`)),t(a,u)}function u(){clearInterval(i),console.log(f("Stop the polling"))}}const P=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),t}(e);return function(e){return{crawlPage:B(e),crawlData:_(e),crawlFile:F(e),startPolling:S}}(t)}({timeout:1e4,intervalTime:{max:3e3,min:1e3}});P.crawlPage({url:"https://github.com/coder-hxl/x-crawl",cookies:"_octo=GH1.1.593772338.1660360321; _device_id=e070913e7fe8aee5885a51434c8823e4; user_session=UhxBLOh8wFmRREVhYMCLT2GmT901JyidV1WFLxg8ehedNIOK; __Host-user_session_same_site=UhxBLOh8wFmRREVhYMCLT2GmT901JyidV1WFLxg8ehedNIOK; logged_in=yes; dotcom_user=coder-hxl; fileTreeExpanded=true; color_mode=%7B%22color_mode%22%3A%22auto%22%2C%22light_theme%22%3A%7B%22name%22%3A%22light%22%2C%22color_mode%22%3A%22light%22%7D%2C%22dark_theme%22%3A%7B%22name%22%3A%22dark%22%2C%22color_mode%22%3A%22dark%22%7D%7D; preferred_color_mode=light; tz=Asia%2FShanghai; has_recent_activity=1; _gh_sess=mftIWAX18a66xC1bCy%2F7SH%2B0%2BR0EYHjuei%2FYnvIkj4gADNQN1gijPT8%2F0S6Gwn4rdkX79JPWy4uDvZCrmzD6skOpqUa7oCr1n0r%2B%2BAJBFG89Pb6gzAIdIYeCIYm1FbwDrbniCtoPFDPd39qCjma8tLHNPvG5ZXtc1vjCxB5eUNJM64K7mSSXanM793KkgLZpivAVoiPrVfsL16W%2BakCEcbq0nZtOy1eI797xn5LXY14XIZpcwPUeqsn43UPBe01UIikSTdCY7bXz7f3WgfoEthdgU9kr5%2BXyQD64TrOciqSr5F6n%2FHBx7vo5AZuAFXj9bnar4wjqybRtkVnmZAQOBU5Yaeri3Ko%2FA3J8bK%2B1HkRR5cNqI%2FN5Ow3NsIyw9K47bmEVEWT7IjG%2F--Lg5aeJdBHdUod%2FOD--Hew%2BEzpMSYud4i8%2Bu5u%2F3w%3D%3D"}).then((async t=>{const{page:o}=t;await o.screenshot({path:e.resolve(__dirname,"./upload/page.jpg")}),console.log("完成")}));
