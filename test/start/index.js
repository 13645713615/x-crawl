"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),n=require("puppeteer"),o=require("chalk"),s=require("node:http"),a=require("node:https"),i=require("node:url"),u=require("https-proxy-agent");const c=console.log,l=o.hex("#a57fff"),f=o.green,m=o.red,d=o.yellow;function h(e){return void 0===e}function g(e){return"number"==typeof e}function p(e){return"object"==typeof e&&e&&!Array.isArray(e)}function y(e){return Array.isArray(e)}async function w(e,t,r,n){if(e&&n>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);c(`Id: ${l(n)} - Crawl needs to sleep for ${l(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else c(`Id: ${l(n)} - Crawl does not need to sleep, send immediately`)}async function C(e,t,r,n){const o=!h(t),s=g(t),a=[];for(const i of e){const{id:e}=i;await w(o,s,t,e),i.retryCount++;const u=n(i,r).catch((e=>(i.errorQueue.push(e),!1))).then((e=>{!1!==e&&(i.isSuccess=!0,i.crawlSingleRes=e)}));a.push(u)}await Promise.all(a)}async function x(e,t,r,n){const o=!h(t),s=g(t);for(const a of e){const{id:e}=a;await w(o,s,t,e),a.retryCount++;try{a.crawlSingleRes=await n(a,r),a.isSuccess=!0}catch(e){a.errorQueue.push(e)}}}async function q(e,t,r,n,o,s){const a=r.map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry??0,retryCount:-1,errorQueue:[],requestConfig:e,crawlSingleRes:null})));c(`${f("Start crawling")} - name: ${d(e)}, mode: ${d(t)}, total: ${l(a.length)} `);const i="async"===t?C:x;let u=a;for(;u.length;)if(await i(u,n,o,s),u=u.filter((e=>e.maxRetry&&!e.isSuccess&&e.retryCount<e.maxRetry)),u.length){const e=u.map((e=>e.id));c(d(`Ids to retry: [ ${e.join(" - ")} ]`))}const h=[],g=[];return a.forEach((e=>{e.isSuccess?h.push(e.id):g.push(e.id)})),c("Crawl the final result:"),c(f(`  Success - total: ${h.length}, ids: [ ${h.join(" - ")} ]`)),c(m(`    Error - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),a}function S(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function R(e){const{protocol:t,hostname:r,port:n,pathname:o,search:c}=new i.URL(e.url),l="http:"===t,f={agent:e.proxy?u(e.proxy):l?new s.Agent:new a.Agent,protocol:t,hostname:r,port:n,path:o,search:S(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,f),f}function v(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}async function $(e){const{requestConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const n=h(r.data);r.data=n?r.data:JSON.stringify(r.data);const o=R(r);function i(t){const{statusCode:r,headers:n}=t,o=[];t.on("data",(e=>o.push(e))),t.on("end",(()=>{const t=Buffer.concat(o);e({statusCode:r,headers:n,data:t})}))}let u;u="http:"===o.protocol?s.request(o,i):a.request(o,i),u.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),u.on("error",(e=>{t(e)})),"POST"!==o.method||n||u.write(r.data),u.end()})));var r}function T(e){return y(e)?e.map((e=>p(e)?e:{url:e})):[p(e)?e:{url:e}]}function b(e,t){t.requestConfigs.forEach((r=>{const{url:n,timeout:o,proxy:s,maxRetry:a}=r;h(e.baseUrl)||(r.url=e.baseUrl+n),h(o)&&!h(e.timeout)&&(r.timeout=e.timeout),h(s)&&!h(e.proxy)&&(r.proxy=e.proxy),h(a)&&(h(t.maxRetry)?h(e.maxRetry)||(r.maxRetry=e.maxRetry):r.maxRetry=t.maxRetry)})),h(t.intervalTime)&&!h(e.intervalTime)&&(t.intervalTime=e.intervalTime)}function k(e){let t=null,r=null,o=!1,s=0;const a=new Map;async function i(e,r){const{id:n,requestConfig:o}=e,s=await t.newPage();await s.setViewport({width:1280,height:1024});let i=null;try{o.proxy?await t.createIncognitoBrowserContext({proxyServer:o.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),o.headers&&await s.setExtraHTTPHeaders(o.headers),o.cookies&&await s.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");r.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies)),i=await s.goto(o.url,{timeout:o.timeout})}catch(e){let t=a.get(r);throw t||(t=new Map,a.set(r,t)),t.get(n)||t.set(n,s),e}return{response:i,page:s}}return async function(u,c){const l=++s;o||(o=!0,r=n.launch().then((e=>{t=e}))),r&&(await r,r&&(r=null));const{requestConfigs:f,intervalTime:m}=function(e,t){const r={requestConfigs:[]};if(p(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,cookies:n,intervalTime:o,maxRetry:s}=t;r.cookies=n,r.intervalTime=o,r.maxRetry=s;const a=T(e);r.requestConfigs.push(...a)}else{const e=T(t);r.requestConfigs.push(...e)}return b(e,r),r.requestConfigs.forEach((e=>{const{cookies:t}=e;h(t)&&!h(r.cookies)&&(e.cookies=r.cookies)})),r}(e,u),d=(await q("page",e.mode,f,m,l,i)).map((e=>{const{id:r,isSuccess:n,maxRetry:o,retryCount:s,errorQueue:i,crawlSingleRes:u}=e;let f=null;if(n&&u)f={browser:t,...u};else{const e=a.get(l).get(r);f={browser:t,response:null,page:e}}const m={id:r,isSuccess:n,maxRetry:o,retryCount:s,errorQueue:i,data:f};return c&&c(m),m}));return a.delete(l),y(u)||p(u)&&Object.hasOwn(u,"requestConfigs")?d:d[0]}}function E(e){return async function(t,r){const{requestConfigs:n,intervalTime:o}=function(e,t){const r={requestConfigs:[]};if(p(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,intervalTime:n,maxRetry:o}=t;r.intervalTime=n,r.maxRetry=o;const s=T(e);r.requestConfigs.push(...s)}else{const e=T(t);r.requestConfigs.push(...e)}return b(e,r),r}(e,t),s=(await q("data",e.mode,n,o,void 0,$)).map((e=>{const{id:t,isSuccess:n,maxRetry:o,retryCount:s,errorQueue:a,crawlSingleRes:i}=e,u={id:t,isSuccess:n,maxRetry:o,retryCount:s,errorQueue:a,data:null};if(n&&i){const e=(i.headers["content-type"]??"").includes("text")?i.data.toString():JSON.parse(i.data.toString());u.data={...i,data:e}}return r&&r(u),u}));return y(t)||p(t)&&Object.hasOwn(t,"requestConfigs")?s:s[0]}}function O(n){return async function(o,s){const{requestConfigs:a,intervalTime:i,fileConfig:u}=function(e,t){const r={requestConfigs:[],fileConfig:t.fileConfig};return r.requestConfigs=T(t.requestConfig),b(e,r),r}(n,o);e.existsSync(u.storeDir)||e.mkdirSync(u.storeDir);const l=await q("file",n.mode,a,i,void 0,$),d=[],h=[],g=l.map((e=>{const{id:n,isSuccess:o,maxRetry:a,retryCount:i,errorQueue:c,crawlSingleRes:l}=e,f={id:n,isSuccess:o,maxRetry:a,retryCount:i,errorQueue:c,data:null};if(o&&l){const e=l.headers["content-type"]??"",o=u.extension??e.split("/").pop(),a=(new Date).getTime().toString(),i=r.resolve(u.storeDir,`${a}.${o}`),c=t.writeFile(i,l.data).catch((e=>{const t=`File save error at id ${n}: ${e.message}`;return h.push({message:t,valueOf:()=>n}),!0})).then((t=>{const r=l.data.length,n={isSuccess:!t,fileName:a,mimeType:e,size:r,filePath:i};f.data={...l,data:n},s&&s(f)}));d.push(c)}else s&&s(f);return f}));var p;await Promise.all(d),(p=h,function e(t,r){if(t>=r)return;const n=p[r];let o=t,s=r-1;for(;o<=s;){for(;p[o]<n;)o++;for(;p[s]>n;)s--;o<=s&&(v(p,o,s),o++,s--)}v(p,o,r),e(t,o-1),e(o+1,r)}(0,p.length-1),p).forEach((e=>c(m(e.message))));const w=[],C=[];return g.forEach((e=>{e.data?.data.isSuccess?w.push(e.id):C.push(e.id)})),c("Save file final result:"),c(f(`  Success - total: ${w.length}, ids: [ ${w.join(" - ")} ]`)),c(m(`    Error - total: ${C.length}, ids: [ ${C.join(" - ")} ]`)),y(o.requestConfig)?g:g[0]}}function j(e,t){const{d:r,h:n,m:o}=e,s=(h(r)?0:1e3*r*60*60*24)+(h(n)?0:1e3*n*60*60)+(h(o)?0:1e3*o*60);let a=0;u();const i=setInterval(u,s);function u(){console.log(f(`Start the ${d.bold(++a)} polling`)),t(a,c)}function c(){clearInterval(i),console.log(f("Stop the polling"))}}const P=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),t}(e);return function(e){return{crawlPage:k(e),crawlData:E(e),crawlFile:O(e),startPolling:j}}(t)}({timeout:1e4,intervalTime:{max:3e3,min:1e3}});P.crawlPage({requestConfigs:["https://www.google.com/search?q=1","https://www.google.com/search?q=2","https://www.google.com/search?q=2"],maxRetry:2}).then((e=>{let t=null;e.forEach((e=>{t||(t=e.data.browser),console.log(e.isSuccess,e.retryCount),console.log(e.errorQueue.map((e=>e.message)))})),t.close()}));
