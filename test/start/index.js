"use strict";var e=require("node:fs"),t=require("node:path"),o=require("jsdom"),n=require("node:http"),r=require("https"),s=require("node:url");function a(e){return new Promise((t=>setTimeout(t,e)))}function i(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=i(e,t)),o}function u(e){return void 0===e}function c(e){return Array.isArray(e)}function l(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function f(e){const{protocol:t,hostname:o,port:a,pathname:i,search:u}=new s.URL(e.url),c={protocol:t,hostname:o,port:a,path:i,search:l(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return c.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,c),c.agent="http:"===t?new n.Agent:new r.Agent,c}function h(e){return new Promise(((t,o)=>{const r=u(e.data);e.data=r?e.data:JSON.stringify(e.data);const s=f(e),a=n.request(s,(e=>{const{statusCode:n,headers:r}=e,s=[];e.on("data",(e=>s.push(e))),e.on("error",(()=>{const e=Buffer.concat(s);o({statusCode:n,headers:r,data:e})})),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:n,headers:r,data:e})}))}));a.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),a.on("error",(e=>{o(e)})),"POST"!==s.method||r||a.write(e.data),a.end()}))}async function m(e,t,o){const n=e.length;let r=0;console.log(`Begin execution, total: ${n} `);for(const s of e){r++;if(o(await h(s),r),u(t)||r===n)console.log(`The ${r} request is success, all requests completed!`);else{const e="number"==typeof t?t:i(t.max,t.min);console.log(`The ${r} request is success, sleep for ${e}ms`),await a(e)}}}function d(e,t){const{baseUrl:o,timeout:n,intervalTime:r}=e,{requestConifg:s,intervalTime:a}=t,i=c(s)?s:[s];for(const e of i){const{url:t,timeout:r}=e;u(o)||(e.url=o+t),u(r)&&!u(n)&&(e.timeout=n)}return u(a)&&!u(r)&&(t.intervalTime=r),t}new class{baseConfig;constructor(e={}){this.baseConfig=e}async fetchData(e){const{requestConifg:t,intervalTime:o}=d(this.baseConfig,e),n=c(t)?t:[t],r=[];return await m(n,o,(e=>{const t=JSON.parse(JSON.stringify(e.data.toString()));r.push({...e,data:t})})),r}fetchFile(o){return new Promise((n=>{const{requestConifg:r,intervalTime:s,fileConfig:a}=d(this.baseConfig,o),i=c(r)?r:[r];let u=0;const l=[];m(i,s,(function(o,r){const{headers:s,data:c}=o,f=s["content-type"]??"",h=f.split("/").pop(),m=(new Date).getTime().toString(),d=t.resolve(a.storeDir,`${m}.${h}`);e.createWriteStream(d,"binary").write(c,(e=>{if(e)return console.log(`File save error requested for the ${r}: ${e.message}`);l.push({fileName:m,mimeType:f,size:c.length,filePath:d}),++u===i.length&&(console.log("All files downloaded successfully!"),n(l))}))}))}))}async fetchHTML(e){const{requestConifg:t}=d(this.baseConfig,{requestConifg:{url:e}}),n=(await h(t)).data.toString();return new o.JSDOM(n)}}({baseUrl:"http://localhost:9001/api",timeout:1e4,intervalTime:{max:3e3,min:1e3}}).fetchData({requestConifg:{url:"/home/goodprice",method:"POST"}}).then((e=>{console.log(e)}));
