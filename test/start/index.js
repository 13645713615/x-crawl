"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),a=require("chalk"),n=require("node:http"),i=require("node:https"),s=require("node:url"),l=require("https-proxy-agent"),c=require("sharp"),u=require("path");function d(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}const p=console.log,m=a.hex("#a57fff"),h=a.green,g=a.red,f=a.yellow;function w(e){return void 0===e}function y(e){return"number"==typeof e}function v(e){return"object"==typeof e&&e&&!Array.isArray(e)}function T(e){return Array.isArray(e)}async function C(e,t,r,o){if(e&&o>1){const e=t?r:d(r.max,r.min);p(`Id: ${m(o)} - Crawl needs to sleep for ${m(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else p(`Id: ${m(o)} - Crawl does not need to sleep, send immediately`)}async function x(e,t,r,o){const{intervalTime:a}=t,n=!w(a),i=y(a),s=[];for(const l of e){const{id:e}=l;await C(n,i,a,e);const c=r(l,t).catch((e=>(l.crawlErrorQueue.push(e),!1))).then((e=>{"boolean"!=typeof e?(l.isSuccess=!0,l.detailTargetRes=e,o(l,t)):l.retryCount===l.maxRetry&&o(l,t)}));s.push(c)}await Promise.all(s)}async function S(e,t,r,o){const{intervalTime:a}=t,n=!w(a),i=y(a);for(const s of e){const{id:e}=s;await C(n,i,a,e);try{s.detailTargetRes=await r(s,t),s.isSuccess=!0}catch(e){s.crawlErrorQueue.push(e)}(s.isSuccess||s.retryCount===s.maxRetry)&&o(s,t)}}function b(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function $(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=$(e.slice(0,t)),o=$(e.slice(t)),a=[];let n=0,i=0;for(;n<r.length&&i<o.length;)r[n]>=o[i]?(a.push(r[n]),n++):(a.push(o[i]),i++);return n<r.length&&a.push(...r.slice(n)),i<o.length&&a.push(...o.splice(i)),a}async function R(e,t,r,o,a,n){const i=(!r.every((e=>e.priority===r[0].priority))?$(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,retryCount:0,crawlErrorQueue:[],data:null,detailTarget:e,detailTargetRes:null})));p(`${h("Start crawling")} - name: ${f(e)}, mode: ${f(t)}, total: ${m(i.length)} `);const s="async"===t?x:S;let l=0,c=i;for(;c.length;)if(await s(c,o,a,n),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.retryCount<e.maxRetry)),c.length){const e=c.map((e=>(e.retryCount++,e.id)));p(f(`Retry: ${++l} - Ids to retry: [ ${e.join(" - ")} ]`))}const u=[],d=[];return i.forEach((e=>{e.isSuccess?u.push(e.id):d.push(e.id)})),p("Crawl the final result:"),p(h(`  Success - total: ${u.length}, ids: [ ${u.join(" - ")} ]`)),p(g(`    Error - total: ${d.length}, ids: [ ${d.join(" - ")} ]`)),i}function I(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function O(e){const{protocol:t,hostname:r,port:o,pathname:a,search:c}=new s.URL(e.url),u="http:"===t,d={agent:e.proxy?l(e.proxy):u?new n.Agent:new i.Agent,protocol:t,hostname:r,port:o,path:a,search:I(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return d.headers=function(e,t){const r={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,d),d}const E={platforms:["Android","Chrome OS","Chromium OS","iOS","Linux","macOS","Windows"],mobiles:["?0","?1"]};function F(e){return T(e)?e.map((e=>v(e)?e:{url:e})):[v(e)?e:{url:e}]}function j(e,t){const{userAgent:r,ua:o,platform:a,platformVersion:n,mobile:i,acceptLanguage:s}=t;let l=e.headers;l||(e.headers=l={}),r&&(l["user-agent"]=r),o&&(l["sec-ch-ua"]=o),a&&(l["sec-ch-platform"]=a),n&&(l["sec-ch-ua-platform-version"]=n),i&&(l["sec-ch-mobile"]=i),s&&(l["accept-language"]=s)}function P(e,t){const{maxWidth:r,minWidth:o,maxHeight:a,minHidth:n}=t,i=r===o?r:d(r,o),s=a===n?a:d(a,n),l=e.viewport;l?(l.width=i,l.height=s):e.viewport={width:i,height:s}}function A(e,t,r){r.detailTargets.forEach((r=>{const{url:o,timeout:a,proxy:n,maxRetry:i,priority:s,headers:l,fingerprint:c}=r;if(w(e.baseUrl)||(r.url=e.baseUrl+o),w(a)&&(w(t.timeout)?r.timeout=e.timeout:r.timeout=t.timeout),w(n)&&(w(t.proxy)?w(e.proxy)||(r.proxy=e.proxy):r.proxy=t.proxy),w(i)&&(w(t.maxRetry)?r.maxRetry=e.maxRetry:r.maxRetry=t.maxRetry),w(s)&&(r.priority=0),w(l)&&t.headers&&(r.headers={...t.headers}),c)j(r,c);else if(w(c)&&t.fingerprint){const{userAgents:e,uas:o,platforms:a,platformVersions:n,mobiles:i,acceptLanguages:s}=t.fingerprint;j(r,{userAgent:e?e[d(e.length)]:void 0,ua:o?o[d(o.length)]:void 0,platform:a?a[d(a.length)]:void 0,platformVersion:n?n[d(n.length)]:void 0,mobile:i?i[d(i.length)]:void 0,acceptLanguage:s?s[d(s.length)]:void 0})}else if(e.enableRandomFingerprint){const{platforms:e,mobiles:t}=E;j(r,{userAgent:`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.${d(10)}.${d(1e4)}.${d(1e3)} Safari/537.36`,platform:e[d(e.length)],mobile:t[d(t.length)]})}})),r.intervalTime=t.intervalTime,w(t.intervalTime)&&!w(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}async function k(e,t){const{id:r,detailTarget:o}=e,{errorPageMap:a,browser:n}=t,i=await n.newPage();o.viewport&&await i.setViewport(o.viewport);let s=null;try{if(o.proxy?await n.createIncognitoBrowserContext({proxyServer:o.proxy}):await n.createIncognitoBrowserContext({proxyServer:void 0}),o.cookies){const e=function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies);await i.setCookie(...e)}else{const e=await i.cookies(o.url);await i.deleteCookie(...e)}o.headers&&await i.setExtraHTTPHeaders(o.headers),s=await i.goto(o.url,{timeout:o.timeout})}catch(e){throw a.get(r)||a.set(r,i),e}return{response:s,page:i}}async function q(e){const{detailTarget:t}=e;return await(r=t,new Promise(((e,t)=>{const o=w(r.data);r.data=o?r.data:JSON.stringify(r.data);const a=O(r);function s(t){const{statusCode:r,headers:o}=t,a=[];t.on("data",(e=>a.push(e))),t.on("end",(()=>{const t=Buffer.concat(a);e({statusCode:r,headers:o,data:t})}))}let l;l="http:"===a.protocol?n.request(a,s):i.request(a,s),l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),"POST"!==a.method||o||l.write(r.data),l.end()})));var r}function B(e,t){const{id:r,isSuccess:o,detailTargetRes:a}=e,{errorPageMap:n,browser:i,onCrawlItemComplete:s}=t;let l=null;if(o&&a)l={browser:i,...a};else{l={browser:i,response:null,page:n.get(r)}}e.data=l;const c=e;delete c.detailTarget,delete c.detailTargetRes,s&&s(c)}function M(o,a){const{id:n,isSuccess:i,detailTarget:s,detailTargetRes:l}=o,{saveFileErrorArr:c,saveFilePendingQueue:u,onCrawlItemComplete:d,onBeforeSaveFile:p}=a,m=o;if(delete m.detailTarget,delete m.detailTargetRes,i&&l){const a=l.headers["content-type"]??"",i=s.fileName??`${n}-${(new Date).getTime()}`,g=s.extension??`.${a.split("/").pop()}`;s.storeDir&&!e.existsSync(s.storeDir)&&(h=s.storeDir,r.resolve(h).split(r.sep).reduce(((t,o,a)=>{const n=0!==a?r.join(t,o):o;return e.existsSync(n)||e.mkdirSync(n),n}),""));const f=s.storeDir??__dirname,w=r.resolve(f,i+g),y=l.data;let v=Promise.resolve(y);p&&(v=p({id:n,fileName:i,filePath:w,data:y}));const T=v.then((async e=>{let r=!0;try{await t.writeFile(w,e)}catch(e){r=!1;const t=`File save error at id ${n}: ${e.message}`,o=()=>n;c.push({message:t,valueOf:o})}const s=e.length;o.data={...l,data:{isSuccess:r,fileName:i,fileExtension:g,mimeType:a,size:s,filePath:w}},d&&d(m)}));u.push(T)}else d&&d(m);var h}function D(e){let t=null,r=null,a=!1;return async function(n,i){a||(a=!0,r=o.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{detailTargets:s,intervalTime:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(v(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...F(e))}else{const e=F(t);r.detailTargets.push(...e)}return A(e,o,r),r.detailTargets.forEach((e=>{const{cookies:t,viewport:r,fingerprint:a}=e;w(t)&&o.cookies&&(e.cookies=o.cookies),w(r)&&o.viewport&&(e.viewport=o.viewport),a?P(e,a):w(a)&&o.fingerprint&&P(e,o.fingerprint)})),r}(e,n),u={errorPageMap:new Map,browser:t,intervalTime:l,onCrawlItemComplete:c},d=await R("page",e.mode,s,u,k,B),p=T(n)||v(n)&&Object.hasOwn(n,"targets")?d:d[0];return i&&i(p),p}}function L(e){return async function(t,r){const{detailTargets:o,intervalTime:a,onCrawlItemComplete:n}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(v(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...F(e))}else{const e=F(t);r.detailTargets.push(...e)}return A(e,o,r),r}(e,t),i={intervalTime:a,onCrawlItemComplete:n},s=await R("data",e.mode,o,i,q,(function(e,t){const{isSuccess:r,detailTargetRes:o}=e,{onCrawlItemComplete:a}=t;if(r&&o){const t=(o.headers["content-type"]??"").includes("text")?o.data.toString():JSON.parse(o.data.toString());e.data={...o,data:t}}const n=e;delete n.detailTarget,delete n.detailTargetRes,a&&a(n)})),l=T(t)||v(t)&&Object.hasOwn(t,"targets")?s:s[0];return r&&r(l),l}}function W(e){return async function(t,r){const{detailTargets:o,intervalTime:a,onBeforeSaveFile:n,onCrawlItemComplete:i}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onBeforeSaveFile:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(v(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...F(e))}else r.detailTargets.push(...T(t)?t:[t]);A(e,o,r);const a=!w(o?.storeDir),n=!w(o?.extension);return r.detailTargets.forEach((e=>{w(e.storeDir)&&a&&(e.storeDir=o.storeDir),w(e.extension)&&n&&(e.extension=o.extension)})),r.onBeforeSaveFile=o.onBeforeSaveFile,r}(e,t);p(o);const s={saveFileErrorArr:[],saveFilePendingQueue:[],intervalTime:a,onCrawlItemComplete:i,onBeforeSaveFile:n},l=await R("file",e.mode,o,s,q,M),{saveFilePendingQueue:c,saveFileErrorArr:u}=s;var d;await Promise.all(c),(d=u,function e(t,r){if(t>=r)return;const o=d[r];let a=t,n=r-1;for(;a<=n;){for(;d[a]<o;)a++;for(;d[n]>o;)n--;a<=n&&(b(d,a,n),a++,n--)}b(d,a,r),e(t,a-1),e(a+1,r)}(0,d.length-1),d).forEach((e=>p(g(e.message))));const m=[],f=[];l.forEach((e=>{e.data?.data.isSuccess?m.push(e.id):f.push(e.id)})),p("Save file final result:"),p(h(`  Success - total: ${m.length}, ids: [ ${m.join(" - ")} ]`)),p(g(`    Error - total: ${f.length}, ids: [ ${f.join(" - ")} ]`));const y=T(t)||v(t)&&Object.hasOwn(t,"targets")?l:l[0];return r&&r(y),y}}function N(e,t){const{d:r,h:o,m:a}=e,n=(w(r)?0:1e3*r*60*60*24)+(w(o)?0:1e3*o*60*60)+(w(a)?0:1e3*a*60);let i=0;l();const s=setInterval(l,n);function l(){console.log(h(`Start the ${f.bold(++i)} polling`)),t(i,c)}function c(){clearInterval(s),console.log(h("Stop the polling"))}}const H=function(e){const t=function(e){const t=e||{};return w(t.mode)&&(t.mode="async"),w(t.enableRandomFingerprint)&&(t.enableRandomFingerprint=!0),w(e?.timeout)&&(t.timeout=1e4),w(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:D(e),crawlData:L(e),crawlFile:W(e),startPolling:N}}(t)}({enableRandomFingerprint:!1,baseUrl:"https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area",intervalTime:{max:5e3,min:3e3}});H.crawlFile({targets:["/4401.jpg","/4403.jpg","/4404.jpg","/4406.jpg","/4407.jpg"],proxy:"http://localhost:14892",headers:{test:"test"},storeDir:u.resolve(__dirname,"./upload"),onBeforeSaveFile:e=>c(e.data).resize(200).toBuffer(),onCrawlItemComplete(e){}}).then((async e=>{e.forEach((e=>{console.log(e.data?.data.isSuccess)}))}));
