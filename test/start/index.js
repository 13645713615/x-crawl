"use strict";var e=require("node:path"),t=require("node:fs"),o=require("node:http"),n=require("node:url");function r(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function i(e){const{hostname:t,port:o,pathname:i,search:s}=new n.URL(e.url),a={hostname:t,port:o,path:i,search:r(s,e.params),method:e.method.toLocaleUpperCase(),headers:{},timeout:e.timeout};return a.headers=function(e,t){let o;return o="POST"===t.method&&e.data?{...e.headers,"Content-Type":"application/json","Content-Length":Buffer.byteLength(e.data)}:e.headers,o}(e,a),a}function s(e,t){const{baseUrl:o,timeout:n,intervalTime:r}=e,{requestConifg:i,intervalTime:s}=t,a=l(i)?i:[i];for(const e of a){const{url:t,timeout:r}=e;e.url=o+t,u(r)&&!u(n)&&(e.timeout=n)}return u(s)&&!u(r)&&(t.intervalTime=r),t}function a(e){return new Promise((t=>setTimeout(t,e)))}function c(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=c(e,t)),o}function u(e){return void 0===e}function l(e){return Array.isArray(e)}function f(e){return new Promise(((t,n)=>{const r=e.data=e.data?JSON.stringify(e.data??""):e.data,s=i(e),a=o.request(s,(e=>{const{headers:o}=e,n=[];e.on("data",(e=>n.push(e))),e.on("end",(()=>{const e=Buffer.concat(n);t({headers:o,data:e})}))}));a.on("timeout",(()=>{console.log("Timeout Error"),n(new Error("Timeout"))})),a.on("error",(e=>{console.log("Error: ",e.message),n(e)})),"POST"===s.method&&a.write(r),a.end()}))}async function m(e,t,o){const n=e.length;let r=0;console.log(`Begin execution, total: ${n} `);for(const i of e){r++;if(o(await f(i),r),u(t)||r===n)console.log(`The ${r} request is success, all requests completed!`);else{const e="number"==typeof t?t:c(t.max,t.min);console.log(`The ${r} request is success, sleep for ${e}ms`),await a(e)}}}class d{baseConfig;constructor(e={}){this.baseConfig=e}async fetch(e){const{requestConifg:t,intervalTime:o}=s(this.baseConfig,e),n=l(t),r=n?t:[t],i=[];await m(r,o,(function(e){i.push(JSON.parse(e.data.toString()))}));return n?i:i[0]}async fetchFile(e){const{requestConifg:o,intervalTime:n,fileConfig:r}=s(this.baseConfig,e);let i=0;const a=l(o)?o:[o];await m(a,n,(function(e,o){const{headers:n,data:s}=e,c=`${(new Date).getTime()}.${n["content-type"]?.split("/").pop()}`,u=`${r.storeDir}/${c}`;t.createWriteStream(u,"binary").write(s,(e=>{if(e)return console.log(`File save error requested for the ${o}: ${e.message}`);++i===a.length&&console.log("All files downloaded successfully!")}))}))}}new d({timeout:1e4,intervalTime:{max:3e3,min:1e3}});const h=new d({timeout:1e4,intervalTime:{max:3e3,min:1e3}});h.fetch({requestConifg:{url:"https://api.bilibili.com/x/web-interface/wbi/index/top/feed/rcmd",method:"GET",params:{y_num:5,fresh_type:3,feed_version:"V8",fresh_idx_1h:1,fetch_row:1,fresh_idx:1,brush:0,homepage_ver:1,ps:10,outside_trigger:"",w_rid:"2e4be8e9830ecd780c5b0ff2bef805c9",wts:1674556002},headers:{}}}).then((t=>{const o=t.data.item.map((e=>({url:e.pic,method:"GET"})));h.fetchFile({requestConifg:o,intervalTime:{max:3e3,min:2e3},fileConfig:{storeDir:e.resolve(__dirname,"./upload")}})}));
