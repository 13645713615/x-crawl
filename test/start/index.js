"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),n=require("puppeteer"),o=require("chalk"),a=require("node:http"),s=require("node:https"),i=require("node:url"),u=require("https-proxy-agent");const c=console.log,l=o.hex("#a57fff"),m=o.green;o.red;const f=o.yellow;function d(e){return void 0===e}function p(e){return"number"==typeof e}function y(e){return"object"==typeof e&&e&&!Array.isArray(e)}function h(e){return Array.isArray(e)}async function g(e,t,r,n){if(e&&n>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);c(`Id: ${l(n)} - Crawl needs to sleep for ${l(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else c(`Crawl ${l(n)} does not need to sleep, send immediately`)}async function w(e,t,r,n){const o=!d(t),a=p(t),s=[];for(const i of e){const{id:e}=i;await g(o,a,t,e),i.retryCount++;const u=n(i,r).catch((e=>(i.errorQueue.push(e),!1))).then((e=>{!1!==e&&(i.isSuccess=!0,i.crawlSingleRes=e)}));s.push(u)}await Promise.all(s)}async function x(e,t,r,n){const o=!d(t),a=p(t);for(const s of e){const{id:e}=s;await g(o,a,t,e),s.retryCount++;try{s.crawlSingleRes=await n(s,r),s.isSuccess=!0}catch(e){s.errorQueue.push(e)}}}async function C(e,t,r,n,o){const a=t.map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry??0,retryCount:-1,errorQueue:[],requestConfig:e,crawlSingleRes:null}))),s="async"===e?w:x;let i=a;for(;i.length;)await s(i,r,n,o),i=i.filter((e=>!e.isSuccess&&e.retryCount<=e.maxRetry));return a}function S(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function R(e){const{protocol:t,hostname:r,port:n,pathname:o,search:c}=new i.URL(e.url),l="http:"===t,m={agent:e.proxy?u(e.proxy):l?new a.Agent:new s.Agent,protocol:t,hostname:r,port:n,path:o,search:S(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return m.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,m),m}function q(e){return h(e)?e.map((e=>y(e)?e:{url:e})):[y(e)?e:{url:e}]}function T(e,t){const r=structuredClone(t),n=h(r.requestConfig)?r.requestConfig:[r.requestConfig];return r.requestConfig=n.map((t=>{const n="string"==typeof t?{url:t}:t;const{url:o,timeout:a,proxy:s,maxRetry:i}=n;return d(e.baseUrl)||(n.url=e.baseUrl+o),d(a)&&(n.timeout=e.timeout),d(s)&&(n.proxy=e.proxy),d(i)&&(d(r.maxRetry)?n.maxRetry=e.maxRetry:n.maxRetry=r.maxRetry),n})),d(r.intervalTime)&&(r.intervalTime=e.intervalTime),r}async function v(e){const{requestConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const n=d(r.data);r.data=n?r.data:JSON.stringify(r.data);const o=R(r);function i(t){const{statusCode:r,headers:n}=t,o=[];t.on("data",(e=>o.push(e))),t.on("end",(()=>{const t=Buffer.concat(o);e({statusCode:r,headers:n,data:t})}))}let u;u="http:"===o.protocol?a.request(o,i):s.request(o,i),u.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),u.on("error",(e=>{t(e)})),"POST"!==o.method||n||u.write(r.data),u.end()})));var r}function b(e){let t=null,r=null,o=!1,a=0;const s=new Map;async function i(e,r){const{id:n,requestConfig:o}=e,a=await t.newPage();await a.setViewport({width:1280,height:1024});let i=null;try{o.proxy?await t.createIncognitoBrowserContext({proxyServer:o.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),o.headers&&await a.setExtraHTTPHeaders(o.headers),o.cookies&&await a.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");r.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies)),i=await a.goto(o.url,{timeout:o.timeout})}catch(e){let t=s.get(r);throw t||(t=new Map,s.set(r,t)),t.get(n)||t.set(n,a),e}return{response:i,page:a}}return async function(u,c){const l=++a;o||(o=!0,r=n.launch().then((e=>{t=e}))),r&&(await r,r&&(r=null));const{requestConfig:m,intervalTime:f}=function(e,t){const r={requestConfig:[]},n=[];if(y(t)&&Object.hasOwn(t,"requestConfig")){const{requestConfig:e,cookies:o,intervalTime:a,maxRetry:s}=t;r.cookies=o,r.intervalTime=a,r.maxRetry=s;const i=q(e);n.push(...i)}else{const e=q(t);n.push(...e)}return r.requestConfig=n.map((t=>{const{url:n,timeout:o,proxy:a,maxRetry:s,cookies:i}=t;return d(e.baseUrl)||(t.url=e.baseUrl+n),d(o)&&!d(e.timeout)&&(t.timeout=e.timeout),d(a)&&!d(e.proxy)&&(t.proxy=e.proxy),d(s)&&(d(r.maxRetry)?t.maxRetry=e.maxRetry:t.maxRetry=r.maxRetry),d(i)&&!d(r.cookies)&&(t.cookies=r.cookies),t})),d(r.intervalTime)&&(r.intervalTime=e.intervalTime),r}(e,u),p=(await C(e.mode,m,f,l,i)).map((e=>{const{id:r,isSuccess:n,maxRetry:o,retryCount:a,errorQueue:i,crawlSingleRes:u}=e;let m=null;if(n&&u)m={browser:t,...u};else{const e=s.get(l).get(r);m={browser:t,response:null,page:e}}const f={id:r,isSuccess:n,maxRetry:o,retryCount:a,errorQueue:i,data:m};return c&&c(f),f}));return s.delete(l),h(u)||y(u)&&Object.hasOwn(u,"requestConfig")?p:p[0]}}function k(e){return async function(t,r){const{requestConfig:n,intervalTime:o}=T(e,t);return(await C(e.mode,n,o,void 0,v)).map((e=>{const{id:t,isSuccess:n,maxRetry:o,retryCount:a,errorQueue:s,crawlSingleRes:i}=e,u={id:t,isSuccess:n,maxRetry:o,retryCount:a,errorQueue:s,data:null};if(n&&i){const e=(i.headers["content-type"]??"").includes("text")?i.data.toString():JSON.parse(i.data.toString());console.log(e),u.data={...i,data:e}}return r&&r(u),u}))}}function P(n){return async function(o,a){const{requestConfig:s,intervalTime:i,fileConfig:u}=T(n,o);e.existsSync(u.storeDir)||e.mkdirSync(u.storeDir);const c=await C(n.mode,s,i,void 0,v),l=[],m=c.map((e=>{const{id:n,isSuccess:o,maxRetry:s,retryCount:i,errorQueue:c,crawlSingleRes:m}=e,f={id:n,isSuccess:o,maxRetry:s,retryCount:i,errorQueue:c,data:null};if(o&&m){const e=m.headers["content-type"]??"",n=u.extension??e.split("/").pop(),o=(new Date).getTime().toString(),s=r.resolve(u.storeDir,`${o}.${n}`),i=t.writeFile(s,m.data).catch((e=>(e.message,!0))).then((t=>{const r=m.data.length,n={isSuccess:!t,fileName:o,mimeType:e,size:r,filePath:s};f.data={...m,data:n},a&&a(f)}));l.push(i)}else a&&a(f);return f}));return await Promise.all(l),m}}function A(e,t){const{d:r,h:n,m:o}=e,a=(d(r)?0:1e3*r*60*60*24)+(d(n)?0:1e3*n*60*60)+(d(o)?0:1e3*o*60);let s=0;u();const i=setInterval(u,a);function u(){console.log(m(`Start the ${f.bold(++s)} polling`)),t(s,c)}function c(){clearInterval(i),console.log(m("Stop the polling"))}}const $=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),t}(e);return function(e){return{crawlPage:b(e),crawlData:k(e),crawlFile:P(e),startPolling:A}}(t)}({timeout:1e4,intervalTime:{max:3e3,min:1e3}});$.crawlData({requestConfig:{url:"http://localhost:9001/api/area/阳江市",method:"POST",data:{type:"goodPrice",offset:0,size:20}}}).then((e=>200===e[0].data?.statusCode));
