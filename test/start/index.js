"use strict";var e=require("node:path"),t=require("node:fs"),o=require("jsdom"),n=require("node:http"),r=require("https"),s=require("node:url");function i(e){return new Promise((t=>setTimeout(t,e)))}function a(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=a(e,t)),o}function c(e){return void 0===e}function u(e){return Array.isArray(e)}function l(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function d(e){const{protocol:t,hostname:o,port:i,pathname:a,search:c}=new s.URL(e.url),u={protocol:t,hostname:o,port:i,path:a,search:l(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,u),u.agent="http:"===t?new n.Agent:new r.Agent,u}function f(e){return new Promise(((t,o)=>{const r=c(e.data);e.data=r?e.data:JSON.stringify(e.data);const s=d(e),i=n.request(s,(e=>{const{statusCode:o,headers:n}=e,r=[];e.on("data",(e=>r.push(e))),e.on("end",(()=>{const e=Buffer.concat(r);t({statusCode:o,headers:n,data:e})}))}));i.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),i.on("error",(e=>{o(e)})),"POST"!==s.method||r||i.write(e.data),i.end()}))}async function h(e,t,o){const n=e.length;let r=0;const s=!c(t),u="number"==typeof t;console.log(`Begin execution, total: ${n} `);for(const c of e){r++;let e="success",l=null,d={};try{d=await f(c)}catch(t){l=t,e=`error: ${t.message}`}if(o(l,{id:r,...d}),s&&r!==n){const o=u?t:a(t.max,t.min);console.log(`The ${r} request is ${e}, sleep for ${o}ms`),await i(o)}else console.log(`The ${r} request is ${e}`),console.log("All requests completed!")}}function m(e,t){const{baseUrl:o,timeout:n,intervalTime:r}=e,{requestConifg:s,intervalTime:i}=t,a=u(s)?s:[s];for(const e of a){const{url:t,timeout:r}=e;c(o)||(e.url=o+t),c(r)&&!c(n)&&(e.timeout=n)}return c(i)&&!c(r)&&(t.intervalTime=r),t}const g=new class{baseConfig;constructor(e={}){this.baseConfig=e}async fetchData(e){const{requestConifg:t,intervalTime:o}=m(this.baseConfig,e),n=u(t)?t:[t],r=[];return await h(n,o,((e,t)=>{if(e)return;const o=t.headers["content-type"]??"",n=t.data,s=o.includes("text")?n.toString():JSON.parse(n.toString());r.push({...t,data:s})})),r}fetchFile(o){return new Promise((n=>{const{requestConifg:r,intervalTime:s,fileConfig:i}=m(this.baseConfig,o),a=u(r)?r:[r],c=a.length;let l=0;const d=[];h(a,s,(function(o,r){if(o)return void(r.id===c&&n(d));const{id:s,statusCode:a,headers:u,data:f}=r,h=u["content-type"]??"",m=h.split("/").pop(),g=(new Date).getTime().toString(),p=e.resolve(i.storeDir,`${g}.${m}`);t.createWriteStream(p,"binary").write(f,(e=>{if(e)return console.log(`File save error at id ${s}: ${e.message}`);const t={fileName:g,mimeType:h,size:f.length,filePath:p};d.push({id:s,statusCode:a,headers:u,data:t}),++l!==c&&s!==c||n(d)}))}))}))}async fetchHTML(e){const{requestConifg:t}=m(this.baseConfig,{requestConifg:{url:e}}),n=await f(t);return new o.JSDOM(n.data)}}({timeout:1e4,intervalTime:{max:3e3,min:2e3}});g.fetchHTML("https://www.bilibili.com/").then((t=>{const o=t.window.document.querySelectorAll(".bili-video-card__cover"),n=[];o.forEach(((e,t)=>{const o=e.lastChild;t%2?n.push("https:"+o.src):n.push(o.src)})),console.log(n);const r=n.map((e=>({url:e})));g.fetchFile({requestConifg:r,fileConfig:{storeDir:e.resolve(__dirname,"./upload")}}).then((e=>{console.log(e)}))}));
