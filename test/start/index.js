"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),n=require("puppeteer"),o=require("chalk"),a=require("node:http"),i=require("node:https"),s=require("node:url"),l=require("https-proxy-agent");function c(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}const u=console.log,m=o.blueBright,p=o.whiteBright,d=o.green,f=o.red,g=o.yellow,h=o.hex("#a57fff");function y(e){return void 0===e}function w(e){return"number"==typeof e}function x(e){return"object"==typeof e&&e&&!Array.isArray(e)}function v(e){return Array.isArray(e)}async function T(e,t,r,n){if(e&&n>1){const e=t?r:c(r.max,r.min);u(`Target id: ${h(n)} - Sleep time: ${h(e+"ms")}`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else u(`Target id: ${h(n)} - Sleep time: ${h("0ms")}`)}async function C(e,t,r){const{intervalTime:n}=t,o=!y(n),a=w(n),i=[];for(const s of e){const{id:e}=s;await T(o,a,n,e),i.push(r(s,t))}await Promise.all(i)}async function S(e,t,r){const{intervalTime:n}=t,o=!y(n),a=w(n);for(const i of e){const{id:e}=i;await T(o,a,n,e),await r(i,t)}}function b(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function $(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=$(e.slice(0,t)),n=$(e.slice(t)),o=[];let a=0,i=0;for(;a<r.length&&i<n.length;)r[a]>=n[i]?(o.push(r[a]),a++):(o.push(n[i]),i++);return a<r.length&&o.push(...r.slice(a)),i<n.length&&o.push(...n.splice(i)),o}function j(e){const{detailTargetConfig:t,detailTargetResult:r}=e;let n=null;if(x(r)&&Object.hasOwn(r,"response")&&r.response){n=r.response.status()}else x(r)&&(n=r.statusCode??null);let o=!1;const a=t.proxy?.switchByHttpStatus;return n&&a&&a.includes(n)&&(o=!0),o}async function I(e,t,r,n){const{type:o}=r,a=(!t.every((e=>e.priority===t[0].priority))?$(t.map((e=>({...e,valueOf:()=>e.priority})))):t).map(((e,t)=>{const r=++t,{maxRetry:n,proxyDetails:o}=e,a=[];return{id:r,isHandle:!1,isSuccess:!1,isStatusNormal:!1,detailTargetConfig:e,detailTargetResult:null,maxRetry:n,retryCount:0,proxyDetails:o,crawlErrorQueue:a,result:{id:r,isSuccess:!1,maxRetry:n,retryCount:0,proxyDetails:o,crawlErrorQueue:a,data:null}}}));u(m(`Start crawling - type: ${o}, mode: ${e}, total: ${a.length}`));const i="async"===e?C:S;let s=0,l=a;for(;l.length;)if(await i(l,r,n),l=l.filter((e=>{const{isHandle:t,retryCount:r,maxRetry:n,detailTargetConfig:o,proxyDetails:a,crawlErrorQueue:i,isStatusNormal:s}=e;let l=!1;if(!t&&r<n&&(l=!0,a.length>=2)){const e=o.proxy?.switchByErrorCount;if(!s||!y(e)&&e>=i.length){a.find((e=>e.url===o.proxyUrl)).state=!1;const e=a.find((e=>e.state))?.url;y(e)||(o.proxyUrl=e)}}return l})),l.length){const e=l.map((e=>(e.retryCount++,e.id)));u(g(`Start retrying - count: ${++s}, targets id: [ ${e.join(", ")} ]`))}const c=[],h=[];return a.forEach((e=>{e.isSuccess?c.push(e.id):h.push(e.id)})),u(p(`Crawl ${o}s finish:`)),u(d(`  Success - total: ${c.length}, targets id: [ ${c.join(", ")} ]`)),u(f(`    Error - total: ${h.length}, targets id: [ ${h.join(", ")} ]`)),a.map((e=>e.result))}function M(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function R(e){const{protocol:t,hostname:r,port:n,pathname:o,search:c}=new s.URL(e.url),u="http:"===t,m={agent:e.proxyUrl?l(e.proxyUrl):u?new a.Agent:new i.Agent,protocol:t,hostname:r,port:n,path:o,search:M(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return m.headers=function(e,t){const r={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,m),m}const E=[{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",versions:[{name:"Chrome",maxMajorVersion:112,minMajorVersion:100,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59",versions:[{name:"Chrome",maxMajorVersion:91,minMajorVersion:88,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333},{name:"Edg",maxMinorVersion:10,maxPatchVersion:864}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0",versions:[{name:"Firefox",maxMajorVersion:47,minMajorVersion:43,maxMinorVersion:10,maxPatchVersion:5e3}]}}];function V(e){return v(e)?e.map((e=>x(e)?e:{url:e})):[x(e)?e:{url:e}]}function F(e,t){const{ua:r,platform:n,platformVersion:o,mobile:a,acceptLanguage:i,userAgent:s}=t;let l=e.headers;if(l||(e.headers=l={}),r&&(l["sec-ch-ua"]=r),a&&(l["sec-ch-ua-mobile"]="random"===a?c(2)?"?1":"?0":a),n&&(l["sec-ch-platform"]=n),o&&(l["sec-ch-ua-platform-version"]=o),i&&(l["accept-language"]=i),s){let e=s.value;s.versions?.forEach((t=>{const{name:r,maxMajorVersion:n,minMajorVersion:o,maxMinorVersion:a,minMinorVersion:i,maxPatchVersion:s,minPatchVersion:l}=t,u=e.split(`${r}/`)[1].split(" ")[0].split("."),m=u.join(".");y(n)||(u[0]=n===o?n:c(n,o)),y(a)||(u[1]=a===i?a:c(a,i)),y(s)||(u[2]=s===l?s:c(s,l));const p=`${r}/${m}`,d=`${r}/${u.join(".")}`;e=e.replace(p,d)})),l["user-agent"]=e}}function O(e,t){const{maxWidth:r,minWidth:n,maxHeight:o,minHidth:a}=t,i=e.viewport??{};r&&(i.width=r===n?r:c(r,n)),o&&(i.height=o===a?o:c(o,a)),Object.hasOwn(i,"width")&&Object.hasOwn(i,"height")&&(e.viewport=i)}function P(e,t,r){r.detailTargets=t.detailTargets.map((n=>{const o=n,{url:a,timeout:i,proxy:s,maxRetry:l,priority:u,headers:m,fingerprint:p}=o;if(y(e.baseUrl)||(o.url=e.baseUrl+a),y(i)&&(y(t.timeout)?o.timeout=e.timeout:o.timeout=t.timeout),y(l)&&(y(t.maxRetry)?o.maxRetry=e.maxRetry:o.maxRetry=t.maxRetry),y(s)&&(y(t.proxy)?y(e.proxy)||(o.proxy=e.proxy):o.proxy=t.proxy),y(o.proxy?.urls))o.proxyDetails=[];else{const e=o.proxy.urls;o.proxyUrl=e[0],o.proxyDetails=e.map((e=>({url:e,state:!0})))}if(y(u)&&(o.priority=0),y(m)&&t.headers&&(o.headers={...t.headers}),p)F(o,p);else if(y(p)&&v(t.fingerprints)&&t.fingerprints.length){const e=t.fingerprints,n=c(e.length),a=e[n];r.selectFingerprintIndexs.push(n),F(o,a)}else if(y(p)&&!v(t.fingerprints)&&e.enableRandomFingerprint){F(o,E[c(E.length)])}return o})),r.intervalTime=t.intervalTime,y(t.intervalTime)&&!y(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}async function k(e,t){const{detailTargetConfig:r,detailTargetResult:n,retryCount:o,maxRetry:a,crawlErrorQueue:i}=e,{browser:s}=t,l=o===a,c=n?.page??await s.newPage();r.viewport&&await c.setViewport(r.viewport);let u=null,m=!0;try{if(r.proxyUrl?await s.createIncognitoBrowserContext({proxyServer:r.proxyUrl}):await s.createIncognitoBrowserContext({proxyServer:void 0}),r.cookies){const e=function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");r.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(r.url,r.cookies);await c.setCookie(...e)}else{const e=await c.cookies(r.url);await c.deleteCookie(...e)}r.headers&&await c.setExtraHTTPHeaders(r.headers),u=await c.goto(r.url,{timeout:r.timeout})}catch(e){m=!1,i.push(e)}e.detailTargetResult={response:u,page:c};const p=!j(e),d=m&&p;e.isStatusNormal=p,e.isSuccess=d,(d||l)&&(e.isHandle=!0,function(e,t){const{detailTargetResult:r,result:n}=e,{browser:o,onCrawlItemComplete:a}=t;W(e),n.data={browser:o,...r},a&&a(e.result)}(e,t))}async function A(n,o){const{detailTargetConfig:s,crawlErrorQueue:l,maxRetry:c,retryCount:u}=n,m=c===u;let p=null,d=!0;try{p=await(f=s,new Promise(((e,t)=>{const r=y(f.data);f.data=r?f.data:JSON.stringify(f.data);const n=R(f);function o(t){const{statusCode:r,headers:n}=t,o=[];t.on("data",(e=>o.push(e))),t.on("end",(()=>{const t=Buffer.concat(o);e({statusCode:r,headers:n,data:t})}))}let s;s="http:"===n.protocol?a.request(n,o):i.request(n,o),s.on("timeout",(()=>{t(new Error(`Timeout ${f.timeout}ms`))})),s.on("error",(e=>{t(e)})),"POST"!==n.method||r||s.write(f.data),s.end()})))}catch(e){d=!1,l.push(e)}var f;n.detailTargetResult=p;const g=!j(n),h=d&&g;n.isStatusNormal=g,n.isSuccess=h,(h||m)&&(n.isHandle=!0,"data"===o.type?function(e,t){const{isSuccess:r,detailTargetResult:n,result:o}=e,{onCrawlItemComplete:a}=t;if(W(e),r&&n){const e=n.headers["content-type"]??"",t="application/json"===e?JSON.parse(n.data.toString()):e.includes("text")?n.data.toString():n.data;o.data={...n,data:t}}a&&a(o)}(n,o):"file"===o.type&&function(n,o){const{id:a,isSuccess:i,detailTargetConfig:s,detailTargetResult:l,result:c}=n,{saveFileErrorArr:u,saveFilePendingQueue:m,onCrawlItemComplete:p,onBeforeSaveItemFile:d}=o;if(W(n),i&&l){const o=l.headers["content-type"]??"",i=s.fileName??`${a}-${(new Date).getTime()}`,f=s.extension??`.${o.split("/").pop()}`;s.storeDir&&!e.existsSync(s.storeDir)&&e.mkdirSync(s.storeDir,{recursive:!0});const g=s.storeDir??__dirname,h=r.resolve(g,i+f),y=l.data;let w=Promise.resolve(y);d&&(w=d({id:a,fileName:i,filePath:h,data:y}));const x=w.then((async e=>{let r=!0;try{await t.writeFile(h,e)}catch(e){r=!1;const t=`File save error at id ${a}: ${e.message}`,n=()=>a;u.push({message:t,valueOf:n})}const s=e.length;c.data={...l,data:{isSuccess:r,fileName:i,fileExtension:f,mimeType:o,size:s,filePath:h}},p&&p(n.result)}));m.push(x)}else p&&p(n.result)}(n,o))}const D=["isSuccess","retryCount"];function W(e){Object.keys(e).forEach((t=>{D.includes(t)&&(e.result[t]=e[t])}))}function B(e){let t=null,r=null,o=!1;return async function(a,i){o||(o=!0,r=n.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{detailTargets:s,intervalTime:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let n={targets:[],detailTargets:[]};if(x(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,n.detailTargets=V(e)}else n.detailTargets=V(t);return P(e,n,r),r.detailTargets.forEach(((e,t)=>{const{cookies:o,viewport:a,fingerprint:i}=e;if(y(o)&&n.cookies&&(e.cookies=n.cookies),y(a)&&n.viewport&&(e.viewport=n.viewport),i)O(e,i);else if(y(i)&&n.fingerprints?.length){const o=r.selectFingerprintIndexs[t];O(e,n.fingerprints[o])}})),r}(e,a),u={type:"page",browser:t,intervalTime:l,onCrawlItemComplete:c},m=await I(e.mode,s,u,k),p=v(a)||x(a)&&Object.hasOwn(a,"targets")?m:m[0];return i&&i(p),p}}function N(e){return async function(t,r){const{detailTargets:n,intervalTime:o,onCrawlItemComplete:a}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let n={targets:[],detailTargets:[]};if(x(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,n.detailTargets=V(e)}else n.detailTargets=V(t);return P(e,n,r),r}(e,t),i={type:"data",intervalTime:o,onCrawlItemComplete:a},s=await I(e.mode,n,i,A),l=v(t)||x(t)&&Object.hasOwn(t,"targets")?s:s[0];return r&&r(l),l}}function H(e){return async function(t,r){const{detailTargets:n,intervalTime:o,onBeforeSaveItemFile:a,onCrawlItemComplete:i}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onBeforeSaveItemFile:void 0,onCrawlItemComplete:void 0};let n={targets:[],detailTargets:[]};if(x(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,n.detailTargets=V(e)}else n.detailTargets=v(t)?t:[t];P(e,n,r);const o=!y(n?.storeDir),a=!y(n?.extension);return r.detailTargets.forEach((e=>{y(e.storeDir)&&o&&(e.storeDir=n.storeDir),y(e.extension)&&a&&(e.extension=n.extension)})),r.onBeforeSaveItemFile=n.onBeforeSaveItemFile,r}(e,t),s={type:"file",saveFileErrorArr:[],saveFilePendingQueue:[],intervalTime:o,onCrawlItemComplete:i,onBeforeSaveItemFile:a},l=await I(e.mode,n,s,A),{saveFilePendingQueue:c,saveFileErrorArr:m}=s;var g;await Promise.all(c),(g=m,function e(t,r){if(t>=r)return;const n=g[r];let o=t,a=r-1;for(;o<=a;){for(;g[o]<n;)o++;for(;g[a]>n;)a--;o<=a&&(b(g,o,a),o++,a--)}b(g,o,r),e(t,o-1),e(o+1,r)}(0,g.length-1),g).forEach((e=>u(f(e.message))));const h=[],w=[];l.forEach((e=>{e.data?.data.isSuccess?h.push(e.id):w.push(e.id)})),u(p("Save files finish:")),u(d(`  Success - total: ${h.length}, targets id: [ ${h.join(", ")} ]`)),u(f(`    Error - total: ${w.length}, targets id: [ ${w.join(", ")} ]`));const T=v(t)||x(t)&&Object.hasOwn(t,"targets")?l:l[0];return r&&r(T),T}}function q(e,t){const{d:r,h:n,m:o}=e,a=(y(r)?0:1e3*r*60*60*24)+(y(n)?0:1e3*n*60*60)+(y(o)?0:1e3*o*60);let i=0;l();const s=setInterval(l,a);function l(){console.log(m("Start polling - count: "+ ++i)),t(i,c)}function c(){clearInterval(s),console.log(g("Stop the polling"))}}const U=function(e){const t=function(e){const t=e||{};return y(t.mode)&&(t.mode="async"),y(t.enableRandomFingerprint)&&(t.enableRandomFingerprint=!0),y(e?.timeout)&&(t.timeout=1e4),y(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:B(e),crawlData:N(e),crawlFile:H(e),startPolling:q}}(t)}({maxRetry:2});U.crawlData(["https://","https://","https://"]).then((e=>{console.log(e)}));
