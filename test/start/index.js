"use strict";var e=require("node:path"),t=require("node:fs"),n=require("jsdom"),o=require("node:http"),r=require("https"),s=require("node:url"),a=require("chalk");const i=console.log,c=a.hex("#a57fff"),u=a.green,l=a.red,h=a.yellow;function f(e){return void 0===e}function d(e){return"number"==typeof e}function m(e){return Array.isArray(e)}function g(e,t){let n=e?`${e}`:"?";if(t)for(const e in t){n+=`&${e}=${t[e]}`}else n=e;return n}function p(e){const{protocol:t,hostname:n,port:a,pathname:i,search:c}=new s.URL(e.url),u={protocol:t,hostname:n,port:a,path:i,search:g(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(n["Content-Type"]="application/json",n["Content-Length"]=Buffer.byteLength(e.data)),n}(e,u),u.agent="http:"===t?new o.Agent:new r.Agent,u}async function y(e,t,n,o){if(e&&o>1){const e=t?n:function(e,t=0){let n=Math.floor(Math.random()*e);for(;n<t;)n=Math.floor(Math.random()*e);return n}(n.max,n.min);i(`Request ${c(o)} needs to sleep for ${c(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else i(`Request ${c(o)} does not need to sleep, send immediately`)}function q(e){return new Promise(((t,n)=>{const r=f(e.data);e.data=r?e.data:JSON.stringify(e.data);const s=p(e),a=o.request(s,(e=>{const{statusCode:n,headers:o}=e,r=[];e.on("data",(e=>r.push(e))),e.on("end",(()=>{const e=Buffer.concat(r);t({statusCode:n,headers:o,data:e})}))}));a.on("timeout",(()=>{n(new Error(`Timeout ${e.timeout}ms`))})),a.on("error",(e=>{n(e)})),"POST"!==s.method||r||a.write(e.data),a.end()}))}const w=new class{baseConfig;constructor(e={}){this.baseConfig=e}mergeConfig(e){const t=this.baseConfig,n=structuredClone(e),o=m(n.requestConifg)?n.requestConifg:[n.requestConifg];for(const e of o){const{url:n,timeout:o}=e;f(t.baseUrl)||(e.url=t.baseUrl+n),f(o)&&(e.timeout=t.timeout)}return f(n.intervalTime)&&(n.intervalTime=t.intervalTime),n}async useBatchRequestByMode(e,t){const n=m(e)?e:[e];let o=[];return o="sync"!==this.baseConfig.mode?await async function(e,t){const n=!f(t),o=d(t);i(`Begin execution, mode: async, total: ${c(e.length)} `);const r=[];let s=0;for(const a of e){const e=++s;await y(n,o,t,e);const i=q(a).catch((t=>`Request ${e} is an error: ${t.message}`)).then((t=>"string"==typeof t?t:{id:e,...t}));r.push(i)}i(u("All requests have been sent!"));const a=await Promise.all(r),h=[],m=[];return a.forEach((e=>{if("string"==typeof e)return m.push(e);h.push(e)})),m.forEach((e=>i(l(e)))),i(`requestsTotal: ${c(e.length)}, success: ${u(h.length)}, error: ${l(m.length)}`),h}(n,t):await async function(e,t){const n=!f(t),o=d(t);i(`Begin execution, mode: sync, total: ${c(e.length)} `);let r=0,s=0,a=0;const h=[];for(const f of e){r++,await y(n,o,t,r);try{const e=await q(f);h.push({id:r,...e}),i(u(`Request ${c(r)} is an success`)),s++}catch(e){i(l(`Request ${r} is an error: ${e.message}`)),a++}}return i(u("All requests are over!")),i(`requestsTotal: ${c(e.length)}, success: ${u(s)}, error: ${l(a)}`),h}(n,t),o}async fetchHTML(e){const{requestConifg:t}=this.mergeConfig({requestConifg:(o=e,"string"==typeof o?{url:e}:e)});var o;const r=await q(t),s=r.data.toString();return{...r,data:{raw:s,jsdom:new n.JSDOM(s)}}}async fetchData(e){const{requestConifg:t,intervalTime:n}=this.mergeConfig(e),o=await this.useBatchRequestByMode(t,n),r=[];return o.forEach((e=>{const t=e.headers["content-type"]??"",n=e.data,o=t.includes("text")?n.toString():JSON.parse(n.toString());r.push({...e,data:o})})),r}async fetchFile(n){const{requestConifg:o,intervalTime:r,fileConfig:s}=this.mergeConfig(n),a=await this.useBatchRequestByMode(o,r),h=[];a.forEach((n=>{const{id:o,headers:r,data:a}=n,c=r["content-type"]??"",u=c.split("/").pop(),f=(new Date).getTime().toString(),d=e.resolve(s.storeDir,`${f}.${u}`);try{t.writeFileSync(d,a),h.push({...n,data:{fileName:f,mimeType:c,size:a.length,filePath:d}})}catch(e){i(l(`File save error at id ${o}: ${e.message}`))}}));const f=a.length,d=h.length,m=f-d;return i(`saveTotal: ${c(f)}, success: ${u(d)}, error: ${l(m)}`),h}fetchPolling(e,t){const{Y:n,M:o,d:r,h:s,m:a}=e,i=(f(n)?0:1e3*n*60*60*24*365)+(f(o)?0:1e3*o*60*60*24*30)+(f(r)?0:1e3*r*60*60*24)+(f(s)?0:1e3*s*60*60)+(f(a)?0:1e3*a*60);let c=0;function u(){console.log(h(`Start the ${h.bold(++c)} polling`)),t(c)}u(),setInterval(u,i)}}({timeout:1e4,intervalTime:{max:2e3,min:1e3},mode:"async"});w.fetchPolling({m:2},(()=>{w.fetchHTML("https://www.bilibili.com/guochuang/").then((t=>{const{jsdom:n}=t.data,o=[];n.window.document.querySelectorAll(".chief-recom-item").forEach((e=>o.push(e.querySelector("img").src)));const r=o.map((e=>({url:`https:${e}`})));r.pop(),w.fetchFile({requestConifg:r,fileConfig:{storeDir:e.resolve(__dirname,"./upload")}})}))}));
