"use strict";var e=require("node:fs"),t=require("node:path"),n=require("jsdom"),o=require("node:http"),s=require("https"),r=require("node:url"),a=require("chalk");function i(e,t=0){let n=Math.floor(Math.random()*e);return n<t&&(n=i(e,t)),n}const c=console.log,u=a.hex("#a57fff"),h=a.green,l=a.red;function d(e){return void 0===e}function f(e){return"number"==typeof e}function m(e){return Array.isArray(e)}function p(e,t){let n=e?`${e}`:"?";if(t)for(const e in t){n+=`&${e}=${t[e]}`}else n=e;return n}function g(e){const{protocol:t,hostname:n,port:a,pathname:i,search:c}=new r.URL(e.url),u={protocol:t,hostname:n,port:a,path:i,search:p(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(n["Content-Type"]="application/json",n["Content-Length"]=Buffer.byteLength(e.data)),n}(e,u),u.agent="http:"===t?new o.Agent:new s.Agent,u}async function y(e,t,n,o){if(e&&o>1){const e=t?n:i(n.max,n.min);c(`Request ${u(o)} needs to sleep for ${u(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else c(`Request ${u(o)} does not need to sleep, send immediately`)}function w(e){return new Promise(((t,n)=>{const s=d(e.data);e.data=s?e.data:JSON.stringify(e.data);const r=g(e),a=o.request(r,(e=>{const{statusCode:n,headers:o}=e,s=[];e.on("data",(e=>s.push(e))),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:n,headers:o,data:e})}))}));a.on("timeout",(()=>{n(new Error(`Timeout ${e.timeout}ms`))})),a.on("error",(e=>{n(e)})),"POST"!==r.method||s||a.write(e.data),a.end()}))}function q(e,t){const{baseUrl:n,timeout:o,intervalTime:s}=e,{requestConifg:r,intervalTime:a}=t,i=m(r)?r:[r];for(const e of i){const{url:t,timeout:s}=e;d(n)||(e.url=n+t),d(s)&&!d(o)&&(e.timeout=o)}return d(a)&&!d(s)&&(t.intervalTime=s),t}new class{baseConfig;constructor(e={}){this.baseConfig=e}async useBatchRequestByMode(e,t){const n=m(e)?e:[e];let o=[];return o="sync"!==this.baseConfig.mode?await async function(e,t){const n=!d(t),o=f(t);c(`Begin execution, mode: async, total: ${u(e.length)} `);const s=[];let r=0;for(const a of e){const e=++r;await y(n,o,t,e);const i=w(a).catch((t=>`Request ${e} is an error: ${t.message}`)).then((t=>"string"==typeof t?t:{id:e,...t}));s.push(i)}c(h("All requests have been sent!"));const a=await Promise.all(s),i=[],m=[];return a.forEach((e=>{if("string"==typeof e)return m.push(e);i.push(e)})),m.forEach((e=>c(l(e)))),c(`total: ${u(e.length)}, success: ${h(i.length)}, error: ${l(m.length)}`),i}(n,t):await async function(e,t){const n=!d(t),o=f(t);c(`Begin execution, mode: sync, total: ${u(e.length)} `);let s=0,r=0,a=0;const i=[];for(const d of e){s++,await y(n,o,t,s);try{const e=await w(d);i.push({id:s,...e}),c(h(`Request ${u(s)} is an success`)),r++}catch(e){c(l(`Request ${s} is an error: ${e.message}`)),a++}}return c(h("All requests are over!")),c(`total: ${u(e.length)}, success: ${h(r)}, error: ${l(a)}`),i}(n,t),o}async fetchHTML(e){const t="string"==typeof e?{url:e}:e;const{requestConifg:o}=q(this.baseConfig,{requestConifg:t}),s=await w(o),r=s.data.toString();return{...s,data:{raw:r,jsdom:new n.JSDOM(r)}}}async fetchData(e){const{requestConifg:t,intervalTime:n}=q(this.baseConfig,e),o=await this.useBatchRequestByMode(t,n),s=[];return o.forEach((e=>{const t=e.headers["content-type"]??"",n=e.data,o=t.includes("text")?n.toString():JSON.parse(n.toString());s.push({...e,data:o})})),s}async fetchFile(n){const{requestConifg:o,intervalTime:s,fileConfig:r}=q(this.baseConfig,n),a=await this.useBatchRequestByMode(o,s);return new Promise((n=>{const o=[];a.forEach(((s,i)=>{const{id:u,statusCode:h,headers:d,data:f}=s,m=d["content-type"]??"",p=m.split("/").pop(),g=(new Date).getTime().toString(),y=t.resolve(r.storeDir,`${g}.${p}`);e.createWriteStream(y,"binary").write(f,(e=>{if(e)c(l(`File save error at id ${u}: ${e.message}`));else{const e={fileName:g,mimeType:m,size:f.length,filePath:y};o.push({id:u,statusCode:h,headers:d,data:e})}i===a.length-1&&n(o)}))}))}))}}({timeout:1e4,intervalTime:{max:3e3,min:2e3},mode:"async"}).fetchData({requestConifg:[{url:"http://localhost:3001/home"},{url:"http://localhost:9001/api/home/wonderfulplace"},{url:"http://localhost:9001/api/home/goodprice"},{url:"http://localhost:3001/home"},{url:"http://localhost:9001/ai/home/goodprice"}]}).then((e=>{}));
