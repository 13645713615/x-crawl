"use strict";var e=require("node:path"),t=require("node:fs"),o=require("node:fs/promises"),n=require("jsdom"),s=require("node:http"),r=require("node:https"),a=require("node:url"),i=require("https-proxy-agent"),c=require("chalk");function u(e,t,o){const n=e[t];e[t]=e[o],e[o]=n}function l(e){return function t(o,n){if(o>=n)return;const s=e[n];let r=o,a=n-1;for(;r<=a;){for(;e[r]<s;)r++;for(;e[a]>s;)a--;r<=a&&(u(e,r,a),r++,a--)}u(e,r,n),t(o,r-1),t(r+1,n)}(0,e.length-1),e}const f=console.log,h=c.hex("#a57fff"),d=c.green,m=c.red,g=c.yellow;function p(e){return void 0===e}function y(e){return"number"==typeof e}function q(e){return Array.isArray(e)}function w(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function $(e){const{protocol:t,hostname:o,port:n,pathname:c,search:u}=new a.URL(e.url),l="http:"===t,f={agent:e.proxy?i(e.proxy):l?new s.Agent:new r.Agent,protocol:t,hostname:o,port:n,path:c,search:w(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",cookie:"",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,f),f}function C(e){return new Promise(((t,o)=>{const n=p(e.data);e.data=n?e.data:JSON.stringify(e.data);const a=$(e);function i(e){const{statusCode:o,headers:n}=e,s=[];e.on("data",(e=>s.push(e))),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:o,headers:n,data:e})}))}let c;c="http:"===a.protocol?s.request(a,i):r.request(a,i),c.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),c.on("error",(e=>{o(e)})),"POST"!==a.method||n||c.write(e.data),c.end()}))}async function T(e,t,o,n){if(e&&n>1){const e=t?o:function(e,t=0){let o=Math.floor(Math.random()*e);for(;o<t;)o=Math.floor(Math.random()*e);return o}(o.max,o.min);f(`Request ${h(n)} needs to sleep for ${h(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else f(`Request ${h(n)} does not need to sleep, send immediately`)}const v=new class{baseConfig;constructor(e={}){this.baseConfig=e}mergeConfig(e){const t=this.baseConfig,o=structuredClone(e),n=q(o.requestConifg)?o.requestConifg:[o.requestConifg];for(const e of n){const{url:o,timeout:n,proxy:s}=e;p(t.baseUrl)||(e.url=t.baseUrl+o),p(n)&&(e.timeout=t.timeout),p(s)&&(e.proxy=t.proxy)}return p(o.intervalTime)&&(o.intervalTime=t.intervalTime),o}async useBatchRequestByMode(e,t,o){const n=q(e)?e:[e];"sync"!==this.baseConfig.mode?await async function(e,t,o){const n=!p(t),s=y(t);f(`Begin execution, mode: async, total: ${h(e.length)} `);let r=0,a=0,i=0;const c=[],u=[];for(const l of e){const e=++r;await T(n,s,t,e);const f=C(l).catch((t=>{i++;const o=`Request ${e} is an error: ${t.message}`;u.push({message:o,valueOf:()=>e})})).then((t=>{t&&(a++,o({id:e,...t}))}));c.push(f)}f(d("All requests have been sent!")),await Promise.all(c),l(u).forEach((e=>f(m(e.message)))),f(`requestsTotal: ${h(e.length)}, success: ${d(a)}, error: ${m(i)}`)}(n,t,o):await async function(e,t,o){const n=!p(t),s=y(t);f(`Begin execution, mode: sync, total: ${h(e.length)} `);let r=0,a=0,i=0;for(const c of e){r++,await T(n,s,t,r);let e=!0,u=null;try{u={id:r,...await C(c)},f(d(`Request ${h(r)} is an success`)),a++}catch(t){e=!1,f(m(`Request ${r} is an error: ${t.message}`)),i++}e&&o&&o(u)}f(d("All requests are over!")),f(`requestsTotal: ${h(e.length)}, success: ${d(a)}, error: ${m(i)}`)}(n,t,o)}async fetchHTML(e,t){const{requestConifg:o}=this.mergeConfig({requestConifg:(s=e,"string"==typeof s?{url:e}:e)});var s;const r=await C(o),a=r.data.toString(),i={...r,data:{html:a,jsdom:new n.JSDOM(a)}};return t&&t(i),i}async fetchData(e,t){const{requestConifg:o,intervalTime:n}=this.mergeConfig(e),s=[];await this.useBatchRequestByMode(o,n,(function(e){const o=e.headers["content-type"]??"",n=e.data,r=o.includes("text")?n.toString():JSON.parse(n.toString()),a={...e,data:r};t&&t(a),s.push(a)}));return l(s.map((e=>({...e,valueOf:()=>e.id}))))}async fetchFile(n,s){const{requestConifg:r,intervalTime:a,fileConfig:i}=this.mergeConfig(n),c=[],u=[],g=[];t.existsSync(i.storeDir)||t.mkdirSync(i.storeDir),await this.useBatchRequestByMode(r,a,(function(t){const{id:n,headers:r,data:a}=t,l=r["content-type"]??"",f=i.extension??l.split("/").pop(),h=(new Date).getTime().toString(),d=e.resolve(i.storeDir,`${h}.${f}`),m=o.writeFile(d,a).catch((e=>{const t=`File save error at id ${n}: ${e.message}`;return g.push({message:t,valueOf:()=>n}),!0})).then((e=>{if(e)return;const o={...t,data:{fileName:h,mimeType:l,size:a.length,filePath:d}};s&&s(o),c.push(o)}));u.push(m)})),await Promise.all(u),l(g).forEach((e=>f(m(e.message))));const p=q(r)?r.length:1,y=c.length,w=p-y;f(`saveFileTotal: ${h(p)}, success: ${d(y)}, error: ${m(w)}`);return l(c.map((e=>({...e,valueOf:()=>e.id}))))}fetchPolling(e,t){const{Y:o,M:n,d:s,h:r,m:a}=e,i=(p(o)?0:1e3*o*60*60*24*365)+(p(n)?0:1e3*n*60*60*24*30)+(p(s)?0:1e3*s*60*60*24)+(p(r)?0:1e3*r*60*60)+(p(a)?0:1e3*a*60);let c=0;function u(){console.log(g(`Start the ${g.bold(++c)} polling`)),t(c)}u(),setInterval(u,i)}}({timeout:1e4,intervalTime:{max:0,min:0},mode:"async"});v.fetchHTML("https://www.bilibili.com/guochuang/",(e=>{console.log("fetchHTML Callback: ",e.statusCode)})).then((t=>{const{jsdom:o}=t.data,n=[];o.window.document.querySelectorAll(".chief-recom-item").forEach((e=>n.push(e.querySelector("img").src)));const s=n.map((e=>({url:`https:${e}`})));s.pop(),v.fetchFile({requestConifg:s,fileConfig:{storeDir:e.resolve(__dirname,"./upload")}},(e=>{console.log(e.id,e.statusCode,e.data.fileName)})).then((e=>console.log(e)))}));
