"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),n=require("chalk"),s=require("node:http"),i=require("node:https"),a=require("node:url"),u=require("https-proxy-agent"),c=require("sharp"),l=require("path");const f=console.log,p=n.hex("#a57fff"),h=n.green,m=n.red,d=n.yellow;function g(e){return void 0===e}function y(e){return"number"==typeof e}function w(e){return"object"==typeof e&&e&&!Array.isArray(e)}function x(e){return Array.isArray(e)}async function C(e,t,r,o){if(e&&o>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);f(`Id: ${p(o)} - Crawl needs to sleep for ${p(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else f(`Id: ${p(o)} - Crawl does not need to sleep, send immediately`)}async function S(e,t,r,o){const n=!g(t),s=y(t),i=[];for(const a of e){const{id:e}=a;await C(n,s,t,e),a.crawlCount++;const u=o(a,r).catch((e=>(a.errorQueue.push(e),!1))).then((e=>{!1!==e&&(a.isSuccess=!0,a.crawlSingleRes=e)}));i.push(u)}await Promise.all(i)}async function v(e,t,r,o){const n=!g(t),s=y(t);for(const i of e){const{id:e}=i;await C(n,s,t,e),i.crawlCount++;try{i.crawlSingleRes=await o(i,r),i.isSuccess=!0}catch(e){i.errorQueue.push(e)}}}function q(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function R(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=R(e.slice(0,t)),o=R(e.slice(t)),n=[];let s=0,i=0;for(;s<r.length&&i<o.length;)r[s]>=o[i]?(n.push(r[s]),s++):(n.push(o[i]),i++);return s<r.length&&n.push(...r.slice(s)),i<o.length&&n.push(...o.splice(i)),n}async function $(e,t,r,o,n,s){const i=(!r.every((e=>e.priority===r[0].priority))?R(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,crawlCount:0,errorQueue:[],requestConfig:e,crawlSingleRes:null})));f(`${h("Start crawling")} - name: ${d(e)}, mode: ${d(t)}, total: ${p(i.length)} `);const a="async"===t?S:v;let u=0,c=i;for(;c.length;)if(await a(c,o,n,s),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.crawlCount<=e.maxRetry)),c.length){const e=c.map((e=>e.id));f(d(`Retry: ${++u} - Ids to retry: [ ${e.join(" - ")} ]`))}const l=[],g=[];return i.forEach((e=>{e.isSuccess?l.push(e.id):g.push(e.id)})),f("Crawl the final result:"),f(h(`  Success - total: ${l.length}, ids: [ ${l.join(" - ")} ]`)),f(m(`    Error - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),i}function T(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function b(e){const{protocol:t,hostname:r,port:o,pathname:n,search:c}=new a.URL(e.url),l="http:"===t,f={agent:e.proxy?u(e.proxy):l?new s.Agent:new i.Agent,protocol:t,hostname:r,port:o,path:n,search:T(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,f),f}async function O(e){const{requestConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const o=g(r.data);r.data=o?r.data:JSON.stringify(r.data);const n=b(r);function a(t){const{statusCode:r,headers:o}=t,n=[];t.on("data",(e=>n.push(e))),t.on("end",(()=>{const t=Buffer.concat(n);e({statusCode:r,headers:o,data:t})}))}let u;u="http:"===n.protocol?s.request(n,a):i.request(n,a),u.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),u.on("error",(e=>{t(e)})),"POST"!==n.method||o||u.write(r.data),u.end()})));var r}function j(e){return x(e)?e.map((e=>w(e)?e:{url:e})):[w(e)?e:{url:e}]}function k(e,t,r){r.requestConfigs=t.map((t=>{let{url:o,timeout:n,proxy:s,maxRetry:i,priority:a}=t;return g(e.baseUrl)||(o=e.baseUrl+o),g(n)&&(n=g(r.timeout)?e.timeout:r.timeout),g(s)&&(g(r.proxy)?g(e.proxy)||(s=e.proxy):s=r.proxy),g(i)&&(i=g(r.maxRetry)?e.maxRetry:r.maxRetry),g(a)&&(a=0),{...t,url:o,timeout:n,proxy:s,maxRetry:i,priority:a}})),g(r.intervalTime)&&!g(e.intervalTime)&&(r.intervalTime=e.intervalTime)}function E(e){let t=null,r=null,n=!1,s=0;const i=new Map;async function a(e,r){const{id:o,requestConfig:n}=e,s=await t.newPage();await s.setViewport({width:1280,height:1024});let a=null;try{n.proxy?await t.createIncognitoBrowserContext({proxyServer:n.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),n.headers&&await s.setExtraHTTPHeaders(n.headers),n.cookies&&await s.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(n.url,n.cookies)),a=await s.goto(n.url,{timeout:n.timeout})}catch(e){let t=i.get(r);throw t||(t=new Map,i.set(r,t)),t.get(o)||t.set(o,s),e}return{response:a,page:s}}return async function(u,c){const l=++s;n||(n=!0,r=o.launch().then((e=>{t=e}))),r&&(await r,r&&(r=null));const{requestConfigs:f,intervalTime:p}=function(e,t){const r={requestConfigs:[]},o=[];if(w(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:s,cookies:i,intervalTime:a,maxRetry:u}=t;r.proxy=n,r.cookies=i,r.intervalTime=a,r.maxRetry=u,r.timeout=s,o.push(...j(e))}else{const e=j(t);o.push(...e)}return k(e,o,r),g(r.cookies)||r.requestConfigs.forEach((e=>{const{cookies:t}=e;g(t)&&!g(r.cookies)&&(e.cookies=r.cookies)})),r}(e,u),h=(await $("page",e.mode,f,p,l,a)).map((e=>{const{id:r,isSuccess:o,maxRetry:n,crawlCount:s,errorQueue:a,crawlSingleRes:u}=e;let f=null;if(o&&u)f={browser:t,...u};else{const e=i.get(l).get(r);f={browser:t,response:null,page:e}}const p={id:r,isSuccess:o,maxRetry:n,crawlCount:s,retryCount:s-1,errorQueue:a,data:f};return c&&c(p),p}));return i.delete(l),x(u)||w(u)&&Object.hasOwn(u,"requestConfigs")?h:h[0]}}function P(e){return async function(t,r){const{requestConfigs:o,intervalTime:n}=function(e,t){const r={requestConfigs:[]},o=[];if(w(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:s,intervalTime:i,maxRetry:a}=t;r.proxy=n,r.intervalTime=i,r.maxRetry=a,r.timeout=s,o.push(...j(e))}else{const e=j(t);o.push(...j(e))}return k(e,o,r),r}(e,t),s=(await $("data",e.mode,o,n,void 0,O)).map((e=>{const{id:t,isSuccess:o,maxRetry:n,crawlCount:s,errorQueue:i,crawlSingleRes:a}=e,u={id:t,isSuccess:o,maxRetry:n,crawlCount:s,retryCount:s-1,errorQueue:i,data:null};if(o&&a){const e=(a.headers["content-type"]??"").includes("text")?a.data.toString():JSON.parse(a.data.toString());u.data={...a,data:e}}return r&&r(u),u}));return x(t)||w(t)&&Object.hasOwn(t,"requestConfigs")?s:s[0]}}function D(o){return async function(n,s){const{requestConfigs:i,intervalTime:a,fileConfig:u}=function(e,t){const r={requestConfigs:[]},o=[];if(w(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:s,intervalTime:i,maxRetry:a,fileConfig:u}=t;r.proxy=n,r.intervalTime=i,r.maxRetry=a,r.timeout=s,r.fileConfig=u,o.push(...j(e))}else o.push(...x(t)?t:[t]);return k(e,o,r),g(r.fileConfig?.storeDir)&&g(r.fileConfig?.extension)||r.requestConfigs.forEach((e=>{g(e.storeDir)&&!g(r.fileConfig?.storeDir)&&(e.storeDir=r.fileConfig.storeDir),g(e.extension)&&!g(r.fileConfig?.extension)&&(e.extension=r.fileConfig.extension)})),r}(o,n),c=await $("file",o.mode,i,a,void 0,O),l=[],p=[],d=c.map((o=>{const{id:n,isSuccess:i,maxRetry:a,crawlCount:c,errorQueue:f,crawlSingleRes:h,requestConfig:m}=o,d={id:n,isSuccess:i,maxRetry:a,crawlCount:c,retryCount:c-1,errorQueue:f,data:null};if(i&&h){const o=h.headers["content-type"]??"",i=m.fileName??`${n}-${(new Date).getTime()}`,a=m.extension??`.${o.split("/").pop()}`;g(m.storeDir)||e.existsSync(m.storeDir)||(y=m.storeDir,r.resolve(y).split(r.sep).reduce(((t,o,n)=>{const s=0!==n?r.join(t,o):o;return e.existsSync(s)||e.mkdirSync(s),s}),""));const c=m.storeDir??__dirname,f=r.resolve(c,i+a),w=h.data;let x=Promise.resolve(w);u?.beforeSave&&(x=u.beforeSave({id:n,fileName:i,filePath:f,data:w}));const C=x.then((async e=>{let r=!0;try{await t.writeFile(f,e)}catch(e){r=!1;const t=`File save error at id ${n}: ${e.message}`,o=()=>n;p.push({message:t,valueOf:o})}const u=e.length;d.data={...h,data:{isSuccess:r,fileName:i,fileExtension:a,mimeType:o,size:u,filePath:f}},s&&s(d)}));l.push(C)}else s&&s(d);var y;return d}));var y;await Promise.all(l),(y=p,function e(t,r){if(t>=r)return;const o=y[r];let n=t,s=r-1;for(;n<=s;){for(;y[n]<o;)n++;for(;y[s]>o;)s--;n<=s&&(q(y,n,s),n++,s--)}q(y,n,r),e(t,n-1),e(n+1,r)}(0,y.length-1),y).forEach((e=>f(m(e.message))));const C=[],S=[];return d.forEach((e=>{e.data?.data.isSuccess?C.push(e.id):S.push(e.id)})),f("Save file final result:"),f(h(`  Success - total: ${C.length}, ids: [ ${C.join(" - ")} ]`)),f(m(`    Error - total: ${S.length}, ids: [ ${S.join(" - ")} ]`)),x(n)||w(n)&&Object.hasOwn(n,"requestConfigs")?d:d[0]}}function A(e,t){const{d:r,h:o,m:n}=e,s=(g(r)?0:1e3*r*60*60*24)+(g(o)?0:1e3*o*60*60)+(g(n)?0:1e3*n*60);let i=0;u();const a=setInterval(u,s);function u(){console.log(h(`Start the ${d.bold(++i)} polling`)),t(i,c)}function c(){clearInterval(a),console.log(h("Stop the polling"))}}const M=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),g(e?.timeout)&&(t.timeout=1e4),g(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:E(e),crawlData:P(e),crawlFile:D(e),startPolling:A}}(t)}();M.crawlFile({requestConfigs:["https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area/4401.jpg"],proxy:"http://localhost:14892",fileConfig:{storeDir:l.resolve(__dirname,"./upload"),beforeSave:e=>c(e.data).resize(200).toBuffer()}}).then((async e=>{e.forEach((e=>{console.log(e.data?.data.isSuccess)}))}));
