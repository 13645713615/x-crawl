"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),a=require("puppeteer"),n=require("chalk"),o=require("node:http"),s=require("node:https"),i=require("node:url"),c=require("https-proxy-agent"),l=require("sharp"),u=require("path");const h=console.log,f=n.hex("#a57fff"),p=n.green,d=n.red,w=n.yellow;function m(e){return void 0===e}function y(e){return"number"==typeof e}function g(e){return"object"==typeof e&&e&&!Array.isArray(e)}function x(e){return Array.isArray(e)}async function S(e,t,r,a){if(e&&a>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);h(`Id: ${f(a)} - Crawl needs to sleep for ${f(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else h(`Id: ${f(a)} - Crawl does not need to sleep, send immediately`)}async function D(e,t,r,a){const n=!m(t),o=y(t),s=[];for(const i of e){const{id:e}=i;await S(n,o,t,e),i.crawlCount++;const c=a(i,r).catch((e=>(i.errorQueue.push(e),!1))).then((e=>{!1!==e&&(i.isSuccess=!0,i.crawlSingleRes=e)}));s.push(c)}await Promise.all(s)}async function v(e,t,r,a){const n=!m(t),o=y(t);for(const s of e){const{id:e}=s;await S(n,o,t,e),s.crawlCount++;try{s.crawlSingleRes=await a(s,r),s.isSuccess=!0}catch(e){s.errorQueue.push(e)}}}function C(e,t,r){const a=e[t];e[t]=e[r],e[r]=a}function $(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=$(e.slice(0,t)),a=$(e.slice(t)),n=[];let o=0,s=0;for(;o<r.length&&s<a.length;)r[o]>=a[s]?(n.push(r[o]),o++):(n.push(a[s]),s++);return o<r.length&&n.push(...r.slice(o)),s<a.length&&n.push(...a.splice(s)),n}async function R(e,t,r,a,n,o){const s=(!r.every((e=>e.priority===r[0].priority))?$(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,crawlCount:0,errorQueue:[],crawlDetailConfig:e,crawlSingleRes:null})));h(`${p("Start crawling")} - name: ${w(e)}, mode: ${w(t)}, total: ${f(s.length)} `);const i="async"===t?D:v;let c=0,l=s;for(;l.length;)if(await i(l,a,n,o),l=l.filter((e=>e.maxRetry&&!e.isSuccess&&e.crawlCount<=e.maxRetry)),l.length){const e=l.map((e=>e.id));h(w(`Retry: ${++c} - Ids to retry: [ ${e.join(" - ")} ]`))}const u=[],m=[];return s.forEach((e=>{e.isSuccess?u.push(e.id):m.push(e.id)})),h("Crawl the final result:"),h(p(`  Success - total: ${u.length}, ids: [ ${u.join(" - ")} ]`)),h(d(`    Error - total: ${m.length}, ids: [ ${m.join(" - ")} ]`)),s}function b(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function P(e){const{protocol:t,hostname:r,port:a,pathname:n,search:l}=new i.URL(e.url),u="http:"===t,h={agent:e.proxy?c(e.proxy):u?new o.Agent:new s.Agent,protocol:t,hostname:r,port:a,path:n,search:b(l,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return h.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,h),h}async function O(e){const{crawlDetailConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const a=m(r.data);r.data=a?r.data:JSON.stringify(r.data);const n=P(r);function i(t){const{statusCode:r,headers:a}=t,n=[];t.on("data",(e=>n.push(e))),t.on("end",(()=>{const t=Buffer.concat(n);e({statusCode:r,headers:a,data:t})}))}let c;c="http:"===n.protocol?o.request(n,i):s.request(n,i),c.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),c.on("error",(e=>{t(e)})),"POST"!==n.method||a||c.write(r.data),c.end()})));var r}function j(e){return x(e)?e.map((e=>g(e)?e:{url:e})):[g(e)?e:{url:e}]}function T(e,t,r,a){t.forEach((t=>{let{url:n,timeout:o,proxy:s,maxRetry:i,priority:c,headers:l}=t;m(e.baseUrl)||(n=e.baseUrl+n),m(o)&&(o=m(r.timeout)?e.timeout:r.timeout),m(s)&&(m(r.proxy)?m(e.proxy)||(s=e.proxy):s=r.proxy),m(i)&&(i=m(r.maxRetry)?e.maxRetry:r.maxRetry),m(c)&&(c=0),m(l)&&(l=r.headers),a.push({...t,url:n,timeout:o,proxy:s,maxRetry:i,priority:c,headers:l})})),m(r.intervalTime)&&!m(e.intervalTime)&&(r.intervalTime=e.intervalTime)}function E(e){let t=null,r=null,n=!1,o=0;const s=new Map;async function i(e,r){const{id:a,crawlDetailConfig:n}=e,o=await t.newPage();await o.setViewport({width:1280,height:1024});let i=null;try{n.proxy?await t.createIncognitoBrowserContext({proxyServer:n.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),n.headers&&await o.setExtraHTTPHeaders(n.headers),n.cookies&&await o.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const a=t.split("=");r.push({name:a[0],value:a[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(n.url,n.cookies)),i=await o.goto(n.url,{timeout:n.timeout})}catch(e){let t=s.get(r);throw t||(t=new Map,s.set(r,t)),t.get(a)||t.set(a,o),e}return{response:i,page:o}}return async function(c,l){const u=++o;n||(n=!0,r=a.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{crawlPageDetails:h,intervalTime:f}=function(e,t){const r={crawlPageDetails:[]},a=[];if(g(t)&&Object.hasOwn(t,"crawlPages")){const{crawlPages:e}=t,n=t,o=r;Object.keys(t).forEach((e=>{"crawlPages"!==e&&(o[e]=n[e])})),a.push(...j(e))}else{const e=j(t);a.push(...e)}return T(e,a,r,r.crawlPageDetails),m(r.cookies)||r.crawlPageDetails.forEach((e=>{const{cookies:t}=e;m(t)&&(e.cookies=r.cookies)})),r}(e,c),p=(await R("page",e.mode,h,f,u,i)).map((e=>{const{id:r,isSuccess:a,maxRetry:n,crawlCount:o,errorQueue:i,crawlSingleRes:c}=e;let h=null;if(a&&c)h={browser:t,...c};else{const e=s.get(u).get(r);h={browser:t,response:null,page:e}}const f={id:r,isSuccess:a,maxRetry:n,crawlCount:o,retryCount:o-1,errorQueue:i,data:h};return l&&l(f),f}));return s.delete(u),x(c)||g(c)&&Object.hasOwn(c,"crawlPages")?p:p[0]}}function F(e){return async function(t,r){const{crawlDataDetails:a,intervalTime:n}=function(e,t){const r={crawlDataDetails:[]},a=[];if(g(t)&&Object.hasOwn(t,"crawlDatas")){const{crawlDatas:e}=t,n=t,o=r;Object.keys(t).forEach((e=>{"crawlDatas"!==e&&(o[e]=n[e])})),a.push(...j(e))}else{const e=j(t);a.push(...j(e))}return T(e,a,r,r.crawlDataDetails),r}(e,t),o=(await R("data",e.mode,a,n,void 0,O)).map((e=>{const{id:t,isSuccess:a,maxRetry:n,crawlCount:o,errorQueue:s,crawlSingleRes:i}=e,c={id:t,isSuccess:a,maxRetry:n,crawlCount:o,retryCount:o-1,errorQueue:s,data:null};if(a&&i){const e=(i.headers["content-type"]??"").includes("text")?i.data.toString():JSON.parse(i.data.toString());c.data={...i,data:e}}return r&&r(c),c}));return x(t)||g(t)&&Object.hasOwn(t,"crawlDatas")?o:o[0]}}function k(a){return async function(n,o){const{crawlFileDetails:s,intervalTime:i,onBeforeSaveFile:c}=function(e,t){const r={crawlFileDetails:[]},a=[];if(g(t)&&Object.hasOwn(t,"crawlFiles")){const{crawlFiles:e}=t,n=t,o=r;Object.keys(t).forEach((e=>{"crawlFiles"!==e&&(h(e),o[e]=n[e])})),a.push(...j(e))}else a.push(...x(t)?t:[t]);return T(e,a,r,r.crawlFileDetails),m(r?.storeDir)&&m(r?.extension)||r.crawlFileDetails.forEach((e=>{m(e.storeDir)&&!m(r?.storeDir)&&(e.storeDir=r.storeDir),m(e.extension)&&!m(r?.extension)&&(e.extension=r.extension)})),r}(a,n),l=await R("file",a.mode,s,i,void 0,O),u=[],f=[],w=l.map((a=>{const{id:n,isSuccess:s,maxRetry:i,crawlCount:l,errorQueue:h,crawlSingleRes:p,crawlDetailConfig:d}=a,w={id:n,isSuccess:s,maxRetry:i,crawlCount:l,retryCount:l-1,errorQueue:h,data:null};if(s&&p){const a=p.headers["content-type"]??"",s=d.fileName??`${n}-${(new Date).getTime()}`,i=d.extension??`.${a.split("/").pop()}`;m(d.storeDir)||e.existsSync(d.storeDir)||(y=d.storeDir,r.resolve(y).split(r.sep).reduce(((t,a,n)=>{const o=0!==n?r.join(t,a):a;return e.existsSync(o)||e.mkdirSync(o),o}),""));const l=d.storeDir??__dirname,h=r.resolve(l,s+i),g=p.data;let x=Promise.resolve(g);c&&(x=c({id:n,fileName:s,filePath:h,data:g}));const S=x.then((async e=>{let r=!0;try{await t.writeFile(h,e)}catch(e){r=!1;const t=`File save error at id ${n}: ${e.message}`,a=()=>n;f.push({message:t,valueOf:a})}const c=e.length;w.data={...p,data:{isSuccess:r,fileName:s,fileExtension:i,mimeType:a,size:c,filePath:h}},o&&o(w)}));u.push(S)}else o&&o(w);var y;return w}));var y;await Promise.all(u),(y=f,function e(t,r){if(t>=r)return;const a=y[r];let n=t,o=r-1;for(;n<=o;){for(;y[n]<a;)n++;for(;y[o]>a;)o--;n<=o&&(C(y,n,o),n++,o--)}C(y,n,r),e(t,n-1),e(n+1,r)}(0,y.length-1),y).forEach((e=>h(d(e.message))));const S=[],D=[];return w.forEach((e=>{e.data?.data.isSuccess?S.push(e.id):D.push(e.id)})),h("Save file final result:"),h(p(`  Success - total: ${S.length}, ids: [ ${S.join(" - ")} ]`)),h(d(`    Error - total: ${D.length}, ids: [ ${D.join(" - ")} ]`)),x(n)||g(n)&&Object.hasOwn(n,"crawlFiles")?w:w[0]}}function q(e,t){const{d:r,h:a,m:n}=e,o=(m(r)?0:1e3*r*60*60*24)+(m(a)?0:1e3*a*60*60)+(m(n)?0:1e3*n*60);let s=0;c();const i=setInterval(c,o);function c(){console.log(p(`Start the ${w.bold(++s)} polling`)),t(s,l)}function l(){clearInterval(i),console.log(p("Stop the polling"))}}const A=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),m(e?.timeout)&&(t.timeout=1e4),m(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:E(e),crawlData:F(e),crawlFile:k(e),startPolling:q}}(t)}();A.crawlFile({crawlFiles:["https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area/4401.jpg"],proxy:"http://localhost:14892",storeDir:u.resolve(__dirname,"./upload"),onBeforeSaveFile:e=>l(e.data).resize(200).toBuffer()}).then((async e=>{e.forEach((e=>{console.log(e.data?.data.isSuccess)}))}));
