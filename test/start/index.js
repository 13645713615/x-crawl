"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),n=require("chalk"),i=require("node:http"),s=require("node:https"),a=require("node:url"),c=require("https-proxy-agent");const u=console.log,l=n.hex("#a57fff"),f=n.green,m=n.red,p=n.yellow;function h(e){return void 0===e}function d(e){return"number"==typeof e}function g(e){return"object"==typeof e&&e&&!Array.isArray(e)}function y(e){return Array.isArray(e)}async function w(e,t,r,o){if(e&&o>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);u(`Id: ${l(o)} - Crawl needs to sleep for ${l(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else u(`Id: ${l(o)} - Crawl does not need to sleep, send immediately`)}async function x(e,t,r,o){const n=!h(t),i=d(t),s=[];for(const a of e){const{id:e}=a;await w(n,i,t,e),a.crawlCount++;const c=o(a,r).catch((e=>(a.errorQueue.push(e),!1))).then((e=>{!1!==e&&(a.isSuccess=!0,a.crawlSingleRes=e)}));s.push(c)}await Promise.all(s)}async function C(e,t,r,o){const n=!h(t),i=d(t);for(const s of e){const{id:e}=s;await w(n,i,t,e),s.crawlCount++;try{s.crawlSingleRes=await o(s,r),s.isSuccess=!0}catch(e){s.errorQueue.push(e)}}}function S(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function v(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=v(e.slice(0,t)),o=v(e.slice(t)),n=[];let i=0,s=0;for(;i<r.length&&s<o.length;)r[i]>=o[s]?(n.push(r[i]),i++):(n.push(o[s]),s++);return i<r.length&&n.push(...r.slice(i)),s<o.length&&n.push(...o.splice(s)),n}async function q(e,t,r,o,n,i){const s=(!r.every((e=>e.priority===r[0].priority))?v(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,crawlCount:0,errorQueue:[],requestConfig:e,crawlSingleRes:null})));u(`${f("Start crawling")} - name: ${p(e)}, mode: ${p(t)}, total: ${l(s.length)} `);const a="async"===t?x:C;let c=s;for(;c.length;)if(await a(c,o,n,i),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.crawlCount<=e.maxRetry)),c.length){const e=c.map((e=>e.id));u(p(`Ids to retry: [ ${e.join(" - ")} ]`))}const h=[],d=[];return s.forEach((e=>{e.isSuccess?h.push(e.id):d.push(e.id)})),u("Crawl the final result:"),u(f(`  Success - total: ${h.length}, ids: [ ${h.join(" - ")} ]`)),u(m(`    Error - total: ${d.length}, ids: [ ${d.join(" - ")} ]`)),s}function R(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function $(e){const{protocol:t,hostname:r,port:o,pathname:n,search:u}=new a.URL(e.url),l="http:"===t,f={agent:e.proxy?c(e.proxy):l?new i.Agent:new s.Agent,protocol:t,hostname:r,port:o,path:n,search:R(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,f),f}async function b(e){const{requestConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const o=h(r.data);r.data=o?r.data:JSON.stringify(r.data);const n=$(r);function a(t){const{statusCode:r,headers:o}=t,n=[];t.on("data",(e=>n.push(e))),t.on("end",(()=>{const t=Buffer.concat(n);e({statusCode:r,headers:o,data:t})}))}let c;c="http:"===n.protocol?i.request(n,a):s.request(n,a),c.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),c.on("error",(e=>{t(e)})),"POST"!==n.method||o||c.write(r.data),c.end()})));var r}function T(e){return y(e)?e.map((e=>g(e)?e:{url:e})):[g(e)?e:{url:e}]}function O(e,t,r){r.requestConfigs=t.map((t=>{let{url:o,timeout:n,proxy:i,maxRetry:s,priority:a}=t;return h(e.baseUrl)||(o=e.baseUrl+o),h(n)&&(n=h(r.timeout)?e.timeout:r.timeout),h(i)&&(h(r.proxy)?h(e.proxy)||(i=e.proxy):i=r.proxy),h(s)&&(s=h(r.maxRetry)?e.maxRetry:r.maxRetry),h(a)&&(a=0),{...t,url:o,timeout:n,proxy:i,maxRetry:s,priority:a}})),h(r.intervalTime)&&!h(e.intervalTime)&&(r.intervalTime=e.intervalTime)}function j(e){let t=null,r=null,n=!1,i=0;const s=new Map;async function a(e,r){const{id:o,requestConfig:n}=e,i=await t.newPage();await i.setViewport({width:1280,height:1024});let a=null;try{n.proxy?await t.createIncognitoBrowserContext({proxyServer:n.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),n.headers&&await i.setExtraHTTPHeaders(n.headers),n.cookies&&await i.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(n.url,n.cookies)),a=await i.goto(n.url,{timeout:n.timeout})}catch(e){let t=s.get(r);throw t||(t=new Map,s.set(r,t)),t.get(o)||t.set(o,i),e}return{response:a,page:i}}return async function(c,u){const l=++i;n||(n=!0,r=o.launch().then((e=>{t=e}))),r&&(await r,r&&(r=null));const{requestConfigs:f,intervalTime:m}=function(e,t){const r={requestConfigs:[]},o=[];if(g(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:i,cookies:s,intervalTime:a,maxRetry:c}=t;r.proxy=n,r.cookies=s,r.intervalTime=a,r.maxRetry=c,r.timeout=i,o.push(...T(e))}else{const e=T(t);o.push(...e)}return O(e,o,r),h(r.cookies)||r.requestConfigs.forEach((e=>{const{cookies:t}=e;h(t)&&!h(r.cookies)&&(e.cookies=r.cookies)})),r}(e,c),p=(await q("page",e.mode,f,m,l,a)).map((e=>{const{id:r,isSuccess:o,maxRetry:n,crawlCount:i,errorQueue:a,crawlSingleRes:c}=e;let f=null;if(o&&c)f={browser:t,...c};else{const e=s.get(l).get(r);f={browser:t,response:null,page:e}}const m={id:r,isSuccess:o,maxRetry:n,crawlCount:i,retryCount:i-1,errorQueue:a,data:f};return u&&u(m),m}));return s.delete(l),y(c)||g(c)&&Object.hasOwn(c,"requestConfigs")?p:p[0]}}function k(e){return async function(t,r){const{requestConfigs:o,intervalTime:n}=function(e,t){const r={requestConfigs:[]},o=[];if(g(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:i,intervalTime:s,maxRetry:a}=t;r.proxy=n,r.intervalTime=s,r.maxRetry=a,r.timeout=i,o.push(...T(e))}else{const e=T(t);o.push(...T(e))}return O(e,o,r),r}(e,t),i=(await q("data",e.mode,o,n,void 0,b)).map((e=>{const{id:t,isSuccess:o,maxRetry:n,crawlCount:i,errorQueue:s,crawlSingleRes:a}=e,c={id:t,isSuccess:o,maxRetry:n,crawlCount:i,retryCount:i-1,errorQueue:s,data:null};if(o&&a){const e=(a.headers["content-type"]??"").includes("text")?a.data.toString():JSON.parse(a.data.toString());c.data={...a,data:e}}return r&&r(c),c}));return y(t)||g(t)&&Object.hasOwn(t,"requestConfigs")?i:i[0]}}function P(o){return async function(n,i){const{requestConfigs:s,intervalTime:a,fileConfig:c}=function(e,t){const r={requestConfigs:[]},o=[];if(g(t)&&Object.hasOwn(t,"requestConfigs")){const{requestConfigs:e,proxy:n,timeout:i,intervalTime:s,maxRetry:a,fileConfig:c}=t;r.proxy=n,r.intervalTime=s,r.maxRetry=a,r.timeout=i,r.fileConfig=c,o.push(...T(e))}else o.push(...y(t)?t:[t]);return O(e,o,r),h(r.fileConfig?.storeDir)&&h(r.fileConfig?.extension)||r.requestConfigs.forEach((e=>{h(e.storeDir)&&!h(r.fileConfig?.storeDir)&&(e.storeDir=r.fileConfig.storeDir),h(e.extension)&&!h(r.fileConfig?.extension)&&(e.extension=r.fileConfig.extension)})),r}(o,n),l=await q("file",o.mode,s,a,void 0,b),p=[],d=[],w=l.map((o=>{const{id:n,isSuccess:s,maxRetry:a,crawlCount:u,errorQueue:l,crawlSingleRes:f,requestConfig:m}=o,g={id:n,isSuccess:s,maxRetry:a,crawlCount:u,retryCount:u-1,errorQueue:l,data:null};if(s&&f){const o=f.headers["content-type"]??"",s=m.fileName??`${n}-${(new Date).getTime()}`,a=m.extension??`.${o.split("/").pop()}`;h(m.storeDir)||e.existsSync(m.storeDir)||(y=m.storeDir,r.resolve(y).split(r.sep).reduce(((t,o,n)=>{const i=0!==n?r.join(t,o):o;return e.existsSync(i)||e.mkdirSync(i),i}),""));const u=m.storeDir??__dirname,l=r.resolve(u,s+a);let w=f.data;if(c?.beforeSave){const e=c.beforeSave({id:n,fileName:s,filePath:l,data:w});e&&(w=e)}const x=t.writeFile(l,w).catch((e=>{const t=`File save error at id ${n}: ${e.message}`;return d.push({message:t,valueOf:()=>n}),!0})).then((e=>{const t=f.data.length,r=!e;g.data={...f,data:{isSuccess:r,fileName:s,fileExtension:a,mimeType:o,size:t,filePath:l}},i&&i(g)}));p.push(x)}else i&&i(g);var y;return g}));var x;await Promise.all(p),(x=d,function e(t,r){if(t>=r)return;const o=x[r];let n=t,i=r-1;for(;n<=i;){for(;x[n]<o;)n++;for(;x[i]>o;)i--;n<=i&&(S(x,n,i),n++,i--)}S(x,n,r),e(t,n-1),e(n+1,r)}(0,x.length-1),x).forEach((e=>u(m(e.message))));const C=[],v=[];return w.forEach((e=>{e.data?.data.isSuccess?C.push(e.id):v.push(e.id)})),u("Save file final result:"),u(f(`  Success - total: ${C.length}, ids: [ ${C.join(" - ")} ]`)),u(m(`    Error - total: ${v.length}, ids: [ ${v.join(" - ")} ]`)),y(n)||g(n)&&Object.hasOwn(n,"requestConfigs")?w:w[0]}}function E(e,t){const{d:r,h:o,m:n}=e,i=(h(r)?0:1e3*r*60*60*24)+(h(o)?0:1e3*o*60*60)+(h(n)?0:1e3*n*60);let s=0;c();const a=setInterval(c,i);function c(){console.log(f(`Start the ${p.bold(++s)} polling`)),t(s,u)}function u(){clearInterval(a),console.log(f("Stop the polling"))}}const D=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),h(e?.timeout)&&(t.timeout=1e4),h(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:j(e),crawlData:k(e),crawlFile:P(e),startPolling:E}}(t)}({maxRetry:3,intervalTime:{max:3e3,min:2e3}});D.startPolling({d:1},(async(e,t)=>{const r=await D.crawlPage(["https://www.bilibili.com","https://www.bilibili.com/guochuang","https://www.bilibili.com/movie"]),o=[],n=[".carousel-inner img",".chief-recom-item img",".bg-item img"];for(const e of r){const{id:t}=e,{page:r}=e.data,i=await r.$$eval(n[t-1],(e=>e.map((e=>e.src))));o.push(...i),r.close()}await D.crawlFile({requestConfigs:o,fileConfig:{storeDir:"./upload"}})}));
