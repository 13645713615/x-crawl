"use strict";var e=require("node:path"),t=require("node:http"),o=require("node:fs"),r=require("node:url");function n(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function s(e){const{hostname:t,port:o,pathname:s,search:a}=new r.URL(e.url),i={hostname:t,port:o,path:s,search:n(a,e.params),method:e.method.toLocaleUpperCase(),headers:{}};return i.headers=function(e,t){let o;return o="POST"===t.method&&e.data?{...e.headers,"Content-Type":"application/json","Content-Length":Buffer.byteLength(e.data)}:e.headers,o}(e,i),i}function a(e){return new Promise((t=>setTimeout(t,e)))}function i(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=i(e,t)),o}function c(e){return new Promise(((o,r)=>{const n=e.data=JSON.stringify(e.data??""),a=s(e),i=t.request(a,(e=>{const t=[];e.on("data",(e=>t.push(e))),e.on("end",(()=>{const r=Buffer.concat(t),n={contentType:e.headers["content-type"],contentLength:e.headers["content-length"],data:r};o(n)}))}));i.on("timeout",(()=>{console.log("Timeout Error"),r(new Error("Timeout"))})),i.on("error",(e=>{console.log("Error: ",e.message),r(e)})),"POST"===a.method&&i.write(n),i.end()}))}(async function(e){const{requestConifg:t,intervalTime:o}=e;let r;if(Array.isArray(t)){r=[];for(const e of t){const t=await c(e);if(r.push(JSON.parse(t.data.toString())),void 0!==o){const e="number"==typeof o?o:i(o.max,o.min);await a(e)}}}else{const e=await c(t);r=JSON.parse(e.data.toString())}return r})({requestConifg:{url:"https://api.bilibili.com/x/web-interface/wbi/index/top/feed/rcmd",method:"GET",params:{y_num:5,fresh_type:3,feed_version:"V8",fresh_idx_1h:1,fetch_row:1,fresh_idx:1,brush:0,homepage_ver:1,ps:10,outside_trigger:"",w_rid:"2e4be8e9830ecd780c5b0ff2bef805c9",wts:1674556002},headers:{}}}).then((t=>{!async function(e){const{requestConifg:t,intervalTime:r,fileConfig:n}=e,s=Array.isArray(t)?t:[t],l=s.length;let u=0,d=0;await Promise.resolve(),console.log(`Start downloading, total: ${l} `);for(const e of s){u++;const t=await c(e),{contentType:s,data:f}=t,h=`${(new Date).getTime()}.${s?.split("/").pop()}`,m=`${n.storeDir}/${h}`;if(o.createWriteStream(m,"binary").write(f,(e=>{if(e)return console.log(`File save error requested for the ${u}: ${e.message}`);++d===l&&console.log("All files downloaded successfully!")})),void 0!==r&&u!==l){const e="number"==typeof r?r:i(r.max,r.min);console.log(`The ${u} request is success, sleep for ${e}ms`),await a(e)}else console.log(`The ${u} request is success`)}}({requestConifg:t.data.item.map((e=>({url:e.pic,method:"GET"}))),intervalTime:{max:3e3,min:2e3},fileConfig:{storeDir:e.resolve(__dirname,"./upload")}})}));
