"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),n=require("puppeteer"),o=require("chalk"),i=require("node:http"),a=require("node:https"),s=require("node:url"),l=require("https-proxy-agent"),c=require("sharp"),u=require("path");const f=console.log,p=o.hex("#a57fff"),g=o.green,h=o.red,m=o.yellow;function d(e){return void 0===e}function y(e){return"number"==typeof e}function w(e){return"object"==typeof e&&e&&!Array.isArray(e)}function C(e){return Array.isArray(e)}async function x(e,t,r,n){if(e&&n>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);f(`Id: ${p(n)} - Crawl needs to sleep for ${p(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else f(`Id: ${p(n)} - Crawl does not need to sleep, send immediately`)}async function S(e,t,r,n){const o=!d(t),i=y(t),a=[];for(const s of e){const{id:e}=s;await x(o,i,t,e),s.crawlCount++;const l=n(s,r).catch((e=>(s.errorQueue.push(e),!1))).then((e=>{!1!==e&&(s.isSuccess=!0,s.crawlSingleRes=e)}));a.push(l)}await Promise.all(a)}async function v(e,t,r,n){const o=!d(t),i=y(t);for(const a of e){const{id:e}=a;await x(o,i,t,e),a.crawlCount++;try{a.crawlSingleRes=await n(a,r),a.isSuccess=!0}catch(e){a.errorQueue.push(e)}}}function R(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function $(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=$(e.slice(0,t)),n=$(e.slice(t)),o=[];let i=0,a=0;for(;i<r.length&&a<n.length;)r[i]>=n[a]?(o.push(r[i]),i++):(o.push(n[a]),a++);return i<r.length&&o.push(...r.slice(i)),a<n.length&&o.push(...n.splice(a)),o}async function T(e,t,r,n,o,i){const a=(!r.every((e=>e.priority===r[0].priority))?$(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,crawlCount:0,errorQueue:[],crawlSingleConfig:e,crawlSingleRes:null})));f(`${g("Start crawling")} - name: ${m(e)}, mode: ${m(t)}, total: ${p(a.length)} `);const s="async"===t?S:v;let l=0,c=a;for(;c.length;)if(await s(c,n,o,i),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.crawlCount<=e.maxRetry)),c.length){const e=c.map((e=>e.id));f(m(`Retry: ${++l} - Ids to retry: [ ${e.join(" - ")} ]`))}const u=[],d=[];return a.forEach((e=>{e.isSuccess?u.push(e.id):d.push(e.id)})),f("Crawl the final result:"),f(g(`  Success - total: ${u.length}, ids: [ ${u.join(" - ")} ]`)),f(h(`    Error - total: ${d.length}, ids: [ ${d.join(" - ")} ]`)),a}function b(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function O(e){const{protocol:t,hostname:r,port:n,pathname:o,search:c}=new s.URL(e.url),u="http:"===t,f={agent:e.proxy?l(e.proxy):u?new i.Agent:new a.Agent,protocol:t,hostname:r,port:n,path:o,search:b(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,f),f}async function P(e){const{crawlSingleConfig:t}=e;return await(r=t,new Promise(((e,t)=>{const n=d(r.data);r.data=n?r.data:JSON.stringify(r.data);const o=O(r);function s(t){const{statusCode:r,headers:n}=t,o=[];t.on("data",(e=>o.push(e))),t.on("end",(()=>{const t=Buffer.concat(o);e({statusCode:r,headers:n,data:t})}))}let l;l="http:"===o.protocol?i.request(o,s):a.request(o,s),l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),"POST"!==o.method||n||l.write(r.data),l.end()})));var r}function j(e){return C(e)?e.map((e=>w(e)?e:{url:e})):[w(e)?e:{url:e}]}function D(e,t,r,n){t.forEach((t=>{let{url:o,timeout:i,proxy:a,maxRetry:s,priority:l}=t;d(e.baseUrl)||(o=e.baseUrl+o),d(i)&&(i=d(r.timeout)?e.timeout:r.timeout),d(a)&&(d(r.proxy)?d(e.proxy)||(a=e.proxy):a=r.proxy),d(s)&&(s=d(r.maxRetry)?e.maxRetry:r.maxRetry),d(l)&&(l=0),n.push({...t,url:o,timeout:i,proxy:a,maxRetry:s,priority:l})})),d(r.intervalTime)&&!d(e.intervalTime)&&(r.intervalTime=e.intervalTime)}function E(e){let t=null,r=null,o=!1,i=0;const a=new Map;async function s(e,r){const{id:n,crawlSingleConfig:o}=e,i=await t.newPage();await i.setViewport({width:1280,height:1024});let s=null;try{o.proxy?await t.createIncognitoBrowserContext({proxyServer:o.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),o.headers&&await i.setExtraHTTPHeaders(o.headers),o.cookies&&await i.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");r.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies)),s=await i.goto(o.url,{timeout:o.timeout})}catch(e){let t=a.get(r);throw t||(t=new Map,a.set(r,t)),t.get(n)||t.set(n,i),e}return{response:s,page:i}}return async function(l,c){const u=++i;o||(o=!0,r=n.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{crawlPageSingleConfigs:f,intervalTime:p}=function(e,t){const r={crawlPageSingleConfigs:[]},n=[];if(w(t)&&Object.hasOwn(t,"pageConfigs")){const{pageConfigs:e,proxy:o,timeout:i,cookies:a,intervalTime:s,maxRetry:l}=t;r.proxy=o,r.cookies=a,r.intervalTime=s,r.maxRetry=l,r.timeout=i,n.push(...j(e))}else{const e=j(t);n.push(...e)}return D(e,n,r,r.crawlPageSingleConfigs),d(r.cookies)||r.crawlPageSingleConfigs.forEach((e=>{const{cookies:t}=e;d(t)&&(e.cookies=r.cookies)})),r}(e,l),g=(await T("page",e.mode,f,p,u,s)).map((e=>{const{id:r,isSuccess:n,maxRetry:o,crawlCount:i,errorQueue:s,crawlSingleRes:l}=e;let f=null;if(n&&l)f={browser:t,...l};else{const e=a.get(u).get(r);f={browser:t,response:null,page:e}}const p={id:r,isSuccess:n,maxRetry:o,crawlCount:i,retryCount:i-1,errorQueue:s,data:f};return c&&c(p),p}));return a.delete(u),C(l)||w(l)&&Object.hasOwn(l,"pageConfigs")?g:g[0]}}function k(e){return async function(t,r){const{crawlDatatSingleConfigs:n,intervalTime:o}=function(e,t){const r={crawlDatatSingleConfigs:[]},n=[];if(w(t)&&Object.hasOwn(t,"dataConfigs")){const{dataConfigs:e,proxy:o,timeout:i,intervalTime:a,maxRetry:s}=t;r.proxy=o,r.intervalTime=a,r.maxRetry=s,r.timeout=i,n.push(...j(e))}else{const e=j(t);n.push(...j(e))}return D(e,n,r,r.crawlDatatSingleConfigs),r}(e,t),i=(await T("data",e.mode,n,o,void 0,P)).map((e=>{const{id:t,isSuccess:n,maxRetry:o,crawlCount:i,errorQueue:a,crawlSingleRes:s}=e,l={id:t,isSuccess:n,maxRetry:o,crawlCount:i,retryCount:i-1,errorQueue:a,data:null};if(n&&s){const e=(s.headers["content-type"]??"").includes("text")?s.data.toString():JSON.parse(s.data.toString());l.data={...s,data:e}}return r&&r(l),l}));return C(t)||w(t)&&Object.hasOwn(t,"dataConfigs")?i:i[0]}}function q(n){return async function(o,i){const{CrawlFileSingleConfigs:a,intervalTime:s,fileConfig:l}=function(e,t){const r={CrawlFileSingleConfigs:[]},n=[];if(w(t)&&Object.hasOwn(t,"fileConfigs")){const{fileConfigs:e,proxy:o,timeout:i,intervalTime:a,maxRetry:s,fileConfig:l}=t;r.proxy=o,r.intervalTime=a,r.maxRetry=s,r.timeout=i,r.fileConfig=l,n.push(...j(e))}else n.push(...C(t)?t:[t]);return D(e,n,r,r.CrawlFileSingleConfigs),d(r.fileConfig?.storeDir)&&d(r.fileConfig?.extension)||r.CrawlFileSingleConfigs.forEach((e=>{d(e.storeDir)&&!d(r.fileConfig?.storeDir)&&(e.storeDir=r.fileConfig.storeDir),d(e.extension)&&!d(r.fileConfig?.extension)&&(e.extension=r.fileConfig.extension)})),r}(n,o),c=await T("file",n.mode,a,s,void 0,P),u=[],p=[],m=c.map((n=>{const{id:o,isSuccess:a,maxRetry:s,crawlCount:c,errorQueue:f,crawlSingleRes:g,crawlSingleConfig:h}=n,m={id:o,isSuccess:a,maxRetry:s,crawlCount:c,retryCount:c-1,errorQueue:f,data:null};if(a&&g){const n=g.headers["content-type"]??"",a=h.fileName??`${o}-${(new Date).getTime()}`,s=h.extension??`.${n.split("/").pop()}`;d(h.storeDir)||e.existsSync(h.storeDir)||(y=h.storeDir,r.resolve(y).split(r.sep).reduce(((t,n,o)=>{const i=0!==o?r.join(t,n):n;return e.existsSync(i)||e.mkdirSync(i),i}),""));const c=h.storeDir??__dirname,f=r.resolve(c,a+s),w=g.data;let C=Promise.resolve(w);l?.beforeSave&&(C=l.beforeSave({id:o,fileName:a,filePath:f,data:w}));const x=C.then((async e=>{let r=!0;try{await t.writeFile(f,e)}catch(e){r=!1;const t=`File save error at id ${o}: ${e.message}`,n=()=>o;p.push({message:t,valueOf:n})}const l=e.length;m.data={...g,data:{isSuccess:r,fileName:a,fileExtension:s,mimeType:n,size:l,filePath:f}},i&&i(m)}));u.push(x)}else i&&i(m);var y;return m}));var y;await Promise.all(u),(y=p,function e(t,r){if(t>=r)return;const n=y[r];let o=t,i=r-1;for(;o<=i;){for(;y[o]<n;)o++;for(;y[i]>n;)i--;o<=i&&(R(y,o,i),o++,i--)}R(y,o,r),e(t,o-1),e(o+1,r)}(0,y.length-1),y).forEach((e=>f(h(e.message))));const x=[],S=[];return m.forEach((e=>{e.data?.data.isSuccess?x.push(e.id):S.push(e.id)})),f("Save file final result:"),f(g(`  Success - total: ${x.length}, ids: [ ${x.join(" - ")} ]`)),f(h(`    Error - total: ${S.length}, ids: [ ${S.join(" - ")} ]`)),C(o)||w(o)&&Object.hasOwn(o,"fileConfigs")?m:m[0]}}function A(e,t){const{d:r,h:n,m:o}=e,i=(d(r)?0:1e3*r*60*60*24)+(d(n)?0:1e3*n*60*60)+(d(o)?0:1e3*o*60);let a=0;l();const s=setInterval(l,i);function l(){console.log(g(`Start the ${m.bold(++a)} polling`)),t(a,c)}function c(){clearInterval(s),console.log(g("Stop the polling"))}}const M=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),d(e?.timeout)&&(t.timeout=1e4),d(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:E(e),crawlData:k(e),crawlFile:q(e),startPolling:A}}(t)}();M.crawlFile({fileConfigs:["https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area/4401.jpg"],proxy:"http://localhost:14892",fileConfig:{storeDir:u.resolve(__dirname,"./upload"),beforeSave:e=>c(e.data).resize(200).toBuffer()}}).then((async e=>{e.forEach((e=>{console.log(e.data?.data.isSuccess)}))}));
