"use strict";var e=require("node:path"),t=require("node:fs"),n=require("jsdom"),o=require("node:http"),s=require("https"),r=require("node:url"),a=require("chalk");const i=console.log,c=a.hex("#a57fff"),u=a.green,l=a.red;function h(e){return void 0===e}function f(e){return"number"==typeof e}function d(e){return Array.isArray(e)}function m(e,t){let n=e?`${e}`:"?";if(t)for(const e in t){n+=`&${e}=${t[e]}`}else n=e;return n}function g(e){const{protocol:t,hostname:n,port:a,pathname:i,search:c}=new r.URL(e.url),u={protocol:t,hostname:n,port:a,path:i,search:m(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(n["Content-Type"]="application/json",n["Content-Length"]=Buffer.byteLength(e.data)),n}(e,u),u.agent="http:"===t?new o.Agent:new s.Agent,u}async function p(e,t,n,o){if(e&&o>1){const e=t?n:function(e,t=0){let n=Math.floor(Math.random()*e);for(;n<t;)n=Math.floor(Math.random()*e);return n}(n.max,n.min);i(`Request ${c(o)} needs to sleep for ${c(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else i(`Request ${c(o)} does not need to sleep, send immediately`)}function y(e){return new Promise(((t,n)=>{const s=h(e.data);e.data=s?e.data:JSON.stringify(e.data);const r=g(e),a=o.request(r,(e=>{const{statusCode:n,headers:o}=e,s=[];e.on("data",(e=>s.push(e))),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:n,headers:o,data:e})}))}));a.on("timeout",(()=>{n(new Error(`Timeout ${e.timeout}ms`))})),a.on("error",(e=>{n(e)})),"POST"!==r.method||s||a.write(e.data),a.end()}))}const q=new class{baseConfig;constructor(e={}){this.baseConfig=e}mergeConfig(e){const t=this.baseConfig,n=structuredClone(e),o=d(n.requestConifg)?n.requestConifg:[n.requestConifg];for(const e of o){const{url:n,timeout:o}=e;h(t.baseUrl)||(e.url=t.baseUrl+n),h(o)&&(e.timeout=t.timeout)}return h(n.intervalTime)&&(n.intervalTime=t.intervalTime),n}async useBatchRequestByMode(e,t){const n=d(e)?e:[e];let o=[];return o="sync"!==this.baseConfig.mode?await async function(e,t){const n=!h(t),o=f(t);i(`Begin execution, mode: async, total: ${c(e.length)} `);const s=[];let r=0;for(const a of e){const e=++r;await p(n,o,t,e);const i=y(a).catch((t=>`Request ${e} is an error: ${t.message}`)).then((t=>"string"==typeof t?t:{id:e,...t}));s.push(i)}i(u("All requests have been sent!"));const a=await Promise.all(s),d=[],m=[];return a.forEach((e=>{if("string"==typeof e)return m.push(e);d.push(e)})),m.forEach((e=>i(l(e)))),i(`requestsTotal: ${c(e.length)}, success: ${u(d.length)}, error: ${l(m.length)}`),d}(n,t):await async function(e,t){const n=!h(t),o=f(t);i(`Begin execution, mode: sync, total: ${c(e.length)} `);let s=0,r=0,a=0;const d=[];for(const h of e){s++,await p(n,o,t,s);try{const e=await y(h);d.push({id:s,...e}),i(u(`Request ${c(s)} is an success`)),r++}catch(e){i(l(`Request ${s} is an error: ${e.message}`)),a++}}return i(u("All requests are over!")),i(`requestsTotal: ${c(e.length)}, success: ${u(r)}, error: ${l(a)}`),d}(n,t),o}async fetchHTML(e){const{requestConifg:t}=this.mergeConfig({requestConifg:(o=e,"string"==typeof o?{url:e}:e)});var o;const s=await y(t),r=s.data.toString();return{...s,data:{raw:r,jsdom:new n.JSDOM(r)}}}async fetchData(e){const{requestConifg:t,intervalTime:n}=this.mergeConfig(e),o=await this.useBatchRequestByMode(t,n),s=[];return o.forEach((e=>{const t=e.headers["content-type"]??"",n=e.data,o=t.includes("text")?n.toString():JSON.parse(n.toString());s.push({...e,data:o})})),s}async fetchFile(n){const{requestConifg:o,intervalTime:s,fileConfig:r}=this.mergeConfig(n),a=await this.useBatchRequestByMode(o,s),h=[];a.forEach((n=>{const{id:o,headers:s,data:a}=n,c=s["content-type"]??"",u=c.split("/").pop(),f=(new Date).getTime().toString(),d=e.resolve(r.storeDir,`${f}.${u}`);try{t.writeFileSync(d,a),h.push({...n,data:{fileName:f,mimeType:c,size:a.length,filePath:d}})}catch(e){i(l(`File save error at id ${o}: ${e.message}`))}}));const f=a.length,d=h.length,m=f-d;return i(`saveTotal: ${c(f)}, success: ${u(d)}, error: ${l(m)}`),h}}({timeout:1e4,intervalTime:{max:2e3,min:1e3},mode:"async"});q.fetchHTML({url:"https://www.bilibili.com/"}).then((t=>{const{jsdom:n}=t.data,o=n.window.document.querySelectorAll(".bili-video-card__cover"),s=[];o.forEach(((e,t)=>{const n=e.lastChild;t%2?s.push("https:"+n.src):s.push(n.src)})),console.log(s);const r=s.map((e=>({url:e})));q.fetchFile({requestConifg:r,fileConfig:{storeDir:e.resolve(__dirname,"./upload")}}).then((e=>{}))}));
