"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),a=require("chalk"),n=require("node:http"),i=require("node:https"),s=require("node:url"),l=require("https-proxy-agent");function c(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}const u=console.log,d=a.hex("#a57fff"),h=a.green,m=a.red,p=a.yellow;function g(e){return void 0===e}function f(e){return"number"==typeof e}function w(e){return"object"==typeof e&&e&&!Array.isArray(e)}function y(e){return Array.isArray(e)}async function v(e,t,r,o){if(e&&o>1){const e=t?r:c(r.max,r.min);u(`Id: ${d(o)} - Crawl needs to sleep for ${d(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else u(`Id: ${d(o)} - Crawl does not need to sleep, send immediately`)}async function T(e,t,r,o){const{intervalTime:a}=t,n=!g(a),i=f(a),s=[];for(const l of e){const{id:e}=l;await v(n,i,a,e);const c=r(l,t).catch((e=>(l.crawlErrorQueue.push(e),!1))).then((e=>{"boolean"!=typeof e?(l.isSuccess=!0,l.detailTargetRes=e,o(l,t)):l.retryCount===l.maxRetry&&o(l,t)}));s.push(c)}await Promise.all(s)}async function x(e,t,r,o){const{intervalTime:a}=t,n=!g(a),i=f(a);for(const s of e){const{id:e}=s;await v(n,i,a,e);try{s.detailTargetRes=await r(s,t),s.isSuccess=!0}catch(e){s.crawlErrorQueue.push(e)}(s.isSuccess||s.retryCount===s.maxRetry)&&o(s,t)}}function C(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function S(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=S(e.slice(0,t)),o=S(e.slice(t)),a=[];let n=0,i=0;for(;n<r.length&&i<o.length;)r[n]>=o[i]?(a.push(r[n]),n++):(a.push(o[i]),i++);return n<r.length&&a.push(...r.slice(n)),i<o.length&&a.push(...o.splice(i)),a}async function b(e,t,r,o,a,n){const i=(!r.every((e=>e.priority===r[0].priority))?S(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,retryCount:0,crawlErrorQueue:[],data:null,detailTarget:e,detailTargetRes:null})));u(`${h("Start crawling")} - name: ${p(e)}, mode: ${p(t)}, total: ${d(i.length)} `);const s="async"===t?T:x;let l=0,c=i;for(;c.length;)if(await s(c,o,a,n),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.retryCount<e.maxRetry)),c.length){const e=c.map((e=>(e.retryCount++,e.id)));u(p(`Retry: ${++l} - Ids to retry: [ ${e.join(" - ")} ]`))}const g=[],f=[];return i.forEach((e=>{e.isSuccess?g.push(e.id):f.push(e.id)})),u("Crawl the final result:"),u(h(`  Success - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),u(m(`    Error - total: ${f.length}, ids: [ ${f.join(" - ")} ]`)),i}function $(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function R(e){const{protocol:t,hostname:r,port:o,pathname:a,search:c}=new s.URL(e.url),u="http:"===t,d={agent:e.proxy?l(e.proxy):u?new n.Agent:new i.Agent,protocol:t,hostname:r,port:o,path:a,search:$(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return d.headers=function(e,t){const r={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,d),d}function P(e){return y(e)?e.map((e=>w(e)?e:{url:e})):[w(e)?e:{url:e}]}function O(e,t,r){r.detailTargets.forEach((r=>{const{url:o,timeout:a,proxy:n,maxRetry:i,priority:s,headers:l,fingerprint:u}=r;if(g(e.baseUrl)||(r.url=e.baseUrl+o),g(a)&&(g(t.timeout)?r.timeout=e.timeout:r.timeout=t.timeout),g(n)&&(g(t.proxy)?g(e.proxy)||(r.proxy=e.proxy):r.proxy=t.proxy),g(i)&&(g(t.maxRetry)?r.maxRetry=e.maxRetry:r.maxRetry=t.maxRetry),g(s)&&(r.priority=0),g(l)&&(r.headers=t.headers),u){const{userAgent:e,ua:t,platform:o,mobile:a,acceptLanguage:n}=u;let i=r.headers;i||(r.headers=i={}),e&&(i["user-agent"]=e),t&&(i["sec-ch-ua"]=t),o&&(i["sec-ch-platform"]=o),a&&(i["sec-ch-mobile"]=a),n&&(i["accept-language"]=n)}else if(g(u)&&t.fingerprint){const{userAgents:e,uas:o,platforms:a,mobiles:n,acceptLanguages:i}=t.fingerprint;let s=r.headers;s||(r.headers=s={}),e&&(s["user-agent"]=e[c(e.length)]),o&&(s["sec-ch-ua"]=o[c(o.length)]),a&&(s["sec-ch-platform"]=a[c(a.length)]),n&&(s["sec-ch-mobile"]=n[c(n.length)]),i&&(s["accept-language"]=i[c(i.length)])}})),r.intervalTime=t.intervalTime,g(t.intervalTime)&&!g(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}function E(e,t){const{maxWidth:r,minWidth:o,maxHeight:a,minHidth:n}=t,i=r===o?r:c(r,o),s=a===n?a:c(a,n),l=e.viewport;l?(l.width=i,l.height=s):e.viewport={width:i,height:s}}async function I(e,t){const{id:r,detailTarget:o}=e,{errorPageMap:a,browser:n}=t,i=await n.newPage();o.viewport&&await i.setViewport(o.viewport);let s=null;try{if(o.proxy?await n.createIncognitoBrowserContext({proxyServer:o.proxy}):await n.createIncognitoBrowserContext({proxyServer:void 0}),o.cookies){const e=function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies);await i.setCookie(...e)}else{const e=await i.cookies(o.url);await i.deleteCookie(...e)}o.headers&&await i.setExtraHTTPHeaders(o.headers),s=await i.goto(o.url,{timeout:o.timeout})}catch(e){throw a.get(r)||a.set(r,i),e}return{response:s,page:i}}async function k(e){const{detailTarget:t}=e;return await(r=t,new Promise(((e,t)=>{const o=g(r.data);r.data=o?r.data:JSON.stringify(r.data);const a=R(r);function s(t){const{statusCode:r,headers:o}=t,a=[];t.on("data",(e=>a.push(e))),t.on("end",(()=>{const t=Buffer.concat(a);e({statusCode:r,headers:o,data:t})}))}let l;l="http:"===a.protocol?n.request(a,s):i.request(a,s),l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),"POST"!==a.method||o||l.write(r.data),l.end()})));var r}function M(e,t){const{id:r,isSuccess:o,detailTargetRes:a}=e,{errorPageMap:n,browser:i,onCrawlItemComplete:s}=t;let l=null;if(o&&a)l={browser:i,...a};else{l={browser:i,response:null,page:n.get(r)}}e.data=l;const c=e;delete c.detailTarget,delete c.detailTargetRes,s&&s(c)}function A(o,a){const{id:n,isSuccess:i,detailTarget:s,detailTargetRes:l}=o,{saveFileErrorArr:c,saveFilePendingQueue:u,onCrawlItemComplete:d,onBeforeSaveFile:h}=a,m=o;if(delete m.detailTarget,delete m.detailTargetRes,i&&l){const a=l.headers["content-type"]??"",i=s.fileName??`${n}-${(new Date).getTime()}`,g=s.extension??`.${a.split("/").pop()}`;s.storeDir&&!e.existsSync(s.storeDir)&&(p=s.storeDir,r.resolve(p).split(r.sep).reduce(((t,o,a)=>{const n=0!==a?r.join(t,o):o;return e.existsSync(n)||e.mkdirSync(n),n}),""));const f=s.storeDir??__dirname,w=r.resolve(f,i+g),y=l.data;let v=Promise.resolve(y);h&&(v=h({id:n,fileName:i,filePath:w,data:y}));const T=v.then((async e=>{let r=!0;try{await t.writeFile(w,e)}catch(e){r=!1;const t=`File save error at id ${n}: ${e.message}`,o=()=>n;c.push({message:t,valueOf:o})}const s=e.length;o.data={...l,data:{isSuccess:r,fileName:i,fileExtension:g,mimeType:a,size:s,filePath:w}},d&&d(m)}));u.push(T)}else d&&d(m);var p}function F(e){let t=null,r=null,a=!1;return async function(n,i){a||(a=!0,r=o.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{detailTargets:s,intervalTime:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...P(e))}else{const e=P(t);r.detailTargets.push(...e)}return O(e,o,r),r.detailTargets.forEach((e=>{const{cookies:t,viewport:r,fingerprint:a}=e;g(t)&&o.cookies&&(e.cookies=o.cookies),g(r)&&o.viewport&&(e.viewport=o.viewport),a?E(e,a):g(a)&&o.fingerprint&&E(e,o.fingerprint)})),r}(e,n);u(s);const d={errorPageMap:new Map,browser:t,intervalTime:l,onCrawlItemComplete:c},h=await b("page",e.mode,s,d,I,M),m=y(n)||w(n)&&Object.hasOwn(n,"targets")?h:h[0];return i&&i(m),m}}function j(e){return async function(t,r){const{detailTargets:o,intervalTime:a,onCrawlItemComplete:n}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...P(e))}else{const e=P(t);r.detailTargets.push(...e)}return O(e,o,r),r}(e,t),i={intervalTime:a,onCrawlItemComplete:n},s=await b("data",e.mode,o,i,k,(function(e,t){const{isSuccess:r,detailTargetRes:o}=e,{onCrawlItemComplete:a}=t;if(r&&o){const t=(o.headers["content-type"]??"").includes("text")?o.data.toString():JSON.parse(o.data.toString());e.data={...o,data:t}}const n=e;delete n.detailTarget,delete n.detailTargetRes,a&&a(n)})),l=y(t)||w(t)&&Object.hasOwn(t,"targets")?s:s[0];return r&&r(l),l}}function W(e){return async function(t,r){const{detailTargets:o,intervalTime:a,onBeforeSaveFile:n,onCrawlItemComplete:i}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onBeforeSaveFile:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...P(e))}else r.detailTargets.push(...y(t)?t:[t]);O(e,o,r);const a=!g(o?.storeDir),n=!g(o?.extension);return r.detailTargets.forEach((e=>{g(e.storeDir)&&a&&(e.storeDir=o.storeDir),g(e.extension)&&n&&(e.extension=o.extension)})),r.onBeforeSaveFile=o.onBeforeSaveFile,r}(e,t),s={saveFileErrorArr:[],saveFilePendingQueue:[],intervalTime:a,onCrawlItemComplete:i,onBeforeSaveFile:n},l=await b("file",e.mode,o,s,k,A),{saveFilePendingQueue:c,saveFileErrorArr:d}=s;var p;await Promise.all(c),(p=d,function e(t,r){if(t>=r)return;const o=p[r];let a=t,n=r-1;for(;a<=n;){for(;p[a]<o;)a++;for(;p[n]>o;)n--;a<=n&&(C(p,a,n),a++,n--)}C(p,a,r),e(t,a-1),e(a+1,r)}(0,p.length-1),p).forEach((e=>u(m(e.message))));const f=[],v=[];l.forEach((e=>{e.data?.data.isSuccess?f.push(e.id):v.push(e.id)})),u("Save file final result:"),u(h(`  Success - total: ${f.length}, ids: [ ${f.join(" - ")} ]`)),u(m(`    Error - total: ${v.length}, ids: [ ${v.join(" - ")} ]`));const T=y(t)||w(t)&&Object.hasOwn(t,"targets")?l:l[0];return r&&r(T),T}}function q(e,t){const{d:r,h:o,m:a}=e,n=(g(r)?0:1e3*r*60*60*24)+(g(o)?0:1e3*o*60*60)+(g(a)?0:1e3*a*60);let i=0;l();const s=setInterval(l,n);function l(){console.log(h(`Start the ${p.bold(++i)} polling`)),t(i,c)}function c(){clearInterval(s),console.log(h("Stop the polling"))}}const B=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),g(e?.timeout)&&(t.timeout=1e4),g(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:F(e),crawlData:j(e),crawlFile:W(e),startPolling:q}}(t)}({intervalTime:{max:5e3,min:3e3}});B.crawlPage({targets:["https://github.com/coder-hxl",{url:"https://github.com/coder-hxl/x-crawl",fingerprint:null},{url:"https://github.com/coder-hxl/x-crawl/stargazers",fingerprint:{maxWidth:1980,minWidth:1980,maxHeight:1080,minHidth:1080,platform:"Android"}}],fingerprint:{maxWidth:1980,maxHeight:1080,userAgents:["Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0","Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36","Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0","Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1"],platforms:["Chromium OS","iOS","Linux","macOS","Windows"]}}).then((e=>{e.forEach(((e,t)=>{e.data.page.screenshot({path:`./img${t}.jpg`}).then((()=>{console.log(t,"success")}))}))}));
