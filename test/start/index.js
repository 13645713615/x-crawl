"use strict";var e=require("node:fs"),t=require("node:fs/promises"),n=require("node:path"),o=require("jsdom"),r=require("puppeteer"),s=require("node:http"),a=require("node:https"),i=require("node:url"),c=require("https-proxy-agent"),u=require("chalk");function l(e,t,n){const o=e[t];e[t]=e[n],e[n]=o}function f(e){return function t(n,o){if(n>=o)return;const r=e[o];let s=n,a=o-1;for(;s<=a;){for(;e[s]<r;)s++;for(;e[a]>r;)a--;s<=a&&(l(e,s,a),s++,a--)}l(e,s,o),t(n,s-1),t(s+1,o)}(0,e.length-1),e}const h=console.log,p=u.hex("#a57fff"),m=u.green,g=u.red,d=u.yellow;function w(e){return void 0===e}function y(e){return"number"==typeof e}function $(e){return Array.isArray(e)}function q(e,t){let n=e?`${e}`:"?";if(t)for(const e in t){n+=`&${e}=${t[e]}`}else n=e;return n}function v(e){const{protocol:t,hostname:n,port:o,pathname:r,search:u}=new i.URL(e.url),l="http:"===t,f={agent:e.proxy?c(e.proxy):l?new s.Agent:new a.Agent,protocol:t,hostname:n,port:o,path:r,search:q(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(n["Content-Type"]="application/json",n["Content-Length"]=Buffer.byteLength(e.data)),n}(e,f),f}function x(e){return new Promise(((t,n)=>{const o=w(e.data);e.data=o?e.data:JSON.stringify(e.data);const r=v(e);function i(e){const{statusCode:n,headers:o}=e,r=[];e.on("data",(e=>r.push(e))),e.on("end",(()=>{const e=Buffer.concat(r);t({statusCode:n,headers:o,data:e})}))}let c;c="http:"===r.protocol?s.request(r,i):a.request(r,i),c.on("timeout",(()=>{n(new Error(`Timeout ${e.timeout}ms`))})),c.on("error",(e=>{n(e)})),"POST"!==r.method||o||c.write(e.data),c.end()}))}async function T(e,t,n,o){if(e&&o>1){const e=t?n:function(e,t=0){let n=Math.floor(Math.random()*e);for(;n<t;)n=Math.floor(Math.random()*e);return n}(n.max,n.min);h(`Request ${p(o)} needs to sleep for ${p(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else h(`Request ${p(o)} does not need to sleep, send immediately`)}function b(e,t){const n=structuredClone(t),o=$(n.requestConfig)?n.requestConfig:[n.requestConfig],r=n.requestConfig=o.map((e=>"string"==typeof e?{url:e}:e));for(const t of r){const{url:n,timeout:o,proxy:r}=t;w(e.baseUrl)||(t.url=e.baseUrl+n),w(o)&&(t.timeout=e.timeout),w(r)&&(t.proxy=e.proxy)}return w(n.intervalTime)&&(n.intervalTime=e.intervalTime),n}async function C(e,t,n,o){"async"===e?await async function(e,t,n){const o=!w(t),r=y(t);h(`${m("Begin execution:")} mode: ${d("async")}, total: ${p(e.length)} `);let s=0,a=0,i=0;const c=[],u=[];for(const l of e){const e=++s;await T(o,r,t,e);const f=x(l).catch((t=>{i++;const n=`Request ${e} is an error: ${t.message}`;u.push({message:n,valueOf:()=>e})})).then((t=>{t&&(a++,n({id:e,...t}))}));c.push(f)}h(m("All requests have been sent!")),await Promise.all(c),f(u).forEach((e=>h(g(e.message)))),h(`requestsTotal: ${p(e.length)}, success: ${m(a)}, error: ${g(i)}`)}(t,n,o):await async function(e,t,n){const o=!w(t),r=y(t);h(`${m("Begin execution:")} mode: ${d("sync")}, total: ${p(e.length)}`);let s=0,a=0,i=0;for(const c of e){s++,await T(o,r,t,s);let e=!0,u=null;try{u={id:s,...await x(c)},h(m(`Request ${p(s)} is an success`)),a++}catch(t){e=!1,h(g(`Request ${s} is an error: ${t.message}`)),i++}e&&n&&n(u)}h(m("All requests are over!")),h(`requestsTotal: ${p(e.length)}, success: ${m(a)}, error: ${g(i)}`)}(t,n,o)}function P(e){let t=null,n=null,s=!1;return async function(a,i){s||(s=!0,n=r.launch().then((e=>{t=e}))),n&&(await Promise.all([n]),n=null);const c=await t.newPage();await c.setViewport({width:1280,height:1024});const{requestConfig:u}=b(e,{requestConfig:a}),l=u[0];l.proxy?await t.createIncognitoBrowserContext({proxyServer:l.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0});const f=await c.goto(l.url,{timeout:l.timeout}),h=await c.content(),p={httpResponse:f,browser:t,page:c,jsdom:new o.JSDOM(h)};return i&&i(p),p}}function S(e){return async function(t,n){const{requestConfig:o,intervalTime:r}=b(e,t),s=[];return await C(e.mode,o,r,(function(e){const t=e.headers["content-type"]??"",o=e.data,r=t.includes("text")?o.toString():JSON.parse(o.toString()),a={...e,data:r};n&&n(a),s.push(a)})),f(s.map((e=>({...e,valueOf:()=>e.id}))))}}function R(o){return async function(r,s){const{requestConfig:a,intervalTime:i,fileConfig:c}=b(o,r),u=[],l=[],d=[];e.existsSync(c.storeDir)||e.mkdirSync(c.storeDir),await C(o.mode,a,i,(function(e){const{id:o,headers:r,data:a}=e,i=r["content-type"]??"",f=c.extension??i.split("/").pop(),h=(new Date).getTime().toString(),p=n.resolve(c.storeDir,`${h}.${f}`),m=t.writeFile(p,a).catch((e=>{const t=`File save error at id ${o}: ${e.message}`;return d.push({message:t,valueOf:()=>o}),!0})).then((t=>{if(t)return;const n={...e,data:{fileName:h,mimeType:i,size:a.length,filePath:p}};s&&s(n),u.push(n)}));l.push(m)})),await Promise.all(l),f(d).forEach((e=>h(g(e.message))));const w=$(a)?a.length:1,y=u.length,q=w-y;return h(`saveFileTotal: ${p(w)}, success: ${m(y)}, error: ${g(q)}`),f(u.map((e=>({...e,valueOf:()=>e.id}))))}}function O(e,t){const{d:n,h:o,m:r}=e,s=(w(n)?0:1e3*n*60*60*24)+(w(o)?0:1e3*o*60*60)+(w(r)?0:1e3*r*60);let a=0;c();const i=setInterval(c,s);function c(){console.log(m(`Start the ${d.bold(++a)} polling`)),t(a,u)}function u(){clearInterval(i),console.log(m("Stop the polling"))}}function A(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),t}(e),n=function(e){return{crawlPage:P(e),crawlData:S(e),crawlFile:R(e),startPolling:O}}(t);return n}A({timeout:1e4,intervalTime:{max:3e3,min:1e3}});const M=A({timeout:1e4,intervalTime:{max:3e3,min:2e3}});M.crawlPage("https://www.bilibili.com/guochuang/").then((async e=>{const{httpResponse:t,browser:n,page:o}=e;console.log("status: ",t?.status())})),M.crawlPage("https://www.bilibili.com/guochuang/").then((async e=>{const{httpResponse:t,page:n}=e;console.log("status2: ",t?.status()),M.crawlPage("https://www.bilibili.com/guochuang/").then((async e=>{const{httpResponse:t,page:n}=e;console.log("status4: ",t?.status())}))})),M.crawlPage("https://www.bilibili.com/guochuang/").then((async e=>{const{httpResponse:t,page:n}=e;console.log("status3: ",t?.status())}));
