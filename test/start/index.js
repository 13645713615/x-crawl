"use strict";var e=require("node:fs"),t=require("node:fs/promises"),n=require("node:path"),r=require("puppeteer"),o=require("chalk"),a=require("node:http"),s=require("node:https"),i=require("node:url"),c=require("https-proxy-agent");function l(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function u(e){return function t(n,r){if(n>=r)return;const o=e[r];let a=n,s=r-1;for(;a<=s;){for(;e[a]<o;)a++;for(;e[s]>o;)s--;a<=s&&(l(e,a,s),a++,s--)}l(e,a,r),t(n,a-1),t(a+1,r)}(0,e.length-1),e}const f=console.log,m=o.hex("#a57fff"),p=o.green,d=o.red,h=o.yellow;function g(e){return void 0===e}function w(e){return"number"==typeof e}function y(e){return Array.isArray(e)}async function $(e,t,n,r){if(e&&r>1){const e=t?n:function(e,t=0){let n=Math.floor(Math.random()*e);for(;n<t;)n=Math.floor(Math.random()*e);return n}(n.max,n.min);f(`Crawl ${m(r)} needs to sleep for ${m(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else f(`Crawl ${m(r)} does not need to sleep, send immediately`)}async function C(e,t,n,r,o,a){"async"===t?await async function(e,t,n,r,o){const a=!g(n),s=w(n);f(`${p("Start crawling:")} name: ${h(e)}, mode: ${h("async")}, total: ${m(t.length)} `);let i=0,c=0,l=0;const y=[],C=[];for(const e of t){const t=++i;await $(a,s,n,t);const u=r(e).catch((e=>{l++;const n=`Crawl ${t} is an error: ${e.message}`;C.push({message:n,valueOf:()=>t})})).then((e=>{e&&(c++,o({id:t,...e}))}));y.push(u)}f(p("All crawls ended!")),await Promise.all(y),u(C).forEach((e=>f(d(e.message)))),f(`Total crawls: ${m(t.length)}, success: ${p(c)}, error: ${d(l)}`)}(e,n,r,o,a):await async function(e,t,n,r,o){const a=!g(n),s=w(n);f(`${p("Start crawling:")} name: ${h(e)}, mode: ${h("sync")}, total: ${m(t.length)}`);let i=0,c=0,l=0;for(const e of t){i++,await $(a,s,n,i);let t=!0,u=null;try{u={id:i,...await r(e)},f(p(`Crawl ${m(i)} is an success`)),c++}catch(e){t=!1,f(d(`Crawl ${i} is an error: ${e.message}`)),l++}t&&u&&o(u)}f(p("All crawls ended!")),f(`Total crawls: ${m(t.length)}, success: ${p(c)}, error: ${d(l)}`)}(e,n,r,o,a)}function v(e,t){let n=e?`${e}`:"?";if(t)for(const e in t){n+=`&${e}=${t[e]}`}else n=e;return n}function T(e){const{protocol:t,hostname:n,port:r,pathname:o,search:l}=new i.URL(e.url),u="http:"===t,f={agent:e.proxy?c(e.proxy):u?new a.Agent:new s.Agent,protocol:t,hostname:n,port:r,path:o,search:v(l,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const n={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(n["Content-Type"]="application/json",n["Content-Length"]=Buffer.byteLength(e.data)),n}(e,f),f}function x(e){return new Promise(((t,n)=>{const r=g(e.data);e.data=r?e.data:JSON.stringify(e.data);const o=T(e);function i(e){const{statusCode:n,headers:r}=e,o=[];e.on("data",(e=>o.push(e))),e.on("end",(()=>{const e=Buffer.concat(o);t({statusCode:n,headers:r,data:e})}))}let c;c="http:"===o.protocol?a.request(o,i):s.request(o,i),c.on("timeout",(()=>{n(new Error(`Timeout ${e.timeout}ms`))})),c.on("error",(e=>{n(e)})),"POST"!==o.method||r||c.write(e.data),c.end()}))}function q(e,t){const n=structuredClone(t),r=y(n.requestConfig)?n.requestConfig:[n.requestConfig];return n.requestConfig=r.map((t=>{const n="string"==typeof t?{url:t}:t;const{url:r,timeout:o,proxy:a}=n;return g(e.baseUrl)||(n.url=e.baseUrl+r),g(o)&&(n.timeout=e.timeout),g(a)&&(n.proxy=e.proxy),n})),g(n.intervalTime)&&(n.intervalTime=e.intervalTime),n}function S(e){let t=null,n=null,o=!1;async function a(e){const n=await t.newPage();await n.setViewport({width:1280,height:1024}),e.proxy?await t.createIncognitoBrowserContext({proxyServer:e.proxy}):await t.createIncognitoBrowserContext({proxyServer:void 0}),e.headers&&await n.setExtraHTTPHeaders(e.headers),e.cookies&&await n.setCookie(...function(e,t){const n=[];return"string"==typeof t?t.split("; ").forEach((t=>{const r=t.split("=");n.push({name:r[0],value:r[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),n.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),n.push(t)),n}(e.url,e.cookies));let r=null;try{r=await n.goto(e.url,{timeout:e.timeout})}catch(e){console.log(d(`Error: ${e.message}`))}return{httpResponse:r,browser:t,page:n}}return async function(s,i){o||(o=!0,n=r.launch().then((e=>{t=e}))),n&&(await Promise.all([n]),n=null);const{requestConfig:c,intervalTime:l}=q(e,{requestConfig:s}),f=[];return await C("page",e.mode,c,l,a,(e=>{i&&i(e),f.push(e)})),y(s)?u(f.map((e=>({...e,valueOf:()=>e.id})))):f[0]}}function P(e){return async function(t,n){const{requestConfig:r,intervalTime:o}=q(e,t),a=[];return await C("data",e.mode,r,o,x,(e=>{const t=e.headers["content-type"]??"",r=e.data,o=t.includes("text")?r.toString():JSON.parse(r.toString()),s={...e,data:o};n&&n(s),a.push(s)})),u(a.map((e=>({...e,valueOf:()=>e.id}))))}}function b(r){return async function(o,a){const{requestConfig:s,intervalTime:i,fileConfig:c}=q(r,o);e.existsSync(c.storeDir)||e.mkdirSync(c.storeDir);const l=[],h=[],g=[];await C("file",r.mode,s,i,x,(e=>{const{id:r,headers:o,data:s}=e,i=o["content-type"]??"",u=c.extension??i.split("/").pop(),f=(new Date).getTime().toString(),m=n.resolve(c.storeDir,`${f}.${u}`),p=t.writeFile(m,s).catch((e=>{const t=`File save error at id ${r}: ${e.message}`;return g.push({message:t,valueOf:()=>r}),!0})).then((t=>{if(t)return;const n={...e,data:{fileName:f,mimeType:i,size:s.length,filePath:m}};a&&a(n),l.push(n)}));h.push(p)})),await Promise.all(h),u(g).forEach((e=>f(d(e.message))));const w=y(s)?s.length:1,$=l.length,v=w-$;return f(`Total saved files: ${m(w)}, success: ${p($)}, error: ${d(v)}`),u(l.map((e=>({...e,valueOf:()=>e.id}))))}}function A(e,t){const{d:n,h:r,m:o}=e,a=(g(n)?0:1e3*n*60*60*24)+(g(r)?0:1e3*r*60*60)+(g(o)?0:1e3*o*60);let s=0;c();const i=setInterval(c,a);function c(){console.log(p(`Start the ${h.bold(++s)} polling`)),t(s,l)}function l(){clearInterval(i),console.log(p("Stop the polling"))}}function O(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),t}(e),n=function(e){return{crawlPage:S(e),crawlData:P(e),crawlFile:b(e),startPolling:A}}(t);return n}O({timeout:1e4,intervalTime:{max:3e3,min:1e3}});const E=O({timeout:1e4,intervalTime:{max:3e3,min:2e3}});E.startPolling({d:1},(async(e,t)=>{const{page:n}=await E.crawlPage("https://zh.airbnb.com/s/*/plus_homes"),r=await n.$$eval("picture img",(e=>e.map((e=>e.src))));E.crawlFile({requestConfig:r,fileConfig:{storeDir:"./upload"}}),n.close()}));
