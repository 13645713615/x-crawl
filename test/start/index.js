"use strict";var e=require("node:fs"),t=require("node:path"),o=require("jsdom"),n=require("node:http"),s=require("https"),r=require("node:url");function a(e,t=0){let o=Math.floor(Math.random()*e);return o<t&&(o=a(e,t)),o}function i(e){return void 0===e}function c(e){return"number"==typeof e}function u(e){return Array.isArray(e)}function l(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function h(e){const{protocol:t,hostname:o,port:a,pathname:i,search:c}=new r.URL(e.url),u={protocol:t,hostname:o,port:a,path:i,search:l(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,u),u.agent="http:"===t?new n.Agent:new s.Agent,u}async function d(e,t,o,n){if(e&&n>1){const e=t?o:a(o.max,o.min);console.log(`Request ${n} needs to sleep for ${e} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else console.log(`Request ${n} does not need to sleep, send immediately`)}function f(e){return new Promise(((t,o)=>{const s=i(e.data);e.data=s?e.data:JSON.stringify(e.data);const r=h(e),a=n.request(r,(e=>{const{statusCode:o,headers:n}=e,s=[];e.on("data",(e=>s.push(e))),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:o,headers:n,data:e})}))}));a.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),a.on("error",(e=>{o(e)})),"POST"!==r.method||s||a.write(e.data),a.end()}))}function m(e,t){const{baseUrl:o,timeout:n,intervalTime:s}=e,{requestConifg:r,intervalTime:a}=t,c=u(r)?r:[r];for(const e of c){const{url:t,timeout:s}=e;i(o)||(e.url=o+t),i(s)&&!i(n)&&(e.timeout=n)}return i(a)&&!i(s)&&(t.intervalTime=s),t}new class{baseConfig;constructor(e={}){this.baseConfig=e}async useBatchRequestByMode(e,t){const o=u(e)?e:[e];let n=[];return n="sync"!==this.baseConfig.mode?await async function(e,t){const o=!i(t),n=c(t);console.log(`Begin execution, mode: async, total: ${e.length} `);const s=[];let r=0;for(const a of e){const e=++r;await d(o,n,t,e);const i=f(a).catch((t=>`Request ${e} is an error: ${t.message}`)).then((t=>"string"==typeof t?t:{id:e,...t}));s.push(i)}console.log("All requests have been sent!");const a=await Promise.all(s),u=[],l=[];return a.forEach((e=>{if("string"==typeof e)return l.push(e);u.push(e)})),l.forEach((e=>{console.log(e)})),u}(o,t):await async function(e,t){const o=!i(t),n=c(t);console.log(`Begin execution, mode: sync, total: ${e.length} `);let s=0;const r=[];for(const a of e){s++,await d(o,n,t,s);try{const e=await f(a);r.push({id:s,...e}),console.log(`Request ${s} is an success`)}catch(e){console.log(`Request ${s} is an error: ${e.message}`)}}return console.log("All requests are over!"),r}(o,t),n}async fetchHTML(e){const t="string"==typeof e?{url:e}:e;const{requestConifg:n}=m(this.baseConfig,{requestConifg:t}),s=await f(n);return new o.JSDOM(s.data)}async fetchData(e){const{requestConifg:t,intervalTime:o}=m(this.baseConfig,e),n=await this.useBatchRequestByMode(t,o),s=[];return n.forEach((e=>{const t=e.headers["content-type"]??"",o=e.data,n=t.includes("text")?o.toString():JSON.parse(o.toString());s.push({...e,data:n})})),s}async fetchFile(o){const{requestConifg:n,intervalTime:s,fileConfig:r}=m(this.baseConfig,o),a=await this.useBatchRequestByMode(n,s);return new Promise((o=>{const n=[];a.forEach(((s,i)=>{const{id:c,statusCode:u,headers:l,data:h}=s,d=l["content-type"]??"",f=d.split("/").pop(),m=(new Date).getTime().toString(),g=t.resolve(r.storeDir,`${m}.${f}`);e.createWriteStream(g,"binary").write(h,(e=>{if(e)console.log(`File save error at id ${c}: ${e.message}`);else{const e={fileName:m,mimeType:d,size:h.length,filePath:g};n.push({id:c,statusCode:u,headers:l,data:e})}i===a.length-1&&o(n)}))}))}))}}({timeout:1e4,intervalTime:{max:3e3,min:2e3},mode:"sync"}).fetchData({requestConifg:[{url:"http://localhost:3001/home"},{url:"http://localhost:9001/api/home/wonderfulplace"},{url:"http://localhost:9001/api/home/goodprice"},{url:"http://localhost:3001/home"},{url:"http://localhost:9001/ai/home/goodprice"}]}).then((e=>{console.log(e)}));
