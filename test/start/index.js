"use strict";var e=require("node:path"),t=require("node:fs"),o=require("jsdom"),n=require("node:http"),s=require("node:https"),r=require("node:url"),a=require("https-proxy-agent"),i=require("chalk");const c=console.log,u=i.hex("#a57fff"),l=i.green,f=i.red,h=i.yellow;function d(e){return void 0===e}function m(e){return"number"==typeof e}function g(e){return Array.isArray(e)}function p(e,t,o){const n=e[t];e[t]=e[o],e[o]=n}function y(e){return function t(o,n){if(o>=n)return;const s=e[n];let r=o,a=n-1;for(;r<=a;){for(;e[r]<s;)r++;for(;e[a]>s;)a--;r<=a&&(p(e,r,a),r++,a--)}p(e,r,n),t(o,r-1),t(r+1,n)}(0,e.length-1),e}function q(e,t){let o=e?`${e}`:"?";if(t)for(const e in t){o+=`&${e}=${t[e]}`}else o=e;return o}function $(e){const{protocol:t,hostname:o,port:i,pathname:c,search:u}=new r.URL(e.url),l="http:"===t,f={agent:e.proxy?a(e.proxy):l?new n.Agent:new s.Agent,protocol:t,hostname:o,port:i,path:c,search:q(u,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return f.headers=function(e,t){const o={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(o["Content-Type"]="application/json",o["Content-Length"]=Buffer.byteLength(e.data)),o}(e,f),f}function w(e){return new Promise(((t,o)=>{const r=d(e.data);e.data=r?e.data:JSON.stringify(e.data);const a=$(e);function i(e){const{statusCode:o,headers:n}=e,s=[];e.on("data",(e=>s.push(e))),e.on("end",(()=>{const e=Buffer.concat(s);t({statusCode:o,headers:n,data:e})}))}let c;c="http:"===a.protocol?n.request(a,i):s.request(a,i),c.on("timeout",(()=>{o(new Error(`Timeout ${e.timeout}ms`))})),c.on("error",(e=>{o(e)})),"POST"!==a.method||r||c.write(e.data),c.end()}))}async function C(e,t,o,n){if(e&&n>1){const e=t?o:function(e,t=0){let o=Math.floor(Math.random()*e);for(;o<t;)o=Math.floor(Math.random()*e);return o}(o.max,o.min);c(`Request ${u(n)} needs to sleep for ${u(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else c(`Request ${u(n)} does not need to sleep, send immediately`)}const T=new class{baseConfig;constructor(e={}){this.baseConfig=e}mergeConfig(e){const t=this.baseConfig,o=structuredClone(e),n=g(o.requestConifg)?o.requestConifg:[o.requestConifg];for(const e of n){const{url:o,timeout:n,proxy:s}=e;d(t.baseUrl)||(e.url=t.baseUrl+o),d(n)&&(e.timeout=t.timeout),d(s)&&(e.proxy=t.proxy)}return d(o.intervalTime)&&(o.intervalTime=t.intervalTime),o}async useBatchRequestByMode(e,t,o){const n=g(e)?e:[e];"sync"!==this.baseConfig.mode?await async function(e,t,o){const n=!d(t),s=m(t);c(`Begin execution, mode: async, total: ${u(e.length)} `);let r=0,a=0,i=0;const h=[],g=[];for(const c of e){const e=++r;await C(n,s,t,e);const u=w(c).catch((t=>{i++;const o=`Request ${e} is an error: ${t.message}`;g.push({id:e,message:o,valueOf:()=>e})})).then((t=>{t&&(a++,o({id:e,...t}))}));h.push(u)}c(l("All requests have been sent!")),await Promise.all(h),y(g).forEach((e=>c(f(e.message)))),c(`requestsTotal: ${u(e.length)}, success: ${l(a)}, error: ${f(i)}`)}(n,t,o):await async function(e,t,o){const n=!d(t),s=m(t);c(`Begin execution, mode: sync, total: ${u(e.length)} `);let r=0,a=0,i=0;for(const h of e){r++,await C(n,s,t,r);let e=!0,d=null;try{d={id:r,...await w(h)},c(l(`Request ${u(r)} is an success`)),a++}catch(t){e=!1,c(f(`Request ${r} is an error: ${t.message}`)),i++}e&&o&&o(d)}c(l("All requests are over!")),c(`requestsTotal: ${u(e.length)}, success: ${l(a)}, error: ${f(i)}`)}(n,t,o)}async fetchHTML(e,t){const{requestConifg:n}=this.mergeConfig({requestConifg:(s=e,"string"==typeof s?{url:e}:e)});var s;const r=await w(n),a=r.data.toString(),i={...r,data:{html:a,jsdom:new o.JSDOM(a)}};return t&&t(i),i}async fetchData(e,t){const{requestConifg:o,intervalTime:n}=this.mergeConfig(e),s=[];await this.useBatchRequestByMode(o,n,(function(e){const o=e.headers["content-type"]??"",n=e.data,r=o.includes("text")?n.toString():JSON.parse(n.toString()),a={...e,data:r};t&&t(a),s.push(a)}));return y(s.map((e=>({...e,valueOf:()=>e.id}))))}async fetchFile(o,n){const{requestConifg:s,intervalTime:r,fileConfig:a}=this.mergeConfig(o),i=[];await this.useBatchRequestByMode(s,r,(function(o){const{id:s,headers:r,data:u}=o,l=r["content-type"]??"",h=a.extension??l.split("/").pop(),d=(new Date).getTime().toString(),m=e.resolve(a.storeDir,`${d}.${h}`);try{t.writeFileSync(m,u);const e={...o,data:{fileName:d,mimeType:l,size:u.length,filePath:m}};n&&n(e),i.push(e)}catch(e){c(f(`File save error at id ${s}: ${e.message}`))}}));const h=g(s)?s.length:1,d=i.length,m=h-d;c(`saveTotal: ${u(h)}, success: ${l(d)}, error: ${f(m)}`);return y(i.map((e=>({...e,valueOf:()=>e.id}))))}fetchPolling(e,t){const{Y:o,M:n,d:s,h:r,m:a}=e,i=(d(o)?0:1e3*o*60*60*24*365)+(d(n)?0:1e3*n*60*60*24*30)+(d(s)?0:1e3*s*60*60*24)+(d(r)?0:1e3*r*60*60)+(d(a)?0:1e3*a*60);let c=0;function u(){console.log(h(`Start the ${h.bold(++c)} polling`)),t(c)}u(),setInterval(u,i)}}({timeout:1e4,intervalTime:{max:0,min:0},mode:"async"});T.fetchHTML("https://www.bilibili.com/guochuang/",(e=>{console.log("fetchHTML Callback: ",e.statusCode)})).then((t=>{const{jsdom:o}=t.data,n=[];o.window.document.querySelectorAll(".chief-recom-item").forEach((e=>n.push(e.querySelector("img").src)));const s=n.map((e=>({url:`https:${e}`})));s.pop(),T.fetchFile({requestConifg:s,fileConfig:{storeDir:e.resolve(__dirname,"./upload")}},(e=>{console.log(e.id,e.statusCode,e.data.fileName)})).then((e=>console.log(e)))}));
