"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),a=require("chalk"),n=require("node:http"),s=require("node:https"),i=require("node:url"),l=require("https-proxy-agent"),c=require("sharp"),u=require("path");const d=console.log,p=a.hex("#a57fff"),m=a.green,h=a.red,f=a.yellow;function g(e){return void 0===e}function w(e){return"number"==typeof e}function y(e){return"object"==typeof e&&e&&!Array.isArray(e)}function T(e){return Array.isArray(e)}async function v(e,t,r,o){if(e&&o>1){const e=t?r:function(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}(r.max,r.min);d(`Id: ${p(o)} - Crawl needs to sleep for ${p(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else d(`Id: ${p(o)} - Crawl does not need to sleep, send immediately`)}async function C(e,t,r,o){const{intervalTime:a}=t,n=!g(a),s=w(a),i=[];for(const l of e){const{id:e}=l;await v(n,s,a,e),l.crawlCount++;const c=r(l,t).catch((e=>(l.errorQueue.push(e),!1))).then((e=>{!1!==e?(l.isSuccess=!0,l.detailTargetRes=e,o&&o(l,t)):o&&l.retryCount===l.maxRetry&&o(l,t)}));i.push(c)}await Promise.all(i)}async function x(e,t,r,o){const{intervalTime:a}=t,n=!g(a),s=w(a);for(const i of e){const{id:e}=i;await v(n,s,a,e),i.crawlCount++;try{i.detailTargetRes=await r(i,t),i.isSuccess=!0}catch(e){i.errorQueue.push(e)}(i.isSuccess||i.retryCount===i.maxRetry)&&o(i,t)}}function S(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function $(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=$(e.slice(0,t)),o=$(e.slice(t)),a=[];let n=0,s=0;for(;n<r.length&&s<o.length;)r[n]>=o[s]?(a.push(r[n]),n++):(a.push(o[s]),s++);return n<r.length&&a.push(...r.slice(n)),s<o.length&&a.push(...o.splice(s)),a}async function R(e,t,r,o,a,n){const s=(!r.every((e=>e.priority===r[0].priority))?$(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,crawlCount:0,retryCount:0,errorQueue:[],data:null,detailTarget:e,detailTargetRes:null})));d(`${m("Start crawling")} - name: ${f(e)}, mode: ${f(t)}, total: ${p(s.length)} `);const i="async"===t?C:x;let l=0,c=s;for(;c.length;)if(await i(c,o,a,n),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.retryCount<e.maxRetry)),c.length){const e=c.map((e=>(e.retryCount++,e.id)));d(f(`Retry: ${++l} - Ids to retry: [ ${e.join(" - ")} ]`))}const u=[],g=[];return s.forEach((e=>{e.isSuccess?u.push(e.id):g.push(e.id)})),d("Crawl the final result:"),d(m(`  Success - total: ${u.length}, ids: [ ${u.join(" - ")} ]`)),d(h(`    Error - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),s}function b(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function I(e){const{protocol:t,hostname:r,port:o,pathname:a,search:c}=new i.URL(e.url),u="http:"===t,d={agent:e.proxy?l(e.proxy):u?new n.Agent:new s.Agent,protocol:t,hostname:r,port:o,path:a,search:b(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return d.headers=function(e,t){const r={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,d),d}function j(e){return T(e)?e.map((e=>y(e)?e:{url:e})):[y(e)?e:{url:e}]}function O(e,t,r){r.detailTargets.forEach((r=>{const{url:o,timeout:a,proxy:n,maxRetry:s,priority:i,headers:l}=r;g(e.baseUrl)||(r.url=e.baseUrl+o),g(a)&&(g(t.timeout)?r.timeout=e.timeout:r.timeout=t.timeout),g(n)&&(g(t.proxy)?g(e.proxy)||(r.proxy=e.proxy):r.proxy=t.proxy),g(s)&&(g(t.maxRetry)?r.maxRetry=e.maxRetry:r.maxRetry=t.maxRetry),g(i)&&(r.priority=0),g(l)&&(r.headers=t.headers)})),r.intervalTime=t.intervalTime,g(t.intervalTime)&&!g(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}async function P(e,t){const{id:r,detailTarget:o}=e,{errorPageMap:a,browser:n}=t,s=await n.newPage();await s.setViewport({width:o.viewport?.width??1280,height:o.viewport?.width??1024});let i=null;try{o.proxy?await n.createIncognitoBrowserContext({proxyServer:o.proxy}):await n.createIncognitoBrowserContext({proxyServer:void 0}),o.headers&&await s.setExtraHTTPHeaders(o.headers),o.cookies&&await s.setCookie(...function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(o.url,o.cookies)),i=await s.goto(o.url,{timeout:o.timeout})}catch(e){throw a.get(r)||a.set(r,s),e}return{response:i,page:s}}async function E(e){const{detailTarget:t}=e;return await(r=t,new Promise(((e,t)=>{const o=g(r.data);r.data=o?r.data:JSON.stringify(r.data);const a=I(r);function i(t){const{statusCode:r,headers:o}=t,a=[];t.on("data",(e=>a.push(e))),t.on("end",(()=>{const t=Buffer.concat(a);e({statusCode:r,headers:o,data:t})}))}let l;l="http:"===a.protocol?n.request(a,i):s.request(a,i),l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),"POST"!==a.method||o||l.write(r.data),l.end()})));var r}function q(e,t){const{id:r,isSuccess:o,detailTargetRes:a}=e,{errorPageMap:n,browser:s,onCrawlItemComplete:i}=t;let l=null;if(o&&a)l={browser:s,...a};else{l={browser:s,response:null,page:n.get(r)}}e.data=l;const c=e;delete c.detailTarget,delete c.detailTargetRes,i&&i(c)}function k(e){let t=null,r=null,a=!1;return async function(n,s){a||(a=!0,r=o.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{detailTargets:i,intervalTime:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(y(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...j(e))}else{const e=j(t);r.detailTargets.push(...e)}O(e,o,r);const a=!g(o.cookies),n=!g(o.viewport);return r.detailTargets.forEach((e=>{const{cookies:t,viewport:r}=e;g(t)&&a&&(e.cookies=o.cookies),g(r)&&n&&(e.viewport=o.viewport)})),r}(e,n),u={errorPageMap:new Map,browser:t,intervalTime:l,onCrawlItemComplete:c},d=await R("page",e.mode,i,u,P,q),p=T(n)||y(n)&&Object.hasOwn(n,"targets")?d:d[0];return s&&s(p),p}}function B(e){return async function(t,r){const{detailTargets:o,intervalTime:a,onCrawlItemComplete:n}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(y(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...j(e))}else{const e=j(t);r.detailTargets.push(...e)}return O(e,o,r),r}(e,t),s={intervalTime:a,onCrawlItemComplete:n},i=await R("data",e.mode,o,s,E,(function(e,t){const{isSuccess:r,detailTargetRes:o}=e,{onCrawlItemComplete:a}=t;if(r&&o){const t=(o.headers["content-type"]??"").includes("text")?o.data.toString():JSON.parse(o.data.toString());e.data={...o,data:t}}const n=e;delete n.detailTarget,delete n.detailTargetRes,a&&a(n)})),l=T(t)||y(t)&&Object.hasOwn(t,"targets")?i:i[0];return r&&r(l),l}}function D(o){return async function(a,n){const{detailTargets:s,intervalTime:i,onBeforeSaveFile:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,onBeforeSaveFile:void 0,onCrawlItemComplete:void 0};let o={targets:[]};if(y(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,r.detailTargets.push(...j(e))}else{const e=j(t);r.detailTargets.push(...e)}O(e,o,r);const a=!g(o?.storeDir),n=!g(o?.extension);return r.detailTargets.forEach((e=>{g(e.storeDir)&&a&&(e.storeDir=o.storeDir),g(e.extension)&&n&&(e.extension=o.extension)})),r.onBeforeSaveFile=o.onBeforeSaveFile,r}(o,a),u=[],p=[],f={intervalTime:i,onCrawlItemComplete:c},w=await R("file",o.mode,s,f,E,(function(o,a){const{id:n,isSuccess:s,detailTarget:i,detailTargetRes:c}=o,{onCrawlItemComplete:d}=a,m=o;if(delete m.detailTarget,delete m.detailTargetRes,s&&c){const a=c.headers["content-type"]??"",s=i.fileName??`${n}-${(new Date).getTime()}`,f=i.extension??`.${a.split("/").pop()}`;g(i.storeDir)||e.existsSync(i.storeDir)||(h=i.storeDir,r.resolve(h).split(r.sep).reduce(((t,o,a)=>{const n=0!==a?r.join(t,o):o;return e.existsSync(n)||e.mkdirSync(n),n}),""));const w=i.storeDir??__dirname,y=r.resolve(w,s+f),T=c.data;let v=Promise.resolve(T);l&&(v=l({id:n,fileName:s,filePath:y,data:T}));const C=v.then((async e=>{let r=!0;try{await t.writeFile(y,e)}catch(e){r=!1;const t=`File save error at id ${n}: ${e.message}`,o=()=>n;p.push({message:t,valueOf:o})}const i=e.length;o.data={...c,data:{isSuccess:r,fileName:s,fileExtension:f,mimeType:a,size:i,filePath:y}},d&&d(m)}));u.push(C)}else d&&d(m);var h}));var v;await Promise.all(u),(v=p,function e(t,r){if(t>=r)return;const o=v[r];let a=t,n=r-1;for(;a<=n;){for(;v[a]<o;)a++;for(;v[n]>o;)n--;a<=n&&(S(v,a,n),a++,n--)}S(v,a,r),e(t,a-1),e(a+1,r)}(0,v.length-1),v).forEach((e=>d(h(e.message))));const C=[],x=[];w.forEach((e=>{e.data?.data.isSuccess?C.push(e.id):x.push(e.id)})),d("Save file final result:"),d(m(`  Success - total: ${C.length}, ids: [ ${C.join(" - ")} ]`)),d(h(`    Error - total: ${x.length}, ids: [ ${x.join(" - ")} ]`));const $=T(a)||y(a)&&Object.hasOwn(a,"targets")?w:w[0];return n&&n($),$}}function M(e,t){const{d:r,h:o,m:a}=e,n=(g(r)?0:1e3*r*60*60*24)+(g(o)?0:1e3*o*60*60)+(g(a)?0:1e3*a*60);let s=0;l();const i=setInterval(l,n);function l(){console.log(m(`Start the ${f.bold(++s)} polling`)),t(s,c)}function c(){clearInterval(i),console.log(m("Stop the polling"))}}const A=function(e){const t=function(e){const t=e||{};return t.mode||(t.mode="async"),g(e?.timeout)&&(t.timeout=1e4),g(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:k(e),crawlData:B(e),crawlFile:D(e),startPolling:M}}(t)}({baseUrl:"https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area",intervalTime:{max:5e3,min:3e3}});A.crawlFile({targets:["/4401.jpg","/4403.jpg","/4404.jpg","/4406.jpg","/4407.jpg"],proxy:"http://localhost:14892",storeDir:u.resolve(__dirname,"./upload"),onBeforeSaveFile:e=>c(e.data).resize(200).toBuffer(),onCrawlItemComplete(e){console.log(111,e)}}).then((async e=>{console.log(e),e.forEach((e=>{console.log(e.data?.data.isSuccess)}))}));
