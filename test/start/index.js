"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),n=require("puppeteer"),o=require("chalk"),a=require("node:http"),i=require("node:https"),s=require("node:url"),l=require("https-proxy-agent");function c(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}const m=console.log,u=o.hex("#a57fff"),d=o.green,p=o.red,h=o.yellow;function f(e){return void 0===e}function g(e){return"number"==typeof e}function w(e){return"object"==typeof e&&e&&!Array.isArray(e)}function x(e){return Array.isArray(e)}async function v(e,t,r,n){if(e&&n>1){const e=t?r:c(r.max,r.min);m(`Id: ${u(n)} - Crawl needs to sleep for ${u(e+"ms")} milliseconds before sending`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else m(`Id: ${u(n)} - Crawl does not need to sleep, send immediately`)}async function y(e,t,r,n){const{intervalTime:o}=t,a=!f(o),i=g(o),s=[];for(const l of e){const{id:e}=l;await v(a,i,o,e);const c=r(l,t).catch((e=>(l.crawlErrorQueue.push(e),!1))).then((e=>{"boolean"!=typeof e?(l.isSuccess=!0,l.detailTargetRes=e,n(l,t)):l.retryCount===l.maxRetry&&n(l,t)}));s.push(c)}await Promise.all(s)}async function T(e,t,r,n){const{intervalTime:o}=t,a=!f(o),i=g(o);for(const s of e){const{id:e}=s;await v(a,i,o,e);try{s.detailTargetRes=await r(s,t),s.isSuccess=!0}catch(e){s.crawlErrorQueue.push(e)}(s.isSuccess||s.retryCount===s.maxRetry)&&n(s,t)}}function C(e,t,r){const n=e[t];e[t]=e[r],e[r]=n}function M(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=M(e.slice(0,t)),n=M(e.slice(t)),o=[];let a=0,i=0;for(;a<r.length&&i<n.length;)r[a]>=n[i]?(o.push(r[a]),a++):(o.push(n[i]),i++);return a<r.length&&o.push(...r.slice(a)),i<n.length&&o.push(...n.splice(i)),o}async function S(e,t,r,n,o,a){const i=(!r.every((e=>e.priority===r[0].priority))?M(r.map((e=>({...e,valueOf:()=>e.priority})))):r).map(((e,t)=>({id:t+1,isSuccess:!1,maxRetry:e.maxRetry,retryCount:0,crawlErrorQueue:[],data:null,detailTarget:e,detailTargetRes:null})));m(`${d("Start crawling")} - name: ${h(e)}, mode: ${h(t)}, total: ${u(i.length)} `);const s="async"===t?y:T;let l=0,c=i;for(;c.length;)if(await s(c,n,o,a),c=c.filter((e=>e.maxRetry&&!e.isSuccess&&e.retryCount<e.maxRetry)),c.length){const e=c.map((e=>(e.retryCount++,e.id)));m(h(`Retry: ${++l} - Ids to retry: [ ${e.join(" - ")} ]`))}const f=[],g=[];return i.forEach((e=>{e.isSuccess?f.push(e.id):g.push(e.id)})),m("Crawl the final result:"),m(d(`  Success - total: ${f.length}, ids: [ ${f.join(" - ")} ]`)),m(p(`    Error - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),i}function V(e,t){let r=e?`${e}`:"?";if(t)for(const e in t){r+=`&${e}=${t[e]}`}else r=e;return r}function b(e){const{protocol:t,hostname:r,port:n,pathname:o,search:c}=new s.URL(e.url),m="http:"===t,u={agent:e.proxy?l(e.proxy):m?new a.Agent:new i.Agent,protocol:t,hostname:r,port:n,path:o,search:V(c,e.params),method:e.method?.toLocaleUpperCase()??"GET",headers:{},timeout:e.timeout};return u.headers=function(e,t){const r={"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",...e.headers??{}};return"POST"===t.method&&e.data&&(r["Content-Type"]="application/json",r["Content-Length"]=Buffer.byteLength(e.data)),r}(e,u),u}const P=[{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",versions:[{name:"Chrome",maxMajorVersion:112,minMajorVersion:100,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59",versions:[{name:"Chrome",maxMajorVersion:91,minMajorVersion:88,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333},{name:"Edg",maxMinorVersion:10,maxPatchVersion:864}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0",versions:[{name:"Firefox",maxMajorVersion:47,minMajorVersion:43,maxMinorVersion:10,maxPatchVersion:5e3}]}}];function j(e){return x(e)?e.map((e=>w(e)?e:{url:e})):[w(e)?e:{url:e}]}function I(e,t){const{ua:r,platform:n,platformVersion:o,mobile:a,acceptLanguage:i,userAgent:s}=t;let l=e.headers;if(l||(e.headers=l={}),r&&(l["sec-ch-ua"]=r),a&&(l["sec-ch-ua-mobile"]="random"===a?c(2)?"?1":"?0":a),n&&(l["sec-ch-platform"]=n),o&&(l["sec-ch-ua-platform-version"]=o),i&&(l["accept-language"]=i),s){let e=s.value;s.versions?.forEach((t=>{const{name:r,maxMajorVersion:n,minMajorVersion:o,maxMinorVersion:a,minMinorVersion:i,maxPatchVersion:s,minPatchVersion:l}=t,m=e.split(`${r}/`)[1].split(" ")[0].split("."),u=m.join(".");f(n)||(m[0]=n===o?n:c(n,o)),f(a)||(m[1]=a===i?a:c(a,i)),f(s)||(m[2]=s===l?s:c(s,l));const d=`${r}/${u}`,p=`${r}/${m.join(".")}`;e=e.replace(d,p)})),l["user-agent"]=e}}function $(e,t){const{maxWidth:r,minWidth:n,maxHeight:o,minHidth:a}=t,i=e.viewport??{};r&&(i.width=r===n?r:c(r,n)),o&&(i.height=o===a?o:c(o,a)),Object.hasOwn(i,"width")&&Object.hasOwn(i,"height")&&(e.viewport=i)}function R(e,t,r){r.detailTargets.forEach((n=>{const{url:o,timeout:a,proxy:i,maxRetry:s,priority:l,headers:m,fingerprint:u}=n;if(f(e.baseUrl)||(n.url=e.baseUrl+o),f(a)&&(f(t.timeout)?n.timeout=e.timeout:n.timeout=t.timeout),f(i)&&(f(t.proxy)?f(e.proxy)||(n.proxy=e.proxy):n.proxy=t.proxy),f(s)&&(f(t.maxRetry)?n.maxRetry=e.maxRetry:n.maxRetry=t.maxRetry),f(l)&&(n.priority=0),f(m)&&t.headers&&(n.headers={...t.headers}),u)I(n,u);else if(f(u)&&x(t.fingerprints)&&t.fingerprints.length){const e=t.fingerprints,o=c(e.length),a=e[o];r.selectFingerprintIndexs.push(o),I(n,a)}else if(f(u)&&!x(t.fingerprints)&&e.enableRandomFingerprint){I(n,P[c(P.length)])}})),r.intervalTime=t.intervalTime,f(t.intervalTime)&&!f(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}async function E(e,t){const{id:r,detailTarget:n}=e,{errorPageMap:o,browser:a}=t,i=await a.newPage();n.viewport&&await i.setViewport(n.viewport);let s=null;try{if(n.proxy?await a.createIncognitoBrowserContext({proxyServer:n.proxy}):await a.createIncognitoBrowserContext({proxyServer:void 0}),n.cookies){const e=function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const n=t.split("=");r.push({name:n[0],value:n[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(n.url,n.cookies);await i.setCookie(...e)}else{const e=await i.cookies(n.url);await i.deleteCookie(...e)}n.headers&&await i.setExtraHTTPHeaders(n.headers),s=await i.goto(n.url,{timeout:n.timeout})}catch(e){throw o.get(r)||o.set(r,i),e}return{response:s,page:i}}async function F(e){const{detailTarget:t}=e;return await(r=t,new Promise(((e,t)=>{const n=f(r.data);r.data=n?r.data:JSON.stringify(r.data);const o=b(r);function s(t){const{statusCode:r,headers:n}=t,o=[];t.on("data",(e=>o.push(e))),t.on("end",(()=>{const t=Buffer.concat(o);e({statusCode:r,headers:n,data:t})}))}let l;l="http:"===o.protocol?a.request(o,s):i.request(o,s),l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),"POST"!==o.method||n||l.write(r.data),l.end()})));var r}function W(e,t){const{id:r,isSuccess:n,detailTargetRes:o}=e,{errorPageMap:a,browser:i,onCrawlItemComplete:s}=t;let l=null;if(n&&o)l={browser:i,...o};else{l={browser:i,response:null,page:a.get(r)}}e.data=l;const c=e;delete c.detailTarget,delete c.detailTargetRes,s&&s(c)}function k(n,o){const{id:a,isSuccess:i,detailTarget:s,detailTargetRes:l}=n,{saveFileErrorArr:c,saveFilePendingQueue:m,onCrawlItemComplete:u,onBeforeSaveItemFile:d}=o,p=n;if(delete p.detailTarget,delete p.detailTargetRes,i&&l){const o=l.headers["content-type"]??"",i=s.fileName??`${a}-${(new Date).getTime()}`,f=s.extension??`.${o.split("/").pop()}`;s.storeDir&&!e.existsSync(s.storeDir)&&(h=s.storeDir,r.resolve(h).split(r.sep).reduce(((t,n,o)=>{const a=0!==o?r.join(t,n):n;return e.existsSync(a)||e.mkdirSync(a),a}),""));const g=s.storeDir??__dirname,w=r.resolve(g,i+f),x=l.data;let v=Promise.resolve(x);d&&(v=d({id:a,fileName:i,filePath:w,data:x}));const y=v.then((async e=>{let r=!0;try{await t.writeFile(w,e)}catch(e){r=!1;const t=`File save error at id ${a}: ${e.message}`,n=()=>a;c.push({message:t,valueOf:n})}const s=e.length;n.data={...l,data:{isSuccess:r,fileName:i,fileExtension:f,mimeType:o,size:s,filePath:w}},u&&u(p)}));m.push(y)}else u&&u(p);var h}function A(e){let t=null,r=null,o=!1;return async function(a,i){o||(o=!0,r=n.launch(e.crawlPage?.launchBrowser).then((e=>{t=e}))),r&&(await r,r&&(r=null));const{detailTargets:s,intervalTime:l,onCrawlItemComplete:c}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let n={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,r.detailTargets.push(...j(e))}else{const e=j(t);r.detailTargets.push(...e)}return R(e,n,r),r.detailTargets.forEach(((e,t)=>{const{cookies:o,viewport:a,fingerprint:i}=e;if(f(o)&&n.cookies&&(e.cookies=n.cookies),f(a)&&n.viewport&&(e.viewport=n.viewport),i)$(e,i);else if(f(i)&&n.fingerprints?.length){const o=r.selectFingerprintIndexs[t];$(e,n.fingerprints[o])}})),r}(e,a);m("detailTargets",s);const u={errorPageMap:new Map,browser:t,intervalTime:l,onCrawlItemComplete:c},d=await S("page",e.mode,s,u,E,W),p=x(a)||w(a)&&Object.hasOwn(a,"targets")?d:d[0];return i&&i(p),p}}function O(e){return async function(t,r){const{detailTargets:n,intervalTime:o,onCrawlItemComplete:a}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let n={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,r.detailTargets.push(...j(e))}else{const e=j(t);r.detailTargets.push(...e)}return R(e,n,r),r}(e,t),i={intervalTime:o,onCrawlItemComplete:a},s=await S("data",e.mode,n,i,F,(function(e,t){const{isSuccess:r,detailTargetRes:n}=e,{onCrawlItemComplete:o}=t;if(r&&n){const t=(n.headers["content-type"]??"").includes("text")?n.data.toString():JSON.parse(n.data.toString());e.data={...n,data:t}}const a=e;delete a.detailTarget,delete a.detailTargetRes,o&&o(a)})),l=x(t)||w(t)&&Object.hasOwn(t,"targets")?s:s[0];return r&&r(l),l}}function q(e){return async function(t,r){const{detailTargets:n,intervalTime:o,onBeforeSaveItemFile:a,onCrawlItemComplete:i}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onBeforeSaveItemFile:void 0,onCrawlItemComplete:void 0};let n={targets:[]};if(w(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;n=t,r.detailTargets.push(...j(e))}else r.detailTargets.push(...x(t)?t:[t]);R(e,n,r);const o=!f(n?.storeDir),a=!f(n?.extension);return r.detailTargets.forEach((e=>{f(e.storeDir)&&o&&(e.storeDir=n.storeDir),f(e.extension)&&a&&(e.extension=n.extension)})),r.onBeforeSaveItemFile=n.onBeforeSaveItemFile,r}(e,t),s={saveFileErrorArr:[],saveFilePendingQueue:[],intervalTime:o,onCrawlItemComplete:i,onBeforeSaveItemFile:a},l=await S("file",e.mode,n,s,F,k),{saveFilePendingQueue:c,saveFileErrorArr:u}=s;var h;await Promise.all(c),(h=u,function e(t,r){if(t>=r)return;const n=h[r];let o=t,a=r-1;for(;o<=a;){for(;h[o]<n;)o++;for(;h[a]>n;)a--;o<=a&&(C(h,o,a),o++,a--)}C(h,o,r),e(t,o-1),e(o+1,r)}(0,h.length-1),h).forEach((e=>m(p(e.message))));const g=[],v=[];l.forEach((e=>{e.data?.data.isSuccess?g.push(e.id):v.push(e.id)})),m("Save file final result:"),m(d(`  Success - total: ${g.length}, ids: [ ${g.join(" - ")} ]`)),m(p(`    Error - total: ${v.length}, ids: [ ${v.join(" - ")} ]`));const y=x(t)||w(t)&&Object.hasOwn(t,"targets")?l:l[0];return r&&r(y),y}}function B(e,t){const{d:r,h:n,m:o}=e,a=(f(r)?0:1e3*r*60*60*24)+(f(n)?0:1e3*n*60*60)+(f(o)?0:1e3*o*60);let i=0;l();const s=setInterval(l,a);function l(){console.log(d(`Start the ${h.bold(++i)} polling`)),t(i,c)}function c(){clearInterval(s),console.log(d("Stop the polling"))}}const N=function(e){const t=function(e){const t=e||{};return f(t.mode)&&(t.mode="async"),f(t.enableRandomFingerprint)&&(t.enableRandomFingerprint=!0),f(e?.timeout)&&(t.timeout=1e4),f(e?.maxRetry)&&(t.maxRetry=0),t}(e);return function(e){return{crawlPage:A(e),crawlData:O(e),crawlFile:q(e),startPolling:B}}(t)}({intervalTime:{max:5e3,min:3e3}});N.crawlPage({targets:["https://github.com/coder-hxl",{url:"https://github.com/coder-hxl/x-crawl",fingerprint:null},{url:"https://github.com/coder-hxl/x-crawl/stargazers",fingerprint:{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59",versions:[{name:"Chrome",maxMajorVersion:91,minMajorVersion:88,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333},{name:"Edg",maxMinorVersion:10,maxPatchVersion:864}]}}}],fingerprints:[{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",versions:[{name:"Chrome",maxMajorVersion:112,minMajorVersion:100,maxMinorVersion:20,maxPatchVersion:5e3},{name:"Safari",maxMajorVersion:537,minMajorVersion:500,maxMinorVersion:36,maxPatchVersion:5e3}]}}]});
