"use strict";var e=require("node:fs"),t=require("node:fs/promises"),r=require("node:path"),o=require("puppeteer"),n=require("chalk"),a=require("node:http"),i=require("node:https"),s=require("node:url"),l=require("node:querystring"),c=require("https-proxy-agent");function u(e,t=0){let r=Math.floor(Math.random()*e);for(;r<t;)r=Math.floor(Math.random()*e);return r}const m=console.log,g=n.blueBright,p=n.whiteBright,d=n.green,f=n.red,h=n.yellow,y=n.hex("#a57fff"),w=n.white.bold;function x(e){return void 0===e}function C(e){return"number"==typeof e}function v(e){return"string"==typeof e}function T(e){return"object"==typeof e&&e&&!Array.isArray(e)}function $(e){return Array.isArray(e)}async function b(e,t,r,o,n){const{serialNumber:a,logConfig:i}=n;if(e&&o>1){const e=t?r:u(r.max,r.min);i.process&&m(`${w(a)} | Target id: ${y(o)} - Sleep time: ${y(e+"ms")}`),await function(e){return new Promise((t=>setTimeout(t,e)))}(e)}else i.process&&m(`${w(a)} | Target id: ${y(o)} - Sleep time: ${y("0ms")}`)}async function S(e,t,r){const{intervalTime:o}=t,n=!x(o),a=C(o),i=[];for(const s of e){const{id:e}=s;await b(n,a,o,e,t),i.push(r(s,t))}await Promise.all(i)}async function j(e,t,r){const{intervalTime:o}=t,n=!x(o),a=C(o);for(const i of e){const{id:e}=i;await b(n,a,o,e,t),await r(i,t)}}function I(e,t,r){const o=e[t];e[t]=e[r],e[r]=o}function M(e){if(1===e.length)return e;const t=Math.floor(e.length/2),r=M(e.slice(0,t)),o=M(e.slice(t)),n=[];let a=0,i=0;for(;a<r.length&&i<o.length;)r[a]>=o[i]?(n.push(r[a]),a++):(n.push(o[i]),i++);return a<r.length&&n.push(...r.slice(a)),i<o.length&&n.push(...o.splice(i)),n}function E(e){const{detailTargetConfig:t,detailTargetResult:r}=e;let o=null;if(T(r)&&Object.hasOwn(r,"response")&&r.response){o=r.response.status()}else T(r)&&(o=r.statusCode??null);let n=!1;const a=t.proxy?.switchByHttpStatus;return o&&a&&a.includes(o)&&(n=!0),n}async function O(e,t,r){const{serialNumber:o,mode:n,logConfig:a}=t,i=(!e.every((t=>t.priority===e[0].priority))?M(e.map((e=>({...e,valueOf:()=>e.priority})))):e).map(((e,t)=>{const r=++t,{maxRetry:o,proxyDetails:n}=e,a=[];return{id:r,isHandle:!1,isSuccess:!1,isStatusNormal:!1,detailTargetConfig:e,detailTargetResult:null,maxRetry:o,retryCount:0,proxyDetails:n,crawlErrorQueue:a,result:{id:r,isSuccess:!1,maxRetry:o,retryCount:0,proxyDetails:n,crawlErrorQueue:a,data:null}}}));a.start&&m(`${w(o)} | ${g(`Start crawling - mode: ${n}, total: ${i.length}`)}`);const s="async"===n?S:j;let l=0,c=i;for(;c.length;)if(await s(c,t,r),c=c.filter((e=>{const{isHandle:t,retryCount:r,maxRetry:o,detailTargetConfig:n,proxyDetails:a,crawlErrorQueue:i,isStatusNormal:s}=e;let l=!1;if(!t&&r<o&&(l=!0,a.length>=2)){const e=n.proxy?.switchByErrorCount;if(!s||!x(e)&&e>=i.length){a.find((e=>e.url===n.proxyUrl)).state=!1;const e=a.find((e=>e.state))?.url;x(e)||(n.proxyUrl=e)}}return l})),c.length){const e=c.map((e=>(e.retryCount++,e.id)));a.process&&m(`${w(o)} | ${h(`Start retrying - count: ${++l}, targets id: [ ${e.join(", ")}`)}`)}if(a.result){const e=[],t=[];i.forEach((r=>{r.isSuccess?e.push(r.id):t.push(r.id)})),m(`${w(o)} | ${p("Crawl finish:")}\n             ${d(`Success - total: ${e.length}, targets id: [ ${e.join(", ")} ]`)}\n               ${f(`Error - total: ${t.length}, targets id: [ ${t.join(", ")} ]`)}`)}return i.map((e=>e.result))}function F(e){const{data:t,url:r,params:o,proxyUrl:n,timeout:u,method:m}=e,{protocol:g,hostname:p,port:d,pathname:f,search:h}=new s.URL(r);let y=f;(h||o)&&(y+=h?`${h}${o?"&"+l.stringify(o):""}`:`?${l.stringify(o)}`);const w={requestConfig:{agent:n?new c.HttpsProxyAgent(n):"http:"===g?new a.Agent:new i.Agent,protocol:g,hostname:p,port:d,path:y,method:m?.toLocaleUpperCase()??"GET",headers:{},timeout:u},protocol:g,data:T(t)?JSON.stringify(t):t};return function(e,t){const r=e.headers??{},{requestConfig:o,data:n}=t,a={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36",...r};x(n)||[{key:"Content-Type",value:"application/json"},{key:"Content-Length",value:Buffer.byteLength(n)}].forEach((e=>{const{key:t,value:o}=e;x(r[t])&&(a[t]=o)}));o.headers=a}(e,w),w}const R=[{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.0.0 Safari/537.36",versions:[{name:"Chrome",maxMajorVersion:112,minMajorVersion:100,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59",versions:[{name:"Chrome",maxMajorVersion:91,minMajorVersion:88,maxMinorVersion:10,maxPatchVersion:5615},{name:"Safari",maxMinorVersion:36,maxPatchVersion:2333},{name:"Edg",maxMinorVersion:10,maxPatchVersion:864}]}},{platform:"Windows",mobile:"random",userAgent:{value:"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0",versions:[{name:"Firefox",maxMajorVersion:47,minMajorVersion:43,maxMinorVersion:10,maxPatchVersion:5e3}]}}];function P(e){return $(e)?e.map((e=>T(e)?e:{url:e})):[T(e)?e:{url:e}]}function V(e,t){const{ua:r,platform:o,platformVersion:n,mobile:a,acceptLanguage:i,userAgent:s}=t;let l=e.headers;if(l||(e.headers=l={}),r&&(l["sec-ch-ua"]=r),a&&(l["sec-ch-ua-mobile"]="random"===a?u(2)?"?1":"?0":a),o&&(l["sec-ch-platform"]=o),n&&(l["sec-ch-ua-platform-version"]=n),i&&(l["accept-language"]=i),s){let e=s.value;s.versions?.forEach((t=>{const{name:r,maxMajorVersion:o,minMajorVersion:n,maxMinorVersion:a,minMinorVersion:i,maxPatchVersion:s,minPatchVersion:l}=t,c=e.split(`${r}/`)[1].split(" ")[0].split("."),m=c.join(".");x(o)||(c[0]=o===n?o:u(o,n)),x(a)||(c[1]=a===i?a:u(a,i)),x(s)||(c[2]=s===l?s:u(s,l));const g=`${r}/${m}`,p=`${r}/${c.join(".")}`;e=e.replace(g,p)})),l["user-agent"]=e}}function N(e,t){const{maxWidth:r,minWidth:o,maxHeight:n,minHidth:a}=t,i=e.viewport??{};r&&(i.width=r===o?r:u(r,o)),n&&(i.height=n===a?n:u(n,a)),Object.hasOwn(i,"width")&&Object.hasOwn(i,"height")&&(e.viewport=i)}function k(e,t,r){r.detailTargets=t.detailTargets.map((o=>{const n=o,{url:a,timeout:i,proxy:s,maxRetry:l,priority:c,headers:m,fingerprint:g}=n;if(e.baseUrl&&(n.url=e.baseUrl+a),x(i)&&(x(t.timeout)?n.timeout=e.timeout:n.timeout=t.timeout??void 0),x(l)&&(x(t.maxRetry)?n.maxRetry=e.maxRetry:n.maxRetry=t.maxRetry??0),x(s)&&(x(t.proxy)?x(e.proxy)||(n.proxy=e.proxy):n.proxy=t.proxy),x(n.proxy?.urls))n.proxyDetails=[];else{const e=n.proxy.urls;n.proxyUrl=e[0],n.proxyDetails=e.map((e=>({url:e,state:!0})))}if(x(c)&&(n.priority=0),x(m)&&t.headers&&(n.headers={...t.headers}),g)V(n,g);else if(x(g)&&$(t.fingerprints)&&t.fingerprints.length){const e=t.fingerprints,o=u(e.length),a=e[o];r.selectFingerprintIndexs.push(o),V(n,a)}else if(x(g)&&!$(t.fingerprints)&&e.enableRandomFingerprint){V(n,R[u(R.length)])}return n})),r.intervalTime=t.intervalTime,x(t.intervalTime)&&!x(e.intervalTime)&&(r.intervalTime=e.intervalTime),r.onCrawlItemComplete=t.onCrawlItemComplete}async function A(e,t){const{detailTargetConfig:r,detailTargetResult:o,retryCount:n,maxRetry:a,crawlErrorQueue:i}=e,{browser:s}=t,l=n===a,c=o?.page??await s.newPage();r.viewport&&await c.setViewport(r.viewport);let u=null,m=!0;try{if(r.proxyUrl?await s.createIncognitoBrowserContext({proxyServer:r.proxyUrl}):await s.createIncognitoBrowserContext({proxyServer:void 0}),r.cookies){const e=function(e,t){const r=[];return"string"==typeof t?t.split("; ").forEach((t=>{const o=t.split("=");r.push({name:o[0],value:o[1],url:e})})):Array.isArray(t)?t.forEach((t=>{t.url||(t.url=e),r.push(t)})):"object"==typeof t&&t&&(t.url||(t.url=e),r.push(t)),r}(r.url,r.cookies);await c.setCookie(...e)}else{const e=await c.cookies(r.url);await c.deleteCookie(...e)}r.headers&&await c.setExtraHTTPHeaders(r.headers),u=await c.goto(r.url,{timeout:r.timeout})}catch(e){m=!1,i.push(e)}e.detailTargetResult={response:u,page:c};const g=!E(e),p=m&&g;e.isStatusNormal=g,e.isSuccess=p,(p||l)&&(e.isHandle=!0,function(e,t){const{detailTargetResult:r,result:o}=e,{browser:n,onCrawlItemComplete:a}=t;H(e),o.data={browser:n,...r},a&&a(e.result)}(e,t))}async function D(o,n){const{detailTargetConfig:s,crawlErrorQueue:l,maxRetry:c,retryCount:u}=o,m=c===u;let g=null,p=!0;try{g=await(d=s,new Promise(((e,t)=>{const{requestConfig:r,protocol:o,data:n}=F(d);function s(t){const{statusCode:r,headers:o}=t,n=[];t.on("data",(e=>n.push(e))),t.on("end",(()=>{const t=Buffer.concat(n);e({statusCode:r,headers:o,data:t})}))}const l="http:"===o?a.request(r,s):i.request(r,s);l.on("timeout",(()=>{t(new Error(`Timeout ${r.timeout}ms`))})),l.on("error",(e=>{t(e)})),x(n)||l.write(n),l.end()})))}catch(e){p=!1,l.push(e)}var d;o.detailTargetResult=g;const f=!E(o),h=p&&f;o.isStatusNormal=f,o.isSuccess=h,(h||m)&&(o.isHandle=!0,"html"===n.type?function(e,t){const{isSuccess:r,detailTargetResult:o,result:n}=e,{onCrawlItemComplete:a}=t;if(H(e),r&&o){const{data:e,headers:t,statusCode:r}=o,a=e.toString();n.data={statusCode:r,headers:t,html:a}}a&&a(n)}(o,n):"data"===n.type?function(e,t){const{isSuccess:r,detailTargetResult:o,result:n}=e,{onCrawlItemComplete:a}=t;if(H(e),r&&o){const e=o.headers["content-type"]??"",t=e.includes("application/json")?JSON.parse(o.data.toString()):e.includes("text")?o.data.toString():o.data;n.data={...o,data:t}}a&&a(n)}(o,n):"file"===n.type&&function(o,n){const{id:a,isSuccess:i,detailTargetConfig:s,detailTargetResult:l,result:c}=o,{saveFileErrorArr:u,saveFilePendingQueue:m,onCrawlItemComplete:g,onBeforeSaveItemFile:p}=n;if(H(o),i&&l){const n=l.headers["content-type"]??"",i=s.fileName??`${a}-${(new Date).getTime()}`,d=s.extension??`.${n.split("/").pop()}`;s.storeDir&&!e.existsSync(s.storeDir)&&e.mkdirSync(s.storeDir,{recursive:!0});const f=s.storeDir??__dirname,h=r.resolve(f,i+d),y=l.data;let w=Promise.resolve(y);p&&(w=p({id:a,fileName:i,filePath:h,data:y}));const x=w.then((async e=>{let r=!0;try{await t.writeFile(h,e)}catch(e){r=!1;const t=`File save error at id ${a}: ${e.message}`,o=()=>a;u.push({message:t,valueOf:o})}const s=e.length;c.data={...l,data:{isSuccess:r,fileName:i,fileExtension:d,mimeType:n,size:s,filePath:h}},g&&g(o.result)}));m.push(x)}else g&&g(o.result)}(o,n))}const q=["isSuccess","retryCount"];function H(e){Object.keys(e).forEach((t=>{q.includes(t)&&(e.result[t]=e[t])}))}function W(e){const{id:t,mode:r,logConfig:n,crawlPage:a}=e;let i=0,s=null,l=null,c=!1;const u="page";return async function(m,g){c||(c=!0,l=o.launch(a?.puppeteerLaunch).then((e=>{s=e}))),l&&(await l,l&&(l=null));const{detailTargets:p,intervalTime:d,onCrawlItemComplete:f}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let o={targets:[],detailTargets:[]};if(T(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,o.detailTargets=P(e)}else o.detailTargets=P(t);return k(e,o,r),r.detailTargets.forEach(((e,t)=>{const{cookies:n,viewport:a,fingerprint:i}=e;if(x(n)&&o.cookies&&(e.cookies=o.cookies),x(a)&&o.viewport&&(e.viewport=o.viewport),i)N(e,i);else if(x(i)&&o.fingerprints?.length){const n=r.selectFingerprintIndexs[t];N(e,o.fingerprints[n])}})),r}(e,m),h={serialNumber:`${t}-${u}-${++i}`,mode:r,type:u,logConfig:n,intervalTime:d,browser:s,onCrawlItemComplete:f},y=await O(p,h,A),w=$(m)||T(m)&&Object.hasOwn(m,"targets")?y:y[0];return g&&g(w),w}}function B(e){const{id:t,mode:r,logConfig:o}=e;let n=0;const a="html";return async function(i,s){const{detailTargets:l,intervalTime:c,onCrawlItemComplete:u}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let o={targets:[],detailTargets:[]};if(T(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o={...o,...t},o.detailTargets=P(e)}else o.detailTargets=P(t);return k(e,o,r),r}(e,i),m={serialNumber:`${t}-${a}-${++n}`,mode:r,type:a,logConfig:o,intervalTime:c,onCrawlItemComplete:u},g=await O(l,m,D),p=$(i)||T(i)&&Object.hasOwn(i,"targets")?g:g[0];return s&&s(p),p}}function U(e){const{id:t,mode:r,logConfig:o}=e;let n=0;const a="data";return async function(i,s){const{detailTargets:l,intervalTime:c,onCrawlItemComplete:u}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onCrawlItemComplete:void 0};let o={targets:[],detailTargets:[]};if(T(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,o.detailTargets=P(e)}else o.detailTargets=P(t);return k(e,o,r),r}(e,i),m={serialNumber:`${t}-${a}-${++n}`,mode:r,type:a,logConfig:o,intervalTime:c,onCrawlItemComplete:u},g=await O(l,m,D),p=$(i)||T(i)&&Object.hasOwn(i,"targets")?g:g[0];return s&&s(p),p}}function L(e){const{id:t,mode:r,logConfig:o}=e;let n=0;const a="file";return async function(i,s){const{detailTargets:l,intervalTime:c,onBeforeSaveItemFile:u,onCrawlItemComplete:g}=function(e,t){const r={detailTargets:[],intervalTime:void 0,selectFingerprintIndexs:[],onBeforeSaveItemFile:void 0,onCrawlItemComplete:void 0};let o={targets:[],detailTargets:[]};if(T(t)&&Object.hasOwn(t,"targets")){const{targets:e}=t;o=t,o.detailTargets=P(e)}else o.detailTargets=$(t)?t:[t];k(e,o,r);const n=!x(o?.storeDirs),a=v(o?.storeDirs)?0:1,i=!x(o?.extensions),s=(v(o?.extensions),!x(o?.fileNames));return r.detailTargets.forEach(((e,t)=>{x(e.storeDir)&&n&&(e.storeDir=0===a?o.storeDirs:o.storeDirs[t]),x(e.extension)&&i&&(e.extension=0===a?o.extensions:o.extensions[t]),x(e.fileName)&&s&&(e.fileName=o.fileNames[t])})),r.onBeforeSaveItemFile=o.onBeforeSaveItemFile,r}(e,i),h={serialNumber:`${t}-${a}-${++n}`,mode:r,type:a,logConfig:o,intervalTime:c,saveFileErrorArr:[],saveFilePendingQueue:[],onCrawlItemComplete:g,onBeforeSaveItemFile:u},y=await O(l,h,D),{saveFilePendingQueue:C,saveFileErrorArr:b}=h;if(await Promise.all(C),o.result){(S=b,function e(t,r){if(t>=r)return;const o=S[r];let n=t,a=r-1;for(;n<=a;){for(;S[n]<o;)n++;for(;S[a]>o;)a--;n<=a&&(I(S,n,a),n++,a--)}I(S,n,r),e(t,n-1),e(n+1,r)}(0,S.length-1),S).forEach((e=>m(`${h.serialNumber} | ${f(e.message)}`)));const e=[],t=[];y.forEach((r=>{r.data?.data.isSuccess?e.push(r.id):t.push(r.id)})),m(`${w(h.serialNumber)} | ${p("Save finish:")}\n             ${d(`Success - total: ${e.length}, targets id: [ ${e.join(", ")} ]`)}\n               ${f(`Error - total: ${t.length}, targets id: [ ${t.join(", ")} ]`)}\n        `)}var S;const j=$(i)||T(i)&&Object.hasOwn(i,"targets")?y:y[0];return s&&s(j),j}}function Q(e){const{id:t,logConfig:r}=e;let o=0;return(e,n)=>{const a=`${t}-polling-${++o}`,{d:i,h:s,m:l}=e,c=(x(i)?0:1e3*i*60*60*24)+(x(s)?0:1e3*s*60*60)+(x(l)?0:1e3*l*60);let u=0;p();const m=setInterval(p,c);function p(){r.start&&console.log(g(`${w(a)} | Start polling - count: ${++u}`)),n(u,d)}function d(){clearInterval(m),r.result&&console.log(`${w(a)} | ${h("Stop the polling")}`)}}}let K=0;const z=function(e){const t=function(e){const{mode:t,enableRandomFingerprint:r,baseUrl:o,intervalTime:n,log:a,crawlPage:i,timeout:s,proxy:l,maxRetry:c}=e??{},u={id:++K,mode:t??"async",enableRandomFingerprint:r??!0,timeout:s??1e4,maxRetry:c??0,logConfig:{start:!0,process:!0,result:!0},baseUrl:o,intervalTime:n,proxy:l,crawlPage:i};T(a)?u.logConfig={...u.logConfig,...a}:"boolean"!=typeof a||a||Object.keys(u.logConfig).forEach((e=>u.logConfig[e]=!1));return u}(e);return function(e){return{crawlPage:W(e),crawlHTML:B(e),crawlData:U(e),crawlFile:L(e),startPolling:Q(e)}}(t)}();z.crawlHTML(["http://localhost:8888/html","http://localhost:8888/html","http://localhost:8888/html"]),z.crawlHTML("http://localhost:8888/html"),z.crawlFile({targets:["https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area/4401.jpg","https://raw.githubusercontent.com/coder-hxl/airbnb-upload/master/area/4403.jpg"],proxy:{urls:["http://localhost:14892"]}});
